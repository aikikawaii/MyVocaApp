<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { -webkit-tap-highlight-color: transparent; }

  .fade-in { animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  /* â”€â”€ ì„±ëŠ¥: GPU í•©ì„± ë ˆì´ì–´ íŒíŠ¸ â”€â”€ */
  .game-btn { will-change: transform; }
  .neon-card, .neon-card-emerald, .neon-card-rose, .neon-card-amber {
    /* backdrop-filter ì œê±° ì™„ë£Œ â€” box-shadowë§Œ ì‚¬ìš© */
    transform: translateZ(0); /* GPU ë ˆì´ì–´ ìŠ¹ê²© */
  }

  /* â”€â”€ ì„±ëŠ¥: ìˆ¨ê²¨ì§„ íƒ­ ë·°ëŠ” ë Œë”ë§ ìŠ¤í‚µ â”€â”€ */
  [id^="view-"]:not(.hidden) { content-visibility: auto; }

  /* neon-card hover â€” transition ë‹¨ì¶• (ë°°ê²½ìƒ‰ë§Œ) */
  .neon-card { transition: border-color 0.2s, box-shadow 0.2s; }
  .neon-card:hover { transform: none; } /* translateZ(0) ìœ ì§€, scale ì œê±° */
  
  .active-bounce { transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), filter 0.15s ease, background-color 0.15s ease; }
  .active-bounce:active { transform: scale(0.94) !important; filter: brightness(1.2); }

  /* ===== ğŸ¯ ì‚¬ì§€ì„ ë‹¤ ë²„íŠ¼ ì‹œìŠ¤í…œ (ê¹”ë” ë¯¸ë‹ˆë©€) ===== */
  .game-btn {
    position: relative;
    overflow: hidden;
    transition: transform 0.12s ease, border-color 0.12s ease, background-color 0.12s ease, opacity 0.15s ease;
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
  }
  .game-btn:not(:disabled):hover {
    transform: translateY(-2px);
    border-color: rgba(99, 102, 241, 0.5) !important;
  }
  .game-btn:not(:disabled):active {
    transform: scale(0.97) !important;
  }

  /* ì •ë‹µ */
  .game-btn.correct-answer {
    background: #059669 !important;
    color: #fff !important;
    border-color: #10b981 !important;
    transform: scale(1.02) !important;
    transition: all 0.1s ease !important;
  }

  /* ì˜¤ë‹µ */
  .game-btn.wrong-answer {
    background: #be123c !important;
    color: #fff !important;
    border-color: #f43f5e !important;
    animation: wrongShake 0.3s ease !important;
    transition: background-color 0.1s ease, border-color 0.1s ease !important;
  }
  @keyframes wrongShake {
    0%,100% { transform: translateX(0); }
    25%      { transform: translateX(-6px); }
    75%      { transform: translateX(6px); }
  }

  /* ì •ë‹µ ë°íˆê¸° (ì˜¤ë‹µ ì„ íƒ ì‹œ) */
  .game-btn.reveal-correct {
    background: #059669 !important;
    color: #fff !important;
    border-color: #10b981 !important;
    transition: all 0.15s ease 0.1s !important;
  }

  /* ì„ íƒ ì•ˆëœ ë³´ê¸° */
  .game-btn.dimmed {
    opacity: 0.4;
    transition: opacity 0.15s ease !important;
  }

  /* ===== ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ===== */

  /* â”€â”€ ì‚¬ì§€ì„ ë‹¤ íƒ€ì´ë¨¸ ë°” â”€â”€ */
  #quiz-timer-bar-wrap {
    height: 6px;
    background: rgba(55, 65, 81, 0.6);
    border-radius: 999px;
    overflow: hidden;
    margin-bottom: 1.25rem;
    flex-shrink: 0;
  }
  #quiz-timer-bar {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, #6366f1, #a78bfa);
    transition: width 0.1s linear, background 0.4s ease;
    transform-origin: left;
  }
  #quiz-timer-bar.warning {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
  }
  #quiz-timer-bar.danger {
    background: linear-gradient(90deg, #ef4444, #f87171);
    animation: timerPulse 0.5s ease infinite;
  }
  @keyframes timerPulse {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.55; }
  }
  .chip { display: inline-flex; align-items: center; gap: 4px; padding: 5px 12px; border-radius: 9999px; font-size: 0.78rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid transparent; position: relative; }
  .chip:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  .chip:active { transform: scale(0.95); }
  
  .chip-syn { background: #3b0764; color: #ddd6fe; border-color: #5b21b6; }
  .chip-ant { background: #4c0519; color: #fecaca; border-color: #9f1239; }
  .chip-rel { background: #022c22; color: #a7f3d0; border-color: #065f46; }
  .chip-freq { background: #422006; color: #fef08a; border-color: #854d0e; }
  .chip-new { background: #082f49; color: #bae6fd; border-color: #0c4a6e; }

  .chip-tooltip { position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: #e0e7ff; color: #312e81; font-size: 0.72rem; font-weight: 700; white-space: nowrap; padding: 4px 10px; border-radius: 8px; pointer-events: none; opacity: 0; transition: opacity 0.15s; z-index: 50; letter-spacing: 0.01em; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
  .chip-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 5px solid transparent; border-top-color: #e0e7ff; }
  .chip:hover .chip-tooltip, .chip.force-tooltip .chip-tooltip { opacity: 1; }
  .chip-tooltip.loading { color: #818cf8; }
  
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .skeleton { animation: pulse 1.5s infinite; background: rgba(55, 65, 81, 0.5); border-radius: 8px; }
  .origin-left { transform-origin: left center; }
  .text-center-last { text-align-last: center; }

  .grass-0 { background-color: rgba(31, 41, 55, 0.6); border: 1px solid rgba(55, 65, 81, 0.4); } 
  .grass-1 { background-color: #064e3b; border: 1px solid #065f46; box-shadow: 0 0 5px rgba(6, 78, 59, 0.3); } 
  .grass-2 { background-color: #047857; border: 1px solid #059669; box-shadow: 0 0 8px rgba(4, 120, 87, 0.4); } 
  .grass-3 { background-color: #10b981; border: 1px solid #34d399; box-shadow: 0 0 12px rgba(16, 185, 129, 0.5); } 
  .grass-4 { background-color: #34d399; border: 1px solid #6ee7b7; box-shadow: 0 0 15px rgba(52, 211, 153, 0.6); }

  .neon-card { background-color: rgba(31, 41, 55, 0.95); border: 1px solid rgba(99, 102, 241, 0.15) !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: border-color 0.25s, background-color 0.25s, box-shadow 0.25s, transform 0.25s; }
  .neon-card:hover { border-color: rgba(99, 102, 241, 0.5) !important; background-color: rgba(31, 41, 55, 1); box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15); }
  .neon-card-emerald { background-color: rgba(31, 41, 55, 0.95); border: 1px solid rgba(16, 185, 129, 0.15) !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: border-color 0.25s, box-shadow 0.25s, transform 0.25s; }
  .neon-card-emerald:hover { border-color: rgba(16, 185, 129, 0.5) !important; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15); }
  .neon-card-rose { background-color: rgba(31, 41, 55, 0.95); border: 1px solid rgba(225, 29, 72, 0.15) !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: border-color 0.25s, box-shadow 0.25s, transform 0.25s; }
  .neon-card-rose:hover { border-color: rgba(225, 29, 72, 0.5) !important; box-shadow: 0 4px 20px rgba(225, 29, 72, 0.15); }
  .neon-card-amber { background-color: rgba(31, 41, 55, 0.95); border: 1px solid rgba(245, 158, 11, 0.15) !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: border-color 0.25s, box-shadow 0.25s, transform 0.25s; }
  .neon-card-amber:hover { border-color: rgba(245, 158, 11, 0.5) !important; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15); }


</style>
</head>
<body class="bg-gray-950 text-gray-200 font-sans h-screen w-screen flex items-center justify-center p-2 sm:p-6 overflow-hidden relative">
  <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900/10 via-gray-950 to-gray-950 pointer-events-none"></div>



<div class="w-full max-w-7xl h-full max-h-[96vh] min-h-[700px] bg-gray-900 shadow-2xl rounded-3xl flex flex-col overflow-hidden border border-gray-800 relative z-10">

<!-- í—¤ë” -->
<header class="bg-gray-900 text-gray-100 px-5 py-4 flex justify-between items-center z-10 flex-shrink-0 relative border-b border-gray-800 shadow-sm">
  <button onclick="openInfoModal()" class="active-bounce text-indigo-400 hover:text-indigo-300 flex-shrink-0 p-2 -ml-2" title="í”„ë¡œê·¸ë¨ ì„¤ëª…ì„œ ë³´ê¸°">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  </button>
  <h1 class="text-xl font-black tracking-widest absolute left-1/2 -translate-x-1/2 text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400">ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥ ğŸ“š</h1>
  <div class="w-6"></div>
</header>

<!-- íƒ­ -->
<div class="flex border-b border-gray-800 bg-gray-900 z-10 flex-shrink-0 overflow-x-auto no-scrollbar" style="font-size:14px">
  <button id="tab-manage"   class="active-bounce flex-1 min-w-[70px] py-3.5 font-black text-indigo-400 border-b-4 border-indigo-500 bg-gray-800/80 transition-colors whitespace-nowrap text-sm" onclick="switchTab('manage')">ë‹¨ì–´ ğŸ“</button>
  <button id="tab-srs"      class="active-bounce flex-1 min-w-[70px] py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800/60 hover:text-indigo-300 whitespace-nowrap text-sm relative" onclick="switchTab('srs')">SRS ğŸ”<span id="srs-due-badge" class="hidden absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-black rounded-full px-1.5 py-0.5 min-w-[18px] text-center"></span></button>
  <button id="tab-test"     class="active-bounce flex-1 min-w-[70px] py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800/60 hover:text-indigo-300 whitespace-nowrap text-sm" onclick="switchTab('test')">í”Œë˜ì‹œ ğŸ²</button>
  <button id="tab-quiz"     class="active-bounce flex-1 min-w-[70px] py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800/60 hover:text-indigo-300 whitespace-nowrap text-sm" onclick="switchTab('quiz')">ì‚¬ì§€ì„ ë‹¤ ğŸ¯</button>
  <button id="tab-analysis" class="active-bounce flex-1 min-w-[70px] py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800/60 hover:text-indigo-300 whitespace-nowrap text-sm" onclick="switchTab('analysis')">ë¶„ì„ ğŸ”¬</button>
  <button id="tab-group"    class="active-bounce flex-1 min-w-[70px] py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800/60 hover:text-indigo-300 whitespace-nowrap text-sm" onclick="switchTab('group')">ê·¸ë£¹í•‘ ğŸ§©</button>
  <button id="tab-stats"    class="active-bounce flex-1 min-w-[70px] py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800/60 hover:text-indigo-300 whitespace-nowrap text-sm" onclick="switchTab('stats')">í†µê³„ ğŸ“Š</button>
</div>

<!-- ===== 1. ê´€ë¦¬ ===== -->
<div id="view-manage" class="flex-1 flex flex-col p-4 sm:p-6 overflow-hidden fade-in bg-transparent">
  <div class="neon-card p-4 rounded-[1.5rem] mb-4 flex-shrink-0 z-10">
    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
      <input id="input-en" type="text" lang="en" style="ime-mode: inactive;" placeholder="ì˜ì–´ ë‹¨ì–´ (ì˜ˆ: Apple)" class="flex-1 border border-gray-700 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-800 text-white placeholder-gray-500 transition-all font-black text-lg">
      <input id="input-ko" type="text" lang="ko" style="ime-mode: active;" placeholder="í•œêµ­ì–´ ëœ» (ì˜ˆ: ì‚¬ê³¼)" class="flex-1 border border-gray-700 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-800 text-white placeholder-gray-500 transition-all text-lg font-bold" onkeypress="if(event.key==='Enter')addWord()">
      <button onclick="addWord()" class="active-bounce bg-indigo-600 text-white font-black py-3 px-8 rounded-xl hover:bg-indigo-500 shadow-md whitespace-nowrap border border-indigo-500">ë‹¨ì–´ ì¶”ê°€ â•</button>
    </div>
  </div>
  
  <div class="flex flex-col sm:flex-row justify-between items-center mb-3 gap-4 text-sm px-2 flex-shrink-0 z-10">
    <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start">
      <span class="font-bold text-gray-400 text-base whitespace-nowrap">ì´ <span id="word-count" class="text-indigo-400 font-black text-xl">0</span>ë‹¨ì–´</span>
      <div id="cloud-status" class="text-[11px] font-bold text-gray-400 bg-gray-800 border border-gray-700 shadow-sm px-3 py-1.5 rounded-full flex items-center gap-2 cursor-help transition-all" title="í´ë¼ìš°ë“œ ë™ê¸°í™” ìƒíƒœ">
        <span class="w-2 h-2 rounded-full bg-gray-600 transition-colors duration-300" id="cloud-dot"></span>
        <span id="cloud-status-text">ë¡œì»¬ ì—°ê²° ì¤‘...</span>
      </div>
      <select id="sort-select" onchange="currentPage=1;renderWords()" class="bg-gray-800 border border-gray-700 text-gray-300 py-1.5 px-3 rounded-lg focus:outline-none focus:border-indigo-500 font-bold cursor-pointer transition-colors">
        <option value="newest">ìµœì‹ ìˆœ</option>
        <option value="wrongCount">ì˜¤ë‹µìˆœ</option>
      </select>
    </div>
    <div class="relative w-full sm:max-w-sm flex-1">
      <input id="search-manage" type="text" placeholder="ë‹¨ì–´ ê²€ìƒ‰..." oninput="currentPage=1;renderWords()" class="w-full border border-gray-700 rounded-xl py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-800 text-gray-200 placeholder-gray-500 transition-all text-sm font-bold">
      <span class="absolute left-3.5 top-2 text-gray-500 text-base">ğŸ”</span>
    </div>
    <div class="flex gap-2 w-full sm:w-auto justify-end">
      <button onclick="exportData()" class="active-bounce text-indigo-300 bg-indigo-900/30 border border-indigo-500/30 px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-800/50 transition-all whitespace-nowrap">ë‚´ë³´ë‚´ê¸° ğŸ“¤</button>
      <button onclick="document.getElementById('file-upload').click()" class="active-bounce text-emerald-300 bg-emerald-900/30 border border-emerald-500/30 px-4 py-2 rounded-xl text-sm font-bold hover:bg-emerald-800/50 transition-all whitespace-nowrap">ë¶ˆëŸ¬ì˜¤ê¸° ğŸ“¥</button>
      <input type="file" id="file-upload" class="hidden" accept=".json" onchange="importData(event)">
      <button onclick="confirmClearAll()" class="active-bounce text-rose-300 bg-rose-900/30 border border-rose-500/30 px-4 py-2 rounded-xl text-sm font-bold hover:bg-rose-800/50 transition-all whitespace-nowrap">ì „ì²´ ì‚­ì œ ğŸ—‘ï¸</button>
    </div>
  </div>
  
  <ul id="word-list" class="flex-1 overflow-y-auto no-scrollbar grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 auto-rows-[minmax(72px,1fr)] gap-3 sm:gap-4 pb-1 px-1 mt-2 z-10"></ul>
  
  <div id="pagination-controls" class="flex justify-between items-center pt-5 flex-shrink-0 mt-1 mb-1 z-10 hidden">
    <button onclick="changePage(-1)" id="btn-prev" class="active-bounce flex items-center justify-center w-12 h-12 bg-gray-800 text-indigo-400 rounded-full border border-gray-700 hover:border-indigo-500 hover:text-indigo-300 disabled:opacity-30 transition-colors shadow-sm">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </button>
    <div class="relative group z-20">
      <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full blur-sm opacity-30 group-hover:opacity-60 transition duration-300"></div>
      <div class="relative flex items-center bg-gray-900 rounded-full">
          <select id="page-select" onchange="jumpToPage(this.value)" class="appearance-none text-sm sm:text-base text-indigo-100 font-black bg-transparent px-8 sm:px-12 py-2.5 rounded-full border border-gray-700 hover:border-indigo-500 focus:outline-none text-center-last cursor-pointer tracking-widest uppercase transition-colors">
            <option value="1">PAGE 1 / 1</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-4 flex items-center text-indigo-400">
             <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>
          </div>
      </div>
    </div>
    <button onclick="changePage(1)" id="btn-next" class="active-bounce flex items-center justify-center w-12 h-12 bg-gray-800 text-indigo-400 rounded-full border border-gray-700 hover:border-indigo-500 hover:text-indigo-300 disabled:opacity-30 transition-colors shadow-sm">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
    </button>
  </div>
</div>

<!-- ===== 2. í•™ìŠµ ===== -->
<!-- ===== SRS ê°„ê²©ë°˜ë³µ íƒ­ ===== -->
<div id="view-srs" class="flex-1 flex flex-col p-4 sm:p-6 hidden bg-transparent overflow-y-auto no-scrollbar relative z-10">

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <div id="srs-dashboard" class="flex flex-col gap-4 w-full max-w-2xl mx-auto fade-in">
    <div class="neon-card p-6 rounded-3xl">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400">ê°„ê²©ë°˜ë³µ í•™ìŠµ ğŸ”</h2>
          <p class="text-gray-400 text-sm font-bold mt-1">ë§ê° ê³¡ì„  ê¸°ë°˜ Â· Anki SM-2 ì•Œê³ ë¦¬ì¦˜</p>
        </div>
        <div class="text-4xl">ğŸ§ </div>
      </div>
      <!-- ì˜¤ëŠ˜ í•  ì¼ ìš”ì•½ -->
      <div class="grid grid-cols-3 gap-3 mb-5">
        <div class="bg-rose-900/30 border border-rose-700/50 rounded-2xl p-4 text-center">
          <p class="text-3xl font-black text-rose-300" id="srs-count-due">0</p>
          <p class="text-xs font-black text-rose-400 mt-1 uppercase tracking-wide">ì˜¤ëŠ˜ ë³µìŠµ</p>
        </div>
        <div class="bg-emerald-900/30 border border-emerald-700/50 rounded-2xl p-4 text-center">
          <p class="text-3xl font-black text-emerald-300" id="srs-count-new">0</p>
          <p class="text-xs font-black text-emerald-400 mt-1 uppercase tracking-wide">ì‹ ê·œ ì˜ˆì •</p>
        </div>
        <div class="bg-indigo-900/30 border border-indigo-700/50 rounded-2xl p-4 text-center">
          <p class="text-3xl font-black text-indigo-300" id="srs-count-total">0</p>
          <p class="text-xs font-black text-indigo-400 mt-1 uppercase tracking-wide">ì´ í•™ìŠµì¤‘</p>
        </div>
      </div>
      <!-- 2ì£¼ ëª©í‘œ ì§„í–‰ë°” -->
      <div class="mb-5">
        <div class="flex justify-between mb-1.5">
          <span class="text-xs font-black text-gray-400 uppercase tracking-wide">2ì£¼ ëª©í‘œ ì§„í–‰ë¥ </span>
          <span class="text-xs font-black text-indigo-300" id="srs-goal-pct">0%</span>
        </div>
        <div class="h-3 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
          <div id="srs-goal-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-700" style="width:0%"></div>
        </div>
        <p class="text-xs text-gray-500 font-bold mt-1.5" id="srs-goal-label">ëª©í‘œ: 2000ê°œ Â· ì˜¤ëŠ˜ ê¶Œì¥ ì‹ ê·œ: <span id="srs-daily-target" class="text-indigo-400">-</span>ê°œ</p>
      </div>
      <div class="flex gap-3">
        <button onclick="startSRS('due')" id="srs-btn-due" class="active-bounce flex-1 bg-rose-600 text-white font-black py-4 rounded-2xl hover:bg-rose-500 border border-rose-500 shadow-md disabled:opacity-40 disabled:cursor-not-allowed">ë³µìŠµí•˜ê¸° ğŸ”¥</button>
        <button onclick="startSRS('new')" id="srs-btn-new" class="active-bounce flex-1 bg-emerald-700 text-white font-black py-4 rounded-2xl hover:bg-emerald-600 border border-emerald-600 shadow-md">ì‹ ê·œ ì•”ê¸° âœ¨</button>
      </div>
    </div>
    <!-- ë‹¤ìŒ ì˜ˆì • ë¯¸ë¦¬ë³´ê¸° -->
    <div class="neon-card p-5 rounded-3xl">
      <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-3">ë‹¤ê°€ì˜¤ëŠ” ë³µìŠµ ìŠ¤ì¼€ì¤„</h3>
      <div id="srs-upcoming" class="space-y-2 text-sm font-bold text-gray-300"></div>
    </div>
  </div>

  <!-- í•™ìŠµ ì¹´ë“œ -->
  <div id="srs-session" class="hidden flex-1 flex flex-col max-w-2xl mx-auto w-full">
    <div class="flex justify-between items-center mb-4 flex-shrink-0">
      <button onclick="exitSRS()" class="text-gray-400 hover:text-white font-black text-sm px-3 py-2 rounded-xl hover:bg-gray-800 transition-colors">â† ë‚˜ê°€ê¸°</button>
      <div class="flex gap-2 items-center">
        <span class="text-xs font-black text-gray-500 uppercase tracking-wide" id="srs-session-type"></span>
        <div class="bg-gray-800 border border-gray-700 px-4 py-1.5 rounded-full text-sm font-black text-gray-300"><span id="srs-session-idx">1</span>/<span id="srs-session-total">10</span></div>
      </div>
    </div>
    <div class="flex-1 neon-card rounded-[2.5rem] flex flex-col items-center justify-center p-8 mb-4 text-center relative min-h-[280px]">
      <div class="absolute top-4 right-4 flex gap-1.5" id="srs-card-meta">
        <span id="srs-interval-badge" class="text-[10px] font-black bg-gray-700 text-gray-300 px-2 py-1 rounded-full border border-gray-600"></span>
      </div>
      <p class="text-xs font-black text-gray-500 uppercase tracking-widest mb-3" id="srs-prompt-label">ì´ ë‹¨ì–´ì˜ ëœ»ì€?</p>
      <h2 id="srs-card-en" class="text-5xl sm:text-6xl font-black text-white mb-3 break-all tracking-tight">word</h2>
      <p id="srs-card-phonetic" class="text-gray-500 text-sm font-bold mb-6"></p>
      <div id="srs-card-answer" class="hidden fade-in text-center w-full">
        <p id="srs-card-ko" class="text-3xl font-black text-indigo-300 mb-3">ëœ»</p>
        <p id="srs-card-hint" class="text-sm text-gray-400 font-bold px-4"></p>
      </div>
      <button id="srs-reveal-btn" onclick="srsReveal()" class="active-bounce bg-gray-800 text-indigo-200 font-black text-base px-10 py-3.5 rounded-full hover:bg-gray-700 hover:text-white border border-gray-600 shadow-md">ì •ë‹µ í™•ì¸ ğŸ‘€</button>
    </div>
    <!-- SM-2 ë“±ê¸‰ ë²„íŠ¼ -->
    <div id="srs-grade-btns" class="hidden grid grid-cols-4 gap-2 pb-4 flex-shrink-0">
      <button onclick="gradeCard(1)" class="active-bounce flex flex-col items-center neon-card-rose py-3 px-1 rounded-2xl hover:border-rose-500">
        <span class="text-xl">ğŸ˜µ</span><span class="text-[10px] font-black text-rose-400 mt-1">ì „í˜€ëª°ë¼</span><span class="text-[9px] text-gray-500 font-bold">+10ë¶„</span>
      </button>
      <button onclick="gradeCard(2)" class="active-bounce flex flex-col items-center neon-card py-3 px-1 rounded-2xl hover:border-amber-500">
        <span class="text-xl">ğŸ˜•</span><span class="text-[10px] font-black text-amber-400 mt-1">ì–´ë ´í’‹ì´</span><span class="text-[9px] text-gray-500 font-bold">+1ì¼</span>
      </button>
      <button onclick="gradeCard(3)" class="active-bounce flex flex-col items-center neon-card py-3 px-1 rounded-2xl hover:border-indigo-500">
        <span class="text-xl">ğŸ™‚</span><span class="text-[10px] font-black text-indigo-300 mt-1">ì•Œì•˜ì–´ìš”</span><span class="text-[9px] text-gray-500 font-bold" id="srs-grade3-days"></span>
      </button>
      <button onclick="gradeCard(4)" class="active-bounce flex flex-col items-center neon-card-emerald py-3 px-1 rounded-2xl hover:border-emerald-500">
        <span class="text-xl">ğŸ˜„</span><span class="text-[10px] font-black text-emerald-400 mt-1">ì™„ë²½í•´ìš”</span><span class="text-[9px] text-gray-500 font-bold" id="srs-grade4-days"></span>
      </button>
    </div>
  </div>

  <!-- ì„¸ì…˜ ì™„ë£Œ -->
  <div id="srs-complete" class="hidden flex-1 flex flex-col items-center justify-center fade-in">
    <div class="neon-card p-10 rounded-[2.5rem] text-center w-full max-w-lg">
      <div class="text-6xl mb-4" id="srs-done-emoji">ğŸ‰</div>
      <h2 class="text-3xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400" id="srs-done-title">ì„¸ì…˜ ì™„ë£Œ!</h2>
      <p class="text-gray-400 font-bold mb-6" id="srs-done-subtitle"></p>
      <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700"><p class="text-2xl font-black text-emerald-300" id="srs-done-correct">0</p><p class="text-xs font-black text-gray-400 mt-1 uppercase tracking-wide">ì •ë‹µ</p></div>
        <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700"><p class="text-2xl font-black text-rose-300" id="srs-done-wrong">0</p><p class="text-xs font-black text-gray-400 mt-1 uppercase tracking-wide">ë³µìŠµ í•„ìš”</p></div>
      </div>
      <div class="flex gap-3">
        <button onclick="exitSRS()" class="active-bounce flex-1 bg-gray-800 text-indigo-300 font-black py-4 rounded-2xl hover:bg-gray-700 border border-gray-700">ëŒ€ì‹œë³´ë“œ</button>
        <button onclick="startSRS('due')" class="active-bounce flex-1 bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-indigo-500 border border-indigo-500">ë‹¤ì‹œí•˜ê¸°</button>
      </div>
    </div>
  </div>
</div>


<div id="view-test" class="flex-1 flex flex-col p-6 hidden bg-transparent overflow-y-auto no-scrollbar relative z-10">
  <div id="test-intro" class="flex-1 flex flex-col items-center justify-center fade-in">
    <div class="neon-card p-8 sm:p-10 rounded-[2.5rem] w-full max-w-2xl text-center">
      <div class="text-6xl mb-6">ğŸ§ </div>
      <h2 class="text-3xl font-black mb-3 text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400">í”Œë˜ì‹œì¹´ë“œ í•™ìŠµ</h2>
      <p class="text-gray-400 mb-8 text-base font-bold">ë‹¨ì–´ë¥¼ ë³´ê³  ëœ»ì„ ë§í˜€ë³´ì„¸ìš”.</p>
      <div id="test-intro-main">
          <div class="flex flex-col sm:flex-row gap-4 justify-center mb-4">
            <button onclick="startTest('all')"   class="active-bounce flex-1 bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-indigo-500 text-lg border border-indigo-500 shadow-md">ì „ì²´ ë¬´ì‘ìœ„ ë³µìŠµ ğŸš€</button>
            <button onclick="startTest('wrong')" class="active-bounce flex-1 bg-gray-800 text-rose-400 font-black py-4 rounded-2xl hover:bg-gray-700 border border-gray-600 hover:border-rose-500/50 text-lg shadow-sm">í‹€ë¦° ë‹¨ì–´ ë³µìŠµ ğŸ¯</button>
          </div>
          <button onclick="showSetSelection()" class="active-bounce w-full bg-gray-800/80 text-indigo-300 font-black py-4 rounded-2xl hover:bg-gray-700 border border-gray-700 hover:border-indigo-500/50 text-lg shadow-sm">50ê°œì”© ì„¸íŠ¸ ìˆœì„œëŒ€ë¡œ ì•”ê¸° ğŸ“¦</button>
      </div>
      <div id="test-intro-sets" class="hidden">
          <h3 class="text-lg font-black text-indigo-300 mb-4 tracking-widest">í•™ìŠµí•  ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
          <div id="set-list-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-48 overflow-y-auto no-scrollbar mb-5 p-2 border-y border-gray-700 py-4"></div>
          <button onclick="hideSetSelection()" class="active-bounce text-gray-400 hover:text-indigo-300 font-black px-4 py-2 rounded-lg transition-colors">â† ë’¤ë¡œ ê°€ê¸°</button>
      </div>
    </div>
  </div>
  
  <div id="test-active" class="flex-1 flex flex-col hidden fade-in max-w-4xl mx-auto w-full h-full">
    <div class="flex justify-between mb-6 flex-shrink-0">
      <div class="bg-gray-800 border border-gray-700 px-5 py-2.5 rounded-full text-base font-black text-gray-300 shadow-sm">ì§„í–‰ <span id="test-progress" class="text-indigo-400">1/10</span></div>
      <div class="bg-gray-800 border border-gray-700 px-5 py-2.5 rounded-full text-base font-black text-gray-300 shadow-sm">âœ… <span id="test-score" class="text-emerald-400">0</span></div>
    </div>
    <div class="flex-1 neon-card rounded-[2.5rem] flex flex-col items-center justify-center p-10 mb-6 text-center relative min-h-[300px]">
      <h2 id="test-word-en" class="text-5xl sm:text-7xl font-black text-white mb-10 break-all px-4 tracking-tight">Apple</h2>
      <div class="h-28 flex items-center justify-center w-full">
        <button id="btn-reveal" onclick="revealAnswer()" class="active-bounce bg-gray-800 text-indigo-200 font-black text-lg px-12 py-4 rounded-full hover:bg-gray-700 hover:text-white border border-gray-600 shadow-md">ì •ë‹µ í™•ì¸ ğŸ‘€</button>
        <p id="test-word-ko" class="text-4xl sm:text-5xl font-black text-indigo-400 hidden fade-in break-words px-4">ì‚¬ê³¼</p>
      </div>
    </div>
    <div id="test-actions" class="flex gap-6 hidden pb-4 flex-shrink-0 h-28">
      <button onclick="markAnswer(false)" class="active-bounce flex-1 bg-gray-800 border border-rose-500/30 hover:border-rose-500 text-rose-400 rounded-[2rem] font-black text-xl flex items-center justify-center gap-3 shadow-md"><span class="text-3xl">âŒ</span>ëª°ëì–´ìš”</button>
      <button onclick="markAnswer(true)"  class="active-bounce flex-1 bg-gray-800 border border-emerald-500/30 hover:border-emerald-500 text-emerald-400 rounded-[2rem] font-black text-xl flex items-center justify-center gap-3 shadow-md"><span class="text-3xl">â­•</span>ì•Œì•˜ì–´ìš”</button>
    </div>
  </div>
  
  <div id="test-result" class="flex-1 flex flex-col items-center justify-center hidden fade-in">
    <div class="neon-card p-10 rounded-[2.5rem] text-center w-full max-w-xl">
      <div class="text-7xl mb-6">ğŸ‰</div>
      <h2 class="text-4xl font-black mb-8 text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400">í•™ìŠµ ì™„ë£Œ!</h2>
      <button onclick="resetTestView()" class="active-bounce w-full bg-indigo-600 text-white font-black py-5 text-lg rounded-2xl hover:bg-indigo-500 border border-indigo-500 shadow-md">ëŒì•„ê°€ê¸°</button>
    </div>
  </div>
</div>

<!-- ===== 3. ì‚¬ì§€ì„ ë‹¤ (ì™„ì „ ê°œí¸) ===== -->
<div id="view-quiz" class="flex-1 flex flex-col p-6 hidden bg-transparent overflow-y-auto no-scrollbar relative z-10">
  <div id="quiz-intro" class="flex-1 flex flex-col items-center justify-center fade-in">
    <div class="neon-card p-10 rounded-[2.5rem] text-center w-full max-w-2xl">
      <div class="text-6xl mb-6">ğŸ¯</div>
      <h2 class="text-3xl font-black mb-3 text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400">ë¬´í•œ ì‚¬ì§€ì„ ë‹¤</h2>
      <p class="text-gray-400 mb-10 text-base font-bold">ì˜ë¯¸ ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ í—·ê°ˆë¦¬ëŠ” ì„ ì§€ê°€ êµ¬ì„±ë¼ìš”!</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="startQuiz('random')" class="active-bounce flex-1 bg-indigo-600 text-white font-black py-4 sm:py-5 text-lg rounded-2xl hover:bg-indigo-500 border border-indigo-500 shadow-md">ì™„ì „ ë¬´ì‘ìœ„ ğŸš€</button>
        <button onclick="startQuiz('wrong')" class="active-bounce flex-1 bg-gray-800 text-rose-400 font-black py-4 sm:py-5 text-lg rounded-2xl hover:bg-gray-700 border border-gray-600 hover:border-rose-500/50 shadow-sm">ì˜¤ë‹µ ì§‘ì¤‘ ë³µìŠµ ğŸ¯</button>
      </div>
    </div>
  </div>
  
  <div id="quiz-active" class="flex-1 flex flex-col hidden max-w-4xl mx-auto w-full h-full">
    <!-- ìƒë‹¨ ìŠ¤íƒ¯ ë°” -->
    <div class="flex justify-between items-center mb-3 flex-shrink-0">
      <div class="bg-gray-800 px-5 py-2.5 rounded-full text-base font-black text-gray-300 border border-gray-700 shadow-sm">
        <span id="quiz-progress" class="text-indigo-400">1ë²ˆì§¸</span>
      </div>
      <div class="flex gap-3 items-center">
        <!-- ì½¤ë³´ í‘œì‹œ -->
        <div id="quiz-combo-wrap" class="hidden bg-gray-800 px-4 py-2 rounded-full border border-amber-500/50 shadow-sm">
          <span class="text-amber-300 font-black text-sm" id="quiz-combo">ğŸ”¥ 0 ì½¤ë³´</span>
        </div>
        <div class="bg-gray-800 px-5 py-2.5 rounded-full text-base font-black text-gray-300 border border-gray-700 shadow-sm">âœ… <span id="quiz-score" class="text-emerald-400">0</span></div>
        <button onclick="showQuizResult()" class="active-bounce bg-gray-800 text-rose-400 px-5 py-2.5 rounded-full border border-gray-700 hover:border-rose-500/50 text-sm font-black transition-colors shadow-sm">ì¢…ë£Œ</button>
      </div>
    </div>

    <!-- íƒ€ì´ë¨¸ ë°” -->
    <div id="quiz-timer-bar-wrap">
      <div id="quiz-timer-bar" style="width: 100%"></div>
    </div>
    
    <!-- ë‹¨ì–´ ì¹´ë“œ -->
    <div id="quiz-word-card" class="neon-card rounded-[2.5rem] flex flex-col items-center justify-center py-10 px-6 mb-6 flex-1 max-h-[38vh]">
      <span class="text-sm font-black text-indigo-400 mb-3 tracking-widest uppercase">ì–´ë–¤ ëœ»ì¼ê¹Œìš”?</span>
      <h2 id="quiz-word-en" class="text-5xl sm:text-6xl font-black text-white text-center break-all tracking-tight">Word</h2>
    </div>
    
    <!-- ë³´ê¸° ë²„íŠ¼ë“¤ -->
    <div id="quiz-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 flex-shrink-0 pb-4"></div>
  </div>
  
  <!-- ê²°ê³¼ í™”ë©´ -->
  <div id="quiz-result" class="flex-1 flex flex-col items-center justify-center hidden">
    <div class="neon-card p-10 rounded-[2.5rem] text-center w-full max-w-xl fade-in">
      <div class="text-7xl mb-4" id="quiz-result-emoji">ğŸ…</div>
      <h2 class="text-4xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400">í€´ì¦ˆ ì¢…ë£Œ!</h2>
      <div class="bg-gray-900/80 rounded-3xl p-8 my-6 border border-gray-700 shadow-inner">
        <div class="text-6xl font-black text-indigo-400">
          <span id="quiz-final-score">0</span>
          <span class="text-3xl text-gray-600"> / <span id="quiz-total-score">0</span></span>
        </div>
        <p class="font-bold text-gray-400 mt-2 text-base" id="quiz-accuracy"></p>
        <p class="font-black text-lg mt-3" id="quiz-feedback"></p>
        <!-- ìµœê³  ì½¤ë³´ í‘œì‹œ -->
        <p class="font-bold text-amber-400 mt-2 text-sm" id="quiz-best-combo"></p>
      </div>
      <button onclick="resetQuizView()" class="active-bounce w-full bg-indigo-600 text-white font-black py-5 text-lg rounded-2xl hover:bg-indigo-500 border border-indigo-500 shadow-md">ë‹¤ì‹œ í•˜ê¸° ğŸ”„</button>
    </div>
  </div>
</div>

<!-- ===== 4. ë¶„ì„ ===== -->
<div id="view-analysis" class="flex-1 flex flex-col hidden bg-transparent overflow-hidden relative z-10">
  <div class="p-4 sm:p-6 bg-gray-900 border-b border-gray-800 flex-shrink-0 shadow-sm z-20">
    <div class="max-w-4xl mx-auto w-full">
      <p class="text-xs sm:text-sm font-black text-gray-400 mb-3 uppercase tracking-widest">ë‹¨ì–´ ì‹¬ì¸µ ë¶„ì„</p>
      <div class="relative group">
        <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl blur opacity-20 group-focus-within:opacity-50 transition duration-300"></div>
        <input id="analysis-search" type="text" placeholder="ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”..." class="relative w-full border border-gray-700 rounded-2xl p-4 pr-12 text-base focus:outline-none focus:border-indigo-500 bg-gray-800 text-white transition-all shadow-inner placeholder-gray-500 font-black tracking-wide" oninput="filterAnalysisWords()" onclick="showAnalysisDropdown()">
        <span class="absolute right-5 top-4 text-xl text-gray-400 z-10">ğŸ”</span>
      </div>
      <div id="analysis-dropdown" class="hidden mt-3 neon-card rounded-2xl max-h-60 overflow-y-auto no-scrollbar absolute w-[calc(100%-2rem)] sm:w-[calc(100%-3rem)] max-w-4xl left-1/2 -translate-x-1/2 z-50"></div>
      <div id="analysis-selected-word" class="hidden mt-5 flex items-center gap-4 neon-card rounded-2xl px-5 py-4">
        <div class="flex-1 flex items-baseline gap-3 min-w-0">
          <span id="analysis-word-en-display" class="text-2xl sm:text-3xl font-black text-indigo-300 break-all tracking-tight"></span>
          <span id="analysis-word-ko-display" class="text-base sm:text-lg font-black text-indigo-400 truncate"></span>
        </div>
        <button onclick="clearAnalysisWord()" class="active-bounce text-gray-500 hover:text-rose-400 text-2xl px-2 flex-shrink-0 font-black">âœ•</button>
      </div>
    </div>
  </div>
  <div id="analysis-placeholder" class="flex-1 flex flex-col p-6 sm:p-8 overflow-y-auto no-scrollbar">
    <div class="max-w-xl mx-auto my-auto w-full text-center py-4">
      <div class="text-6xl sm:text-8xl mb-6 opacity-50">ğŸ”¬</div>
      <p class="font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400 text-2xl sm:text-3xl mb-4 break-keep tracking-tight">ë‹¨ì–´ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸í•˜ê²Œ ë¶„ì„í•´ë“œë ¤ìš”!</p>
      <p class="text-base text-gray-400 font-bold leading-relaxed break-keep">ìœ ì˜ì–´ Â· ë°˜ì˜ì–´ Â· ì—°ê´€ì–´ Â· ë°œìŒê¸°í˜¸ Â· ì˜ì˜ì •ì˜<br class="hidden sm:block">ì›ì–´ë¯¼ ì˜ˆë¬¸ 3ê°œ Â· ë‚´ ë‹¨ì–´ì¥ ë‚´ ìœ ì‚¬ë„ ë§¤ì¹­ê¹Œì§€ í•œëˆˆì— íŒŒì•…í•˜ì„¸ìš”.</p>
    </div>
  </div>
  <div class="flex-1 overflow-y-auto no-scrollbar relative p-4 sm:p-6">
    <div class="max-w-4xl mx-auto w-full">
      <div id="analysis-loading" class="space-y-6 hidden">
        <div class="neon-card rounded-[2rem] p-8 space-y-5">
          <div class="skeleton h-12 w-64 mb-8"></div>
          <div class="skeleton h-6 w-48"></div><div class="skeleton h-6 w-full"></div>
        </div>
      </div>
      <div id="analysis-result" class="space-y-6 hidden pb-8 fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 neon-card rounded-[2.5rem] p-8">
            <div class="flex items-start justify-between mb-5">
              <div class="min-w-0 pr-4">
                <h3 id="ar-word" class="text-4xl sm:text-5xl font-black text-white tracking-tight break-all"></h3>
                <p id="ar-phonetic" class="text-lg text-indigo-400 font-mono mt-2 font-bold"></p>
              </div>
              <button id="ar-audio-btn" class="hidden active-bounce bg-gray-800 border border-gray-700 px-5 py-2.5 rounded-full text-sm font-black text-indigo-300 flex-shrink-0 flex items-center gap-2 shadow-sm">ğŸ”Š <span class="hidden sm:inline">ë°œìŒ ë“£ê¸°</span></button>
            </div>
            <span id="ar-partOfSpeech" class="inline-block text-xs sm:text-sm font-black text-white bg-indigo-600 px-4 py-1.5 rounded-full mb-5 tracking-wider"></span>
            <p id="ar-definition" class="text-base text-gray-300 leading-relaxed mb-8 font-bold break-words"></p>
            <div class="border-t border-gray-700 pt-8">
              <p class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-5">ğŸ“ ì‹¤ìƒí™œ ì˜ˆë¬¸</p>
              <div id="ar-examples" class="space-y-4"></div>
            </div>
          </div>
          <div class="neon-card rounded-[2.5rem] p-8 flex flex-col">
            <p class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-6">ğŸ“š ë‚´ ë‹¨ì–´ì¥ ìœ ì‚¬ë„ ë§¤ì¹­</p>
            <div id="ar-internal-list" class="space-y-4 flex-1 overflow-y-auto no-scrollbar pr-1"></div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="neon-card rounded-[2rem] p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸ”µ</span><p class="text-xs font-black text-purple-400 uppercase tracking-widest">ìœ ì˜ì–´ (Synonyms)</p></div>
            <div id="ar-synonyms" class="flex flex-wrap gap-2.5"></div>
          </div>
          <div class="neon-card-rose rounded-[2rem] p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸ”´</span><p class="text-xs font-black text-rose-400 uppercase tracking-widest">ë°˜ì˜ì–´ (Antonyms)</p></div>
            <div id="ar-antonyms" class="flex flex-wrap gap-2.5"></div>
          </div>
          <div class="neon-card-emerald rounded-[2rem] p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸŸ¢</span><p class="text-xs font-black text-emerald-400 uppercase tracking-widest">ì—°ê´€ì–´ (Related)</p></div>
            <div id="ar-related" class="flex flex-wrap gap-2.5"></div>
          </div>
          <div class="neon-card-amber rounded-[2rem] p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸŸ¡</span><p class="text-xs font-black text-amber-400 uppercase tracking-widest">ë¹ˆì¶œ ë™ë°˜ì–´ (Collocations)</p></div>
            <div id="ar-collocations" class="flex flex-wrap gap-2.5"></div>
          </div>
        </div>
        <div class="bg-gray-800 rounded-[2.5rem] border border-indigo-500/20 p-8 shadow-sm relative overflow-hidden">
          <p class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-2 relative z-10">âœ¨ ë‹¨ì–´ì¥ ì¶”ê°€ ì¶”ì²œ</p>
          <p class="text-sm text-gray-400 font-bold mb-6 relative z-10">í„°ì¹˜ ì‹œ ë‹¨ì–´ì¥ ì¶”ê°€ íƒ­ìœ¼ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
          <div id="ar-recommendations" class="flex flex-wrap gap-3 relative z-10"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== 5. ê·¸ë£¹í•‘ ===== -->
<div id="view-group" class="flex-1 flex flex-col p-4 sm:p-6 hidden bg-transparent overflow-y-auto no-scrollbar relative z-10">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 px-2 flex-shrink-0">
      <div>
          <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400 tracking-tight flex items-center gap-2">AI ë‹¤ì¤‘ ë¶„ì„ ê·¸ë£¹í•‘ ğŸ§©</h2>
          <p class="text-gray-400 font-bold text-sm mt-1">ìì—°ì–´ ì²˜ë¦¬(NLP) ê¸°ë²•ì„ í™œìš©í•˜ì—¬ ë‹¨ì–´ë“¤ì„ 4ê°€ì§€ ê´€ì ìœ¼ë¡œ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬ ë¬¶ì–´ëƒ…ë‹ˆë‹¤.</p>
      </div>
      <button onclick="runNLPGrouping()" class="active-bounce w-full sm:w-auto bg-indigo-600 text-white font-black py-3 px-6 rounded-xl hover:bg-indigo-500 border border-indigo-500 shadow-md flex-shrink-0 flex justify-center items-center gap-2">
          <span>NLP ì—”ì§„ ê°€ë™</span> ğŸš€
      </button>
  </div>
  <div id="group-loading" class="hidden flex-col items-center justify-center py-20 flex-1">
      <div class="relative w-24 h-24 mx-auto mb-8">
          <div class="absolute inset-0 border-4 border-gray-700 rounded-full"></div>
          <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
      </div>
      <p class="text-xl font-black text-white text-center mb-3">ë‹¨ì–´ë“¤ì˜ ì˜ì˜ì‚¬ì „ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„ ì¤‘...</p>
      <div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden mb-3 border border-gray-700">
          <div id="nlp-progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
      </div>
      <p id="nlp-progress-text" class="text-sm font-black text-indigo-400">0 / 0</p>
  </div>
  <div id="group-container" class="hidden flex-col gap-10 pb-8 flex-1">
      <section>
          <h3 class="text-xl font-black text-emerald-400 mb-4 px-2 border-l-4 border-emerald-500 ml-1 pl-3">1ï¸âƒ£ ì–´ê·¼ ë° íŒŒìƒì–´ íŒ¨ë°€ë¦¬ (Lemmatization)</h3>
          <p class="text-sm text-gray-400 font-bold mb-5 px-2">ìì²´ JS í˜•íƒœì†Œ ë¶„ì„ê¸°ë¡œ ë‹¨ì–´ì˜ ì ‘ë¯¸ì‚¬ë¥¼ ë¶„ë¦¬í•´ ê°™ì€ ë¿Œë¦¬(Root)ë¥¼ ê°€ì§„ ë‹¨ì–´ë¥¼ ë¬¶ìŠµë‹ˆë‹¤.</p>
          <div id="nlp-stem-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </section>
      <section>
          <h3 class="text-xl font-black text-amber-400 mb-4 px-2 border-l-4 border-amber-500 ml-1 pl-3">2ï¸âƒ£ ì–´ì› ë° ì ‘ë‘ì‚¬ ë§¤ì¹­ (Prefix Rules)</h3>
          <p class="text-sm text-gray-400 font-bold mb-5 px-2">trans-, inter-, sub- ë“± í•µì‹¬ ì ‘ë‘ì‚¬ DBë¥¼ ê¸°ë°˜ìœ¼ë¡œ íŒ¨í„´ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
          <div id="nlp-prefix-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </section>
      <section>
          <h3 class="text-xl font-black text-rose-400 mb-4 px-2 border-l-4 border-rose-500 ml-1 pl-3">3ï¸âƒ£ ìœ ì˜ì–´ / ë°˜ì˜ì–´ ì—°ê²°ë§ (Semantic Graph)</h3>
          <p class="text-sm text-gray-400 font-bold mb-5 px-2">APIê°€ ì œê³µí•˜ëŠ” ëª…í™•í•œ ìœ ì˜ì–´/ë°˜ì˜ì–´ ê´€ê³„ë§ì— ë‚´ ë‹¨ì–´ì¥ì´ ì†í•´ìˆëŠ”ì§€ êµì°¨ ê²€ì¦í•©ë‹ˆë‹¤.</p>
          <div id="nlp-synant-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </section>
  </div>
</div>

<!-- ===== 6. í†µê³„ ===== -->
<div id="view-stats" class="flex-1 flex flex-col p-4 sm:p-6 hidden bg-transparent overflow-y-auto no-scrollbar relative z-10">
  <div class="mb-8 px-2 flex-shrink-0">
      <h2 class="text-2xl sm:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-400 tracking-tight flex items-center gap-2">í•™ìŠµ í†µê³„ ğŸ“Š</h2>
      <p class="text-gray-400 font-bold text-sm mt-1">ê¾¸ì¤€í•œ í•™ìŠµìœ¼ë¡œ ì”ë””ë¥¼ í‘¸ë¥´ê²Œ ì±„ì›Œë³´ì„¸ìš”!</p>
  </div>
  <div class="max-w-5xl mx-auto w-full space-y-6">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div class="neon-card p-6 rounded-[2rem] text-center flex flex-col justify-center relative overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1.5 bg-indigo-500"></div>
              <p class="text-indigo-400 font-black uppercase tracking-widest text-xs mb-3">ìƒˆë¡œ ì¶”ê°€í•œ ë‹¨ì–´</p>
              <div class="text-5xl font-black text-white" id="stat-added">0</div>
          </div>
          <div class="neon-card-emerald p-6 rounded-[2rem] text-center flex flex-col justify-center relative overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1.5 bg-emerald-500"></div>
              <p class="text-emerald-400 font-black uppercase tracking-widest text-xs mb-3">í•™ìŠµí•œ í”Œë˜ì‹œì¹´ë“œ</p>
              <div class="text-5xl font-black text-white" id="stat-tested">0</div>
          </div>
          <div class="neon-card-rose p-6 rounded-[2rem] text-center flex flex-col justify-center relative overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1.5 bg-rose-500"></div>
              <p class="text-rose-400 font-black uppercase tracking-widest text-xs mb-3">ë„ì „í•œ ì‚¬ì§€ì„ ë‹¤</p>
              <div class="text-5xl font-black text-white" id="stat-quizzed">0</div>
          </div>
      </div>
      <div class="neon-card-emerald p-6 sm:p-8 rounded-[2rem]">
          <div class="flex justify-between items-end mb-6">
              <div>
                  <h3 class="text-lg font-black text-emerald-100">ìµœê·¼ 35ì¼ í•™ìŠµ ê¸°ë¡</h3>
                  <p class="text-sm text-emerald-400/80 mt-1 font-bold" id="stat-streak">í˜„ì¬ <span class="text-emerald-400 font-black">0ì¼ì§¸</span> ì—°ì† í•™ìŠµ ì¤‘! ğŸ”¥</p>
              </div>
              <div class="flex gap-1.5 items-center text-xs text-emerald-500 font-black hidden sm:flex">
                  <span>Less</span>
                  <div class="w-3 h-3 rounded-sm grass-0"></div>
                  <div class="w-3 h-3 rounded-sm grass-1"></div>
                  <div class="w-3 h-3 rounded-sm grass-2"></div>
                  <div class="w-3 h-3 rounded-sm grass-3"></div>
                  <div class="w-3 h-3 rounded-sm grass-4"></div>
                  <span>More</span>
              </div>
          </div>
          <div class="overflow-x-auto pb-2 no-scrollbar">
              <div id="grass-grid" class="flex gap-2 min-w-max"></div>
          </div>
      </div>
  </div>
</div>
</div><!-- /wrapper -->

<!-- ëª¨ë‹¬ë“¤ -->
<div id="delete-modal" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="neon-card p-8 w-full max-w-sm mx-4 rounded-[2rem] transform scale-95 transition-transform duration-200" id="delete-modal-content">
    <div class="text-center mb-8"><div class="text-6xl mb-5">ğŸ—‘ï¸</div><h3 class="text-2xl font-black text-white mb-2 tracking-tight">ì •ë§ ì‚­ì œí• ê¹Œìš”?</h3></div>
    <div class="flex gap-4">
      <button onclick="closeDeleteModal()" class="active-bounce flex-1 bg-gray-800 text-gray-300 font-black py-4 rounded-xl border border-gray-600">ì·¨ì†Œ</button>
      <button onclick="executeDelete()" class="active-bounce flex-1 bg-rose-600 text-white font-black py-4 rounded-xl border border-rose-500">ì‚­ì œ</button>
    </div>
  </div>
</div>

<div id="clear-all-modal" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="neon-card-rose p-8 w-full max-w-sm mx-4 rounded-[2rem] transform scale-95 transition-transform duration-200" id="clear-all-modal-content">
    <div class="text-center mb-8"><div class="text-6xl mb-5">âš ï¸</div><h3 class="text-2xl font-black text-white mb-2 tracking-tight">ëª¨ë“  ë‹¨ì–´ ì˜êµ¬ ì‚­ì œ</h3><p class="text-rose-400 font-bold text-sm mt-1">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>
    <div class="flex gap-4">
      <button onclick="closeClearAllModal()" class="active-bounce flex-1 bg-gray-800 text-gray-300 font-black py-4 rounded-xl border border-gray-600">No (ì·¨ì†Œ)</button>
      <button onclick="executeClearAll()" class="active-bounce flex-1 bg-rose-600 text-white font-black py-4 rounded-xl border border-rose-500">Yes (ì‚­ì œ)</button>
    </div>
  </div>
</div>

<div id="edit-modal" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="neon-card-emerald p-8 w-full max-w-sm mx-4 rounded-[2rem] transform scale-95 transition-transform duration-200" id="edit-modal-content">
    <div class="text-center mb-6"><div class="text-6xl mb-4">âœï¸</div><h3 class="text-2xl font-black text-white tracking-tight">ë‹¨ì–´ ìˆ˜ì •</h3></div>
    <div class="flex flex-col gap-4 mb-8">
      <input id="edit-en" type="text" placeholder="ì˜ì–´ ë‹¨ì–´" class="w-full border border-gray-700 rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-gray-900 text-white transition-all font-black text-lg">
      <input id="edit-ko" type="text" placeholder="í•œêµ­ì–´ ëœ»" class="w-full border border-gray-700 rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-gray-900 text-white transition-all text-lg font-bold" onkeypress="if(event.key==='Enter')saveEditWord()">
    </div>
    <div class="flex gap-4">
      <button onclick="closeEditModal()" class="active-bounce flex-1 bg-gray-800 text-gray-300 font-black py-4 rounded-xl border border-gray-600">ì·¨ì†Œ</button>
      <button onclick="saveEditWord()" class="active-bounce flex-1 bg-emerald-600 text-white font-black py-4 rounded-xl border border-emerald-500">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="info-modal" class="fixed inset-0 bg-black/80 z-[250] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="neon-card rounded-[2rem] w-full max-w-2xl max-h-[85vh] mx-4 transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden" id="info-modal-content">
    <div class="flex justify-between items-center p-6 border-b border-gray-700 bg-gray-800">
      <h2 class="text-xl font-black text-indigo-300">ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥ ì„¤ëª…ì„œ</h2>
      <button onclick="closeInfoModal()" class="active-bounce text-gray-400 hover:text-rose-400 p-2 font-black" title="ë‹«ê¸°">âœ•</button>
    </div>
    <div class="p-8 overflow-y-auto text-gray-300 font-bold text-base leading-relaxed space-y-4">
      <p>í´ë¼ìš°ë“œ ìë™ ë™ê¸°í™”ê°€ ì ìš©ëœ <strong>ì•¼ê°„ ëª¨ë“œ(Dark Mode) ì „ìš©</strong> ìŠ¤ë§ˆíŠ¸ ì˜ë‹¨ì–´ì¥ì…ë‹ˆë‹¤.</p>
      <p>ë³„ë„ì˜ ë¡œê·¸ì¸ ê³¼ì • ì—†ì´, ì•±ì„ ì‹¤í–‰í•˜ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ìœ¼ë¡œ ëª¨ë“  ê¸°ê¸° ê°„ì˜ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ ë™ê¸°í™”í•©ë‹ˆë‹¤.</p>
      <p class="text-indigo-400 font-black mt-4">âœ“ íŒ: ì˜ì–´ ë‹¨ì–´ê°€ ê¸¸ë©´ í¬ê¸°ê°€ ìë™ìœ¼ë¡œ ì¶•ì†Œë˜ì–´ í•œ ì¤„ì— ê¹”ë”í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
  </div>
</div>

<script>
// ==============================
// ğŸ¯ í€´ì¦ˆ ì´í™íŠ¸ (ë¯¸ë‹ˆë©€)
// ==============================
const QuizFX = {
  ctx: null,
  getCtx() {
    if (!this.ctx) { try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){} }
    return this.ctx;
  },
  playCorrect() {
    const ctx = this.getCtx(); if (!ctx) return;
    const t = ctx.currentTime;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.setValueAtTime(520, t);
    o.frequency.linearRampToValueAtTime(780, t + 0.12);
    o.type = 'sine';
    g.gain.setValueAtTime(0.12, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
    o.start(t); o.stop(t + 0.18);
  },
  playWrong() {
    const ctx = this.getCtx(); if (!ctx) return;
    const t = ctx.currentTime;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = 200;
    o.type = 'square';
    g.gain.setValueAtTime(0.08, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
    o.start(t); o.stop(t + 0.15);
  }
};

// ==============================
// ê¸°ì¡´ ìœ í‹¸ ì½”ë“œ
// ==============================
let transCache = {};
try { transCache = JSON.parse(localStorage.getItem('myWordbook_transCache') || '{}'); } catch(e) { transCache = {}; }
function saveTransCache() { localStorage.setItem('myWordbook_transCache', JSON.stringify(transCache)); }

async function getTranslationSafe(word) {
    const lw = word.toLowerCase();
    if (transCache[lw]) return transCache[lw]; 
    try {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q=${encodeURIComponent(word)}`);
        const data = await res.json();
        const meaning = data[0][0][0];
        if (meaning) { transCache[lw] = meaning; saveTransCache(); return meaning; }
    } catch (e) { return 'ë²ˆì—­ ì‹¤íŒ¨'; }
    return 'ëœ» ì •ë³´ ì—†ìŒ';
}

const ALL_TABS = ['manage', 'srs', 'test', 'quiz', 'analysis', 'group', 'stats'];

let words=[], currentPage=1;
const IPP=12;

// í€´ì¦ˆ ìƒíƒœ
let quizQ=0, quizS=0, quizAnswered=0, quizWord=null, quizQueue=[], quizIdx=0, quizTimer=null;
let quizMode = 'random';
let quizPool = [];
let quizCombo = 0, quizBestCombo = 0; // ì½¤ë³´ ì‹œìŠ¤í…œ
let quizTimerInterval = null;          // íƒ€ì´ë¨¸ ì¸í„°ë²Œ
let quizTimeLeft = 100;                // íƒ€ì´ë¨¸ í¼ì„¼íŠ¸

let testQueue=[],testPool=[],testIdx=0,testCorrect=0,testMode='all';
let analysisWord=null,audioUrl=null;
const SIM_DUP=75,SIM_CONF=50;
let simMatrix={},confMatrix={};
let activityLog={};

let resizeTimer;
function resizeAllTexts() {
    document.querySelectorAll('.word-en-container').forEach(container => {
        const text = container.querySelector('.word-en-text');
        if (!text) return;
        text.style.transform = 'scale(1)';
        const containerWidth = container.clientWidth;
        const textWidth = text.scrollWidth;
        if (textWidth > containerWidth && containerWidth > 0) {
            text.style.transform = `scale(${containerWidth / textWidth})`;
        }
    });
}
window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(resizeAllTexts, 100); });

function showToast(msg,type='info'){
  const t=document.createElement('div');
  const isError = type === 'error';
  t.className=`fixed bottom-10 left-1/2 -translate-x-1/2 ${isError?'bg-rose-600 border border-rose-500':'bg-gray-800 border border-indigo-500'} px-8 py-4 rounded-full z-[100] font-black text-white text-base tracking-wide shadow-lg`;
  t.style.cssText='opacity:0;transform:translate(-50%,20px);transition:all .3s cubic-bezier(0.4, 0, 0.2, 1)';
  t.textContent=msg; document.body.appendChild(t);
  requestAnimationFrame(()=>{t.style.opacity='1';t.style.transform='translate(-50%,0)';});
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translate(-50%,-20px)';setTimeout(()=>t.remove(),300);},2300);
}
function shuffle(arr){let a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function openInfoModal(){document.getElementById('info-modal').classList.remove('hidden','opacity-0');document.getElementById('info-modal-content').classList.remove('scale-95');}
function closeInfoModal(){document.getElementById('info-modal').classList.add('opacity-0');document.getElementById('info-modal-content').classList.add('scale-95');setTimeout(()=>document.getElementById('info-modal').classList.add('hidden'),200);}

function loadData(){
  const raw=localStorage.getItem('myWordbook');
  if(raw){try{words=JSON.parse(raw);}catch{words=[];}}else{words=[];}
  const actRaw = localStorage.getItem('myActivity');
  if(actRaw){try{activityLog=JSON.parse(actRaw);}catch{activityLog={};}}
  renderWords();
  // SRS ë±ƒì§€ ì´ˆê¸°í™” (ì§§ì€ ì§€ì—° í›„)
  setTimeout(() => {
    const due = getSRSDue();
    const badge = document.getElementById('srs-due-badge');
    if (badge && due.length > 0) { badge.textContent = due.length > 99 ? '99+' : due.length; badge.classList.remove('hidden'); }
  }, 200);
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„±ëŠ¥ ì½”ì–´: í€´ì¦ˆ ì¤‘ ë ‰ì˜ ì‹¤ì œ ì›ì¸ = ë§¤ ì„ íƒë§ˆë‹¤ JSON.stringify(words)
// â†’ words ì§ë ¬í™” ë””ë°”ìš´ìŠ¤ 300ms / confMatrix ë””ë°”ìš´ìŠ¤ 500ms
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _renderDebounce = null;
function scheduleRender() {
  clearTimeout(_renderDebounce);
  _renderDebounce = setTimeout(renderWords, 80);
}

let _cloudDebounce = null;
function scheduleCloudSave(dataObj) {
  clearTimeout(_cloudDebounce);
  _cloudDebounce = setTimeout(() => {
    if (window.triggerCloudSave) window.triggerCloudSave(dataObj);
  }, 2000);
}

// words ë°°ì—´ ì§ë ¬í™” ë””ë°”ìš´ìŠ¤ â€” 300ms ë‚´ ì—°ì† ë³€ê²½ì€ í•œë²ˆì— ì²˜ë¦¬
let _lsPending = false, _lsTimer = null;
function scheduleLsSave() {
  clearTimeout(_lsTimer);
  _lsTimer = setTimeout(() => {
    localStorage.setItem('myWordbook', JSON.stringify(words));
    _lsPending = false;
  }, 300);
  _lsPending = true;
}
// ì¦‰ì‹œ ì €ì¥ì´ í•„ìš”í•  ë•Œ (íƒ­ ì „í™˜, ë‚´ë³´ë‚´ê¸° ì „ ë“±)
function flushLsSave() {
  clearTimeout(_lsTimer);
  localStorage.setItem('myWordbook', JSON.stringify(words));
  _lsPending = false;
}

function saveData({ skipRender = false, skipCloud = false, urgent = false } = {}) {
  if (urgent) flushLsSave();
  else scheduleLsSave();                    // words: ë””ë°”ìš´ìŠ¤ ì§ë ¬í™”
  localStorage.setItem('myActivity', JSON.stringify(activityLog)); // activityëŠ” ì‘ìŒ
  if (!skipRender) scheduleRender();
  if (!skipCloud) scheduleCloudSave({ words, activityLog });
}

function logActivity(type) {
    const today = new Date().toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' }).split('.').join('-').replace(/\s/g, '').replace(/-$/,'');
    if(!activityLog[today]) { activityLog[today] = { added: 0, tested: 0, quizzed: 0 }; }
    activityLog[today][type] = (activityLog[today][type] || 0) + 1;
    localStorage.setItem('myActivity', JSON.stringify(activityLog));
}

window.updateFromCloud = function(data) {
  words.length = 0;
  if (Array.isArray(data)) { words.push(...data); }
  else if (data && data.words) {
    words.push(...data.words);
    if(data.activityLog) activityLog = data.activityLog;
  }
  flushLsSave();
  localStorage.setItem('myActivity', JSON.stringify(activityLog));
  buildSimMatrixAsync().then(() => scheduleRender());
};

function loadConf(){try{confMatrix=JSON.parse(localStorage.getItem('confMatrix')||'{}');}catch{confMatrix={};}}
// confMatrix ë””ë°”ìš´ìŠ¤ ì €ì¥ (í€´ì¦ˆ ì˜¤ë‹µ ì„ íƒë§ˆë‹¤ ë™ê¸° write ë°©ì§€)
let _confTimer = null;
function saveConf() {
  clearTimeout(_confTimer);
  _confTimer = setTimeout(() => {
    localStorage.setItem('confMatrix', JSON.stringify(confMatrix));
  }, 500);
}
document.addEventListener('DOMContentLoaded',()=>{
  loadData();
  loadConf();
  buildSimMatrixAsync().then(()=>scheduleRender());
  // SRS ë±ƒì§€ ì´ˆê¸°í™”
  setTimeout(() => {
    if(typeof renderSRSDashboard === 'function') {
      const due = getSRSDue();
      const badge = document.getElementById('srs-due-badge');
      if(badge && due.length > 0){ badge.textContent = due.length > 99 ? '99+' : due.length; badge.classList.remove('hidden'); }
    }
  }, 300);
});

function switchTab(name){
  ALL_TABS.forEach(t=>{
    const btn=document.getElementById(`tab-${t}`),view=document.getElementById(`view-${t}`);
    const isActive = t === name;
    if(btn){
      // className ì™„ì „ ë®ì–´ì“°ê¸° ì œê±° â€” active ê´€ë ¨ í´ë˜ìŠ¤ë§Œ í† ê¸€
      btn.classList.toggle('font-black', isActive);
      btn.classList.toggle('text-indigo-400', isActive);
      btn.classList.toggle('border-indigo-500', isActive);
      btn.classList.toggle('bg-gray-800/80', isActive);
      btn.classList.toggle('font-bold', !isActive);
      btn.classList.toggle('text-gray-500', !isActive);
      btn.classList.toggle('border-transparent', !isActive);
    }
    if(view){
      if(isActive) view.classList.remove('hidden');
      else view.classList.add('hidden');
    }
  });
  if(name === 'srs') requestAnimationFrame(renderSRSDashboard);
  if(name!=='test') resetTestView();
  if(name!=='quiz') resetQuizView();
  if(name!=='analysis') document.getElementById('analysis-dropdown').classList.add('hidden');
  if(name==='manage') setTimeout(resizeAllTexts, 50);
  if(name==='stats') renderStats();
}

function addWord(){
  const enEl=document.getElementById('input-en'),koEl=document.getElementById('input-ko');
  const en=enEl.value.trim(),ko=koEl.value.trim();
  if(!en||!ko)return showToast('ì˜ì–´ ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
  const newWord = {id:Date.now(),en,ko,wrongCount:0, quizCount:0, nlp:null};
  words.push(newWord);
  buildSimMatrixForWord(newWord); // ì¦ë¶„ ì—…ë°ì´íŠ¸ O(n) 
  currentPage=1;
  logActivity('added');
  saveData({ urgent: true }); // ë‹¨ì–´ ì¶”ê°€ëŠ” ì¦‰ì‹œ ì €ì¥
  enEl.value='';koEl.value='';enEl.focus();
  showToast('ë‹¨ì–´ ì¶”ê°€ ì™„ë£Œ! âœ¨');
}

let pendingDeleteId = null;
function confirmDelete(id){pendingDeleteId = id; document.getElementById('delete-modal').classList.remove('hidden','opacity-0');document.getElementById('delete-modal-content').classList.remove('scale-95');}
function closeDeleteModal(){document.getElementById('delete-modal').classList.add('opacity-0');document.getElementById('delete-modal-content').classList.add('scale-95');setTimeout(()=>{document.getElementById('delete-modal').classList.add('hidden');pendingDeleteId = null;},200);}
function executeDelete(){
    if(pendingDeleteId !== null){
        const idx = words.findIndex(w => w.id === pendingDeleteId);
        if(idx !== -1) {
            const delId = words[idx].id;
            _analysisCache.delete(words[idx].en);
            delete simMatrix[delId];
            Object.values(simMatrix).forEach(row => delete row[delId]);
            if(idx !== words.length - 1) { words[idx] = words[words.length - 1]; }
            words.pop(); saveData(); showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        closeDeleteModal();
    }
}

function confirmClearAll() {if(words.length===0)return showToast('ì‚­ì œí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.','info');document.getElementById('clear-all-modal').classList.remove('hidden','opacity-0');document.getElementById('clear-all-modal-content').classList.remove('scale-95');}
function closeClearAllModal() {document.getElementById('clear-all-modal').classList.add('opacity-0');document.getElementById('clear-all-modal-content').classList.add('scale-95');setTimeout(()=>document.getElementById('clear-all-modal').classList.add('hidden'),200);}
function executeClearAll() {words=[];simMatrix={};saveData();closeClearAllModal();showToast('ëª¨ë“  ë‹¨ì–´ê°€ ì˜êµ¬ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ—‘ï¸');}

let editingWordId = null;
function openEditModal(id) {const w=words.find(x=>x.id===id);if(!w)return;editingWordId=id;document.getElementById('edit-en').value=w.en;document.getElementById('edit-ko').value=w.ko;document.getElementById('edit-modal').classList.remove('hidden','opacity-0');document.getElementById('edit-modal-content').classList.remove('scale-95');}
function closeEditModal() {document.getElementById('edit-modal').classList.add('opacity-0');document.getElementById('edit-modal-content').classList.add('scale-95');setTimeout(()=>{document.getElementById('edit-modal').classList.add('hidden');editingWordId=null;},200);}
function saveEditWord() {
  const en=document.getElementById('edit-en').value.trim(),ko=document.getElementById('edit-ko').value.trim();
  if(!en||!ko)return showToast('ì˜ì–´ ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
  const idx=words.findIndex(w=>w.id===editingWordId);
  if(idx!==-1){_analysisCache.delete(words[idx].en);words[idx].en=en;words[idx].ko=ko;words[idx].nlp=null;buildSimMatrixForWord(words[idx]);saveData();showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. âœï¸');closeEditModal();}
}

function changePage(d){currentPage+=d;renderWords();document.getElementById('word-list').scrollTop=0;}
function jumpToPage(val) {
  const page = parseInt(val, 10);
  if (!isNaN(page)) { currentPage = page; renderWords(); document.getElementById('word-list').scrollTop = 0; }
}

function renderWords(){
  const list=document.getElementById('word-list');
  const query = document.getElementById('search-manage').value.toLowerCase().trim();
  let disp=[...words];
  if(query) disp = disp.filter(w => w.en.toLowerCase().includes(query) || w.ko.includes(query));
  document.getElementById('word-count').textContent=disp.length;
  list.innerHTML='';
  if(!disp.length){list.innerHTML='<div class="col-span-full flex flex-col items-center justify-center text-gray-500 py-16"><span class="text-5xl mb-4 opacity-50">ğŸ“­</span><p class="font-black">ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';document.getElementById('pagination-controls').classList.add('hidden');return;}
  if(document.getElementById('sort-select').value==='wrongCount') { disp.sort((a,b)=>(b.wrongCount||0)-(a.wrongCount||0)); } 
  else { disp.sort((a,b)=> b.id - a.id); }
  const total=Math.max(1,Math.ceil(disp.length/IPP));currentPage=Math.max(1,Math.min(currentPage,total));
  // DocumentFragmentìœ¼ë¡œ ë°°ì¹˜ DOM ì‚½ì… (ë¦¬í”Œë¡œìš° ìµœì†Œí™”)
  const frag = document.createDocumentFragment();
  disp.slice((currentPage-1)*IPP,currentPage*IPP).forEach(w=>{
    const simRow=simMatrix[w.id]||{};const dupes=words.filter(x=>x.id!==w.id&&(simRow[x.id]||0)>=SIM_DUP);
    const wBadge=w.wrongCount>0?`<span class="px-2 py-0.5 bg-rose-900/50 text-rose-300 border border-rose-500/50 text-[10px] font-black rounded-full whitespace-nowrap tracking-wide">ì˜¤ë‹µ ${w.wrongCount}íšŒ</span>`:'';
    const dBadge=dupes.length?`<span class="px-2 py-0.5 bg-amber-900/50 text-amber-300 border border-amber-500/50 text-[10px] font-black rounded-full whitespace-nowrap tracking-wide">âš ï¸ ì¤‘ë³µ</span>`:'';
    const li=document.createElement('li');
    li.className='neon-card p-3.5 sm:p-4 rounded-2xl flex justify-between items-center w-full h-full';
    li.innerHTML=`
      <div class="flex flex-col flex-1 pr-3 min-w-0 word-en-container overflow-hidden justify-center h-full">
        <span class="font-black text-xl text-white mb-1 leading-none whitespace-nowrap inline-block w-max word-en-text origin-left transition-transform duration-200">${w.en}</span>
        <span class="text-gray-400 text-xs whitespace-normal break-words font-bold">${w.ko}</span>
        <div class="flex gap-1.5 mt-1.5 flex-wrap">${wBadge}${dBadge}</div>
      </div>
      <div class="flex gap-1.5 flex-shrink-0 items-center">
        <button onclick="openEditModal(${w.id})" class="active-bounce text-emerald-400 bg-gray-800 border border-gray-700 p-2.5 rounded-xl transition-all shadow-sm" title="ë‹¨ì–´ ìˆ˜ì •">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
        </button>
        <button onclick="openAnalysis(${w.id})" class="active-bounce text-indigo-400 bg-gray-800 border border-gray-700 p-2.5 rounded-xl transition-all shadow-sm" title="ë‹¨ì–´ ë¶„ì„">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        </button>
        <button onclick="confirmDelete(${w.id})" class="active-bounce text-rose-400 bg-gray-800 border border-gray-700 p-2.5 rounded-xl transition-all shadow-sm" title="ì‚­ì œ">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </button>
      </div>`;
    frag.appendChild(li);
  });
  list.appendChild(frag); // í•œ ë²ˆì— DOM ì‚½ì…
  const pgCtrl=document.getElementById('pagination-controls');
  if(total>1){
    pgCtrl.classList.remove('hidden');
    const pageSelect = document.getElementById('page-select');
    pageSelect.innerHTML = '';
    for(let i=1; i<=total; i++) {
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `PAGE ${i} / ${total}`;
        if(i === currentPage) opt.selected = true;
        pageSelect.appendChild(opt);
    }
    document.getElementById('btn-prev').disabled=currentPage===1;
    document.getElementById('btn-next').disabled=currentPage===total;
  } else { pgCtrl.classList.add('hidden'); }
  requestAnimationFrame(resizeAllTexts); // rAF: resize after paint, not blocking
}

function exportData(){if(!words.length)return showToast('ì €ì¥í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.','error');const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify(words,null,2)],{type:'application/json'})),download:`ì˜ë‹¨ì–´ì¥.json`});document.body.appendChild(a);a.click();a.remove();}
function importData(e){const file=e.target.files[0];if(!file)return;const r=new FileReader();r.onload=ev=>{try{const imp=JSON.parse(ev.target.result);if(!Array.isArray(imp))throw 0;imp.forEach(iw=>{if(iw.en&&iw.ko){words.push({id:Date.now()+Math.random(),en:iw.en,ko:iw.ko,wrongCount:iw.wrongCount||0, quizCount:iw.quizCount||0, nlp:null});}});saveData();buildSimMatrixAsync().then(()=>scheduleRender());currentPage=1;showToast(`ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ ğŸ“¥`);}catch{showToast('íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.','error');}};r.readAsText(file);e.target.value='';}

// ==============================
// í•™ìŠµ(í”Œë˜ì‹œì¹´ë“œ)
// ==============================
function resetTestView(){
    testQueue=[];testPool=[];testIdx=0;testCorrect=0;
    const ti=document.getElementById('test-intro'); if(ti) ti.classList.remove('hidden');
    const ta=document.getElementById('test-active'); if(ta) ta.classList.add('hidden');
    const tr=document.getElementById('test-result'); if(tr) tr.classList.add('hidden');
    const tim=document.getElementById('test-intro-main'); if(tim) tim.classList.remove('hidden');
    const tis=document.getElementById('test-intro-sets'); if(tis) tis.classList.add('hidden');
}
function showSetSelection() {
    if(words.length === 0) return showToast('ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
    const container = document.getElementById('set-list-container');
    container.innerHTML = '';
    const totalSets = Math.ceil(words.length / 50);
    for(let i=0; i<totalSets; i++) {
        const start = i * 50 + 1, end = Math.min((i + 1) * 50, words.length);
        const btn = document.createElement('button');
        btn.className = 'active-bounce neon-card flex flex-col items-center justify-center group py-4';
        btn.innerHTML = `<span class="text-lg font-black text-indigo-300 transition-all">ì„¸íŠ¸ ${i+1}</span><span class="text-xs text-gray-400 font-bold mt-1 transition-all">${start} ~ ${end}</span>`;
        btn.onclick = () => startTest('set', i);
        container.appendChild(btn);
    }
    document.getElementById('test-intro-main').classList.add('hidden');
    document.getElementById('test-intro-sets').classList.remove('hidden');
}
function hideSetSelection() {
    document.getElementById('test-intro-main').classList.remove('hidden');
    document.getElementById('test-intro-sets').classList.add('hidden');
}
function startTest(mode, setIdx = 0){
    if(!words.length) return showToast('ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!','error');
    testMode = mode;
    let pool=[],shouldShuffle=true;
    if(mode==='all'){ pool=[...words]; }
    else if(mode==='wrong'){ pool=words.filter(w=>(w.wrongCount||0)>0);if(!pool.length) return showToast('í‹€ë¦° ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!'); }
    else if(mode==='set'){ pool=words.slice(setIdx*50,(setIdx+1)*50);if(!pool.length) return showToast('í•´ë‹¹ ì„¸íŠ¸ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');shouldShuffle=false; }
    testPool=pool; testQueue=shouldShuffle?shuffle(pool):[...pool]; testIdx=0; testCorrect=0;
    document.getElementById('test-intro').classList.add('hidden');
    document.getElementById('test-active').classList.remove('hidden');
    loadTestCard();
}
function loadTestCard(){
    if(testIdx>=testQueue.length){ testQueue=testMode==='set'?[...testPool]:shuffle(testPool); testIdx=0; }
    const w=testQueue[testIdx];
    document.getElementById('test-progress').textContent=`${testIdx+1}/${testQueue.length}`;
    document.getElementById('test-score').textContent=testCorrect;
    document.getElementById('test-word-en').textContent=w.en;
    document.getElementById('test-word-ko').textContent=w.ko;
    document.getElementById('test-word-ko').classList.add('hidden');
    document.getElementById('btn-reveal').classList.remove('hidden');
    document.getElementById('test-actions').classList.add('hidden');
}
function revealAnswer(){document.getElementById('btn-reveal').classList.add('hidden');document.getElementById('test-word-ko').classList.remove('hidden');document.getElementById('test-actions').classList.remove('hidden');}
function markAnswer(ok){
    if(ok) testCorrect++;
    setTimeout(() => {
        if(!ok){ const i=words.findIndex(x=>x.id===testQueue[testIdx].id);if(i!==-1){words[i].wrongCount=(words[i].wrongCount||0)+1;saveData({skipRender:true});} }
        logActivity('tested'); testIdx++;
        if(testIdx>=testQueue.length){ document.getElementById('test-active').classList.add('hidden');document.getElementById('test-result').classList.remove('hidden');renderWords(); }
        else { loadTestCard(); }
    }, 50);
}

// ==============================
// ğŸ¯ ì™„ì „íˆ ìƒˆë¡œì›Œì§„ ì‚¬ì§€ì„ ë‹¤ ì‹œìŠ¤í…œ
// ==============================
const QUIZ_TIME = 15; // ì´ˆ

function stopQuizTimer() {
    if (quizTimerInterval) { clearInterval(quizTimerInterval); quizTimerInterval = null; }
}

function startQuizTimer() {
    stopQuizTimer();
    quizTimeLeft = 100;
    const bar = document.getElementById('quiz-timer-bar');
    bar.style.width = '100%';
    bar.className = ''; // ìƒ‰ìƒ í´ë˜ìŠ¤ ì´ˆê¸°í™” â†’ ê¸°ë³¸ ë³´ë¼ìƒ‰
    
    const step = 100 / (QUIZ_TIME * 10); // 100msë§ˆë‹¤ ì—…ë°ì´íŠ¸
    quizTimerInterval = setInterval(() => {
        quizTimeLeft = Math.max(0, quizTimeLeft - step);
        bar.style.width = quizTimeLeft + '%';
        
        if (quizTimeLeft <= 20) {
            bar.className = 'danger';
        } else if (quizTimeLeft <= 40) {
            bar.className = 'warning';
        }
        
        if (quizTimeLeft <= 0) {
            stopQuizTimer();
            handleTimeOut();
        }
    }, 100);
}

function handleTimeOut() {
    // ì‹œê°„ ì´ˆê³¼ ì‹œ ì˜¤ë‹µ ì²˜ë¦¬
    document.querySelectorAll('#quiz-options button').forEach(b => {
        b.disabled = true;
        if (b.dataset.correct === 'true') { b.classList.add('reveal-correct'); }
        else { b.classList.add('dimmed'); }
    });
    
    quizCombo = 0;
    updateComboUI();
    
    const i = words.findIndex(w => w.id === quizWord.id);
    if (i !== -1) { words[i].wrongCount = (words[i].wrongCount||0) + 1; saveData({skipRender:true}); }
    
    QuizFX.playWrong();
    QuizFX.flash('wrong');
    logActivity('quizzed');
    quizAnswered++;
    
    showToast('â° ì‹œê°„ ì´ˆê³¼!', 'error');
    quizTimer = setTimeout(() => nextQuiz(), 800);
}

function updateComboUI() {
    const comboWrap = document.getElementById('quiz-combo-wrap');
    const comboEl = document.getElementById('quiz-combo');
    if (quizCombo >= 2) {
        comboWrap.classList.remove('hidden');
        comboEl.textContent = `ğŸ”¥ ${quizCombo} ì½¤ë³´`;
        comboEl.classList.remove('combo-pop');
        void comboEl.offsetWidth;
        comboEl.classList.add('combo-pop');
    } else {
        comboWrap.classList.add('hidden');
    }
}

function resetQuizView(){
    if (quizTimer) clearTimeout(quizTimer);
    stopQuizTimer();
    quizQueue=[];quizIdx=0;quizPool=[];quizMode='random';
    quizCombo=0;quizBestCombo=0;
    const qi=document.getElementById('quiz-intro'); if(qi) qi.classList.remove('hidden');
    const qa=document.getElementById('quiz-active'); if(qa) qa.classList.add('hidden');
    const qr=document.getElementById('quiz-result'); if(qr) qr.classList.add('hidden');
}

function startQuiz(mode){
    if(words.length < 4) return showToast('ë‹¨ì–´ê°€ ì „ì²´ 4ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!','error');
    quizMode = mode;
    if (mode === 'wrong') {
        quizPool = words.filter(w => (w.wrongCount || 0) > 0);
        if (quizPool.length === 0) return showToast('í‹€ë¦° ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰', 'info');
    } else {
        quizPool = [...words];
    }
    quizQ=0; quizS=0; quizAnswered=0; quizIdx=0; quizCombo=0; quizBestCombo=0;
    quizQueue = mode === 'random' ? shuffle([...quizPool]) : [...quizPool].sort((a,b)=>(b.wrongCount||0)-(a.wrongCount||0));
    
    document.getElementById('quiz-intro').classList.add('hidden');
    document.getElementById('quiz-active').classList.remove('hidden');
    document.getElementById('quiz-combo-wrap').classList.add('hidden');
    nextQuiz();
}

function getDistractors(target){
    const mat=confMatrix[target.id]||{}, sim=simMatrix[target.id]||{};
    const cands=words.filter(w=>w.id!==target.id&&(sim[w.id]||0)<SIM_DUP);
    return cands.map(w=>({word:w,score:(sim[w.id]||0)*5+(mat[w.id]||0)*10+Math.random()*3})).sort((a,b)=>b.score-a.score).slice(0,3).map(s=>s.word);
}

function nextQuiz(){
    if(quizIdx >= quizQueue.length){
        if (quizMode === 'random') { quizQueue = shuffle([...quizPool]); }
        else {
            quizPool = words.filter(w => (w.wrongCount || 0) > 0);
            if (quizPool.length === 0) { showToast('ëª¨ë“  ì˜¤ë‹µì„ ë³µìŠµí–ˆìŠµë‹ˆë‹¤! ğŸ‘', 'info'); showQuizResult(); return; }
            quizQueue = shuffle([...quizPool]);
        }
        quizIdx=0;
    }
    quizQ++;
    document.getElementById('quiz-progress').textContent=`${quizQ}ë²ˆì§¸`;
    document.getElementById('quiz-score').textContent=quizS;
    quizWord=quizQueue[quizIdx++];
    
    // quizCountëŠ” ë©”ëª¨ë¦¬ë§Œ ì—…ë°ì´íŠ¸ (localStorage ì €ì¥ ë¶ˆí•„ìš” â€” í†µê³„ì— ë¯¸ì‚¬ìš©)
    const wIdx = words.findIndex(w=>w.id===quizWord.id);
    if(wIdx !== -1) { words[wIdx].quizCount = (words[wIdx].quizCount || 0) + 1; }
    
    document.getElementById('quiz-word-en').textContent=quizWord.en;
    
    const opts=document.getElementById('quiz-options');
    // Fragmentë¡œ ë²„íŠ¼ 4ê°œ í•œë²ˆì— ì‚½ì… (4ë²ˆ ë¦¬í”Œë¡œìš° â†’ 1ë²ˆ)
    const optFrag = document.createDocumentFragment();
    shuffle([{word:quizWord,ok:true},...getDistractors(quizWord).map(w=>({word:w,ok:false}))]).forEach((opt) => {
        const btn=document.createElement('button');
        btn.className='game-btn w-full neon-card font-black py-6 rounded-2xl text-xl break-words px-4 text-white';
        btn.textContent=opt.word.ko;
        btn.dataset.correct = opt.ok;
        btn.addEventListener('click', (e) => {
            selectQuiz(btn, opt.ok, opt.word.id, e);
        });
        optFrag.appendChild(btn);
    });
    opts.innerHTML='';
    opts.appendChild(optFrag);

    // íƒ€ì´ë¨¸ ì‹œì‘
    startQuizTimer();
}

function selectQuiz(btn, ok, selId, e){
    stopQuizTimer();
    document.querySelectorAll('#quiz-options button').forEach(b=>b.disabled=true);
    quizAnswered++;

    if(ok){
        btn.classList.add('correct-answer');
        document.querySelectorAll('#quiz-options button').forEach(b => { if(b !== btn) b.classList.add('dimmed'); });
        quizS++;
        quizCombo++;
        if (quizCombo > quizBestCombo) quizBestCombo = quizCombo;
        updateComboUI();
        QuizFX.playCorrect();
    } else {
        btn.classList.add('wrong-answer');
        document.querySelectorAll('#quiz-options button').forEach(b => {
            if (b.dataset.correct === 'true') b.classList.add('reveal-correct');
            else if (b !== btn) b.classList.add('dimmed');
        });
        quizCombo = 0;
        updateComboUI();
        QuizFX.playWrong();
    }

    document.getElementById('quiz-score').textContent = quizS;

    // UI ë°˜ì‘ ì¦‰ì‹œ â†’ ë‹¤ìŒ í”„ë ˆì„ ì´í›„ ë°ì´í„° ì²˜ë¦¬ (requestIdleCallback ìš°ì„ )
    const _settle = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
    _settle(() => {
        if(ok){
            if (quizMode === 'wrong') {
                const i=words.findIndex(w=>w.id===quizWord.id);
                if(i!==-1 && words[i].wrongCount > 0) { words[i].wrongCount--; saveData({skipRender:true}); }
            }
        } else {
            const i=words.findIndex(w=>w.id===quizWord.id);
            if(i!==-1){ words[i].wrongCount=(words[i].wrongCount||0)+1; saveData({skipRender:true}); }
            if(!confMatrix[quizWord.id]) confMatrix[quizWord.id]={};
            confMatrix[quizWord.id][selId]=(confMatrix[quizWord.id][selId]||0)+1;
            saveConf(); // debounced
        }
        logActivity('quizzed');
    });
    // ì •ë‹µ: 500ms, ì˜¤ë‹µ: 800ms
    quizTimer = setTimeout(()=>nextQuiz(), ok ? 500 : 800);
}

function showQuizResult(){
    if (quizTimer) clearTimeout(quizTimer);
    stopQuizTimer();
    document.getElementById('quiz-active').classList.add('hidden');
    document.getElementById('quiz-result').classList.remove('hidden');
    document.getElementById('quiz-final-score').textContent=quizS;
    document.getElementById('quiz-total-score').textContent=quizAnswered;
    
    const acc = quizAnswered > 0 ? Math.round(quizS / quizAnswered * 100) : 0;
    document.getElementById('quiz-accuracy').textContent = `ì •í™•ë„ ${acc}%`;
    
    document.getElementById('quiz-result-emoji').textContent = 
        acc >= 90 ? 'ğŸ†' : acc >= 70 ? 'ğŸ‰' : acc >= 50 ? 'ğŸ˜Š' : 'ğŸ¤”';
    
    document.getElementById('quiz-feedback').textContent = 
        acc >= 90 ? 'ğŸ”¥ ì™„ë²½í•´ìš”! ìµœê³ ì…ë‹ˆë‹¤!' :
        acc >= 70 ? 'âœ¨ ì˜í–ˆì–´ìš”! ì¡°ê¸ˆë§Œ ë”!' :
        acc >= 50 ? 'ğŸ’ª ê´œì°®ì•„ìš”, ê³„ì† ë„ì „í•˜ì„¸ìš”!' : 'ğŸ˜¤ ë‹¤ì‹œ í•œë²ˆ í•´ë´ìš”!';
    
    document.getElementById('quiz-best-combo').textContent = 
        quizBestCombo >= 3 ? `ğŸ”¥ ìµœê³  ì½¤ë³´: ${quizBestCombo}ì—°ì†` : '';
    
    renderWords();
}

// ==============================
// NLP ê·¸ë£¹í•‘ (ê¸°ì¡´ ìœ ì§€)
// ==============================
const KO_SUF=['ìŠ¤ëŸ½ë‹¤','ìŠ¤ëŸ¬ìš´','í•˜ë‹¤','í•˜ëŠ”','í•˜ì—¬','í•˜ê²Œ','í•œ','í•¨','íˆ','ì´ë‹¤','ì´ë€','ë˜ë‹¤','ë˜ëŠ”','ëœ','ë¨','ì ì¸','ì ìœ¼ë¡œ','ì ','ë¡­ë‹¤','ë¡œìš´','ì—†ë‹¤','ì—†ëŠ”','ìˆë‹¤','ìˆëŠ”','ì§€ë‹¤','ì§„','ã„´','ëŠ”','ì„','ë¥¼','ì´','ê°€','ì˜','ì—','ë¡œ','ê³¼','ì™€','ë„'].sort((a,b)=>b.length-a.length);
function tokenize(str){
    const tokens = new Set();
    str.split(/[,\/\sÂ·]+/).map(s => s.trim()).filter(Boolean).forEach(c => {
        let stem = c;
        for (const suf of KO_SUF) {
            if (stem.length > suf.length + 1 && stem.endsWith(suf)) {
                stem = stem.slice(0, -suf.length);
                break;
            }
        }
        if (stem.length >= 1) tokens.add(stem);
        tokens.add(c); // ì›í˜•ë„ í•¨ê»˜ ì¶”ê°€ (ì–´ê°„ë§Œ ë‚¨ê¸°ë©´ ê³¼ë„í•œ ì¼ë°˜í™” ë°œìƒ)
    });
    return tokens;
}

function semSim(a, b) {
    const tA = tokenize(a), tB = tokenize(b);
    if (!tA.size || !tB.size) return 0;

    // 1) í† í° ì™„ì „ ì¼ì¹˜ (Jaccard) â€” ê°€ì¥ ì‹ ë¢°ë„ ë†’ìŒ
    let exactMatch = 0;
    tA.forEach(t => { if (tB.has(t)) exactMatch++; });
    const union = new Set([...tA, ...tB]).size;
    const jaccard = exactMatch / union;

    // 2) ë¶€ë¶„ í¬í•¨ â€” ê¸¸ì´ 2ì ì´ìƒ í† í°ë§Œ, ì§§ì€ í† í°ì˜ spurious ë§¤ì¹­ ë°©ì§€
    let partial = 0;
    tA.forEach(ta => {
        if (ta.length < 2) return;
        tB.forEach(tb => {
            if (tb.length < 2 && ta === tb) return;
            if (ta !== tb && ta.length >= 2 && tb.length >= 2) {
                if (ta.includes(tb) || tb.includes(ta)) partial += 0.25;
            }
        });
    });
    // partial ê³¼ì‰ ë°©ì§€: ìµœëŒ€ 0.3ìœ¼ë¡œ cap
    const partialScore = Math.min(0.3, partial * 0.1);

    // 3) ë¬¸ì ì…‹ ê²¹ì¹¨ â€” í•œêµ­ì–´ ë‹¨ì–´ ìì²´ê°€ ì§§ì•„ì„œ ê¸°ì—¬ë„ ë‚®ì¶¤ (10% â†’ 8%)
    const chA = new Set([...a.replace(/[,\/\s]/g, '')]);
    const chB = new Set([...b.replace(/[,\/\s]/g, '')]);
    let charOverlap = 0;
    chA.forEach(c => { if (chB.has(c)) charOverlap++; });
    const charScore = charOverlap / Math.max(chA.size, chB.size);

    // ì™„ì „ ì¼ì¹˜ í† í°ì´ ìˆìœ¼ë©´ ì ìˆ˜ ëŒ€í­ ë¶€ìŠ¤íŠ¸
    const exactBonus = exactMatch > 0 ? 0.15 : 0;

    return Math.min(100, Math.round(
        jaccard * 65 +
        partialScore * 20 +
        charScore * 8 +
        exactBonus * 7
    ) * 100) / 100;
}
// â”€â”€ ì„±ëŠ¥: ìœ ì‚¬ë„ í–‰ë ¬ â€” ì¦ë¶„ ì—…ë°ì´íŠ¸ + ë¹„ë™ê¸° ì²­í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ìƒˆ ë‹¨ì–´ ì¶”ê°€/ìˆ˜ì • ì‹œ í•´ë‹¹ ë‹¨ì–´ ê´€ë ¨ í–‰ë§Œ ì—…ë°ì´íŠ¸ (O(n) vs O(nÂ²))
function buildSimMatrixForWord(w) {
  if (!simMatrix[w.id]) simMatrix[w.id] = {};
  for (const other of words) {
    if (other.id === w.id) continue;
    if (!simMatrix[other.id]) simMatrix[other.id] = {};
    const s = semSim(w.ko, other.ko);
    simMatrix[w.id][other.id] = s;
    simMatrix[other.id][w.id] = s;
  }
}

// ì „ì²´ ì¬ê³„ì‚° â€” ì²­í¬ ë‹¨ìœ„ë¡œ ë‚˜ëˆ ì„œ ë©”ì¸ìŠ¤ë ˆë“œ ì–‘ë³´ (ë ‰ ë°©ì§€)
function buildSimMatrix() {
  simMatrix = {};
  if (words.length === 0) return;
  // ì¦‰ì‹œ ë™ê¸° ì‹¤í–‰ (ì†Œê·œëª¨ ë‹¨ì–´ì¥)
  for (let i = 0; i < words.length; i++) {
    for (let j = i + 1; j < words.length; j++) {
      const a = words[i], b = words[j];
      if (!simMatrix[a.id]) simMatrix[a.id] = {};
      if (!simMatrix[b.id]) simMatrix[b.id] = {};
      const s = semSim(a.ko, b.ko);
      simMatrix[a.id][b.id] = s;
      simMatrix[b.id][a.id] = s;
    }
  }
}

// ë¹„ë™ê¸° ì „ì²´ ì¬ê³„ì‚° â€” ë‹¨ì–´ ë§ì„ ë•Œ ì‚¬ìš© (ì²­í¬ 8ìŒì”© ì²˜ë¦¬ í›„ yield)
function buildSimMatrixAsync() {
  return new Promise(resolve => {
    simMatrix = {};
    if (words.length === 0) { resolve(); return; }
    const pairs = [];
    for (let i = 0; i < words.length; i++)
      for (let j = i + 1; j < words.length; j++)
        pairs.push([i, j]);
    let idx = 0;
    const CHUNK = 30;
    function processChunk() {
      const end = Math.min(idx + CHUNK, pairs.length);
      for (; idx < end; idx++) {
        const [i, j] = pairs[idx];
        const a = words[i], b = words[j];
        if (!simMatrix[a.id]) simMatrix[a.id] = {};
        if (!simMatrix[b.id]) simMatrix[b.id] = {};
        const s = semSim(a.ko, b.ko);
        simMatrix[a.id][b.id] = s;
        simMatrix[b.id][a.id] = s;
      }
      if (idx < pairs.length) setTimeout(processChunk, 0);
      else resolve();
    }
    processChunk();
  });
}

function getStem(w) {
    let s = w.toLowerCase();
    if(s.length < 4) return s;
    if(s.endsWith('ies') && s.length>4) return s.slice(0,-3)+'y';
    if(s.endsWith('es') && s.length>4) return s.slice(0,-2);
    if(s.endsWith('s') && s.length>3 && !s.endsWith('ss')) return s.slice(0,-1);
    if(s.endsWith('ing') && s.length>5) return s.slice(0,-3);
    if(s.endsWith('ed') && s.length>4) return s.slice(0,-2);
    if(s.endsWith('tion') && s.length>5) return s.slice(0,-4);
    if(s.endsWith('ment') && s.length>5) return s.slice(0,-4);
    if(s.endsWith('ity') && s.length>5) return s.slice(0,-3);
    if(s.endsWith('ive') && s.length>4) return s.slice(0,-3);
    if(s.endsWith('ly') && s.length>4) return s.slice(0,-2);
    return s;
}
const PREFIX_DICT = [
    {p: 'trans', m: 'ê°€ë¡œì§ˆëŸ¬/ë°”ê¾¸ì–´'}, {p: 'inter', m: 'ìƒí˜¸/ì‚¬ì´ì—'}, {p: 'super', m: 'ì´ˆê³¼/ìœ„ì—'},
    {p: 'under', m: 'ì•„ë˜ì—/ë¶€ì¡±í•œ'}, {p: 'over', m: 'ë„˜ì–´ì„œ/ê³¼ë„í•œ'}, {p: 'anti', m: 'ë°˜ëŒ€/í•­'},
    {p: 'auto', m: 'ìŠ¤ìŠ¤ë¡œ/ìë™'}, {p: 'multi', m: 'ë§ì€/ë‹¤ì¤‘'}, {p: 'poly', m: 'ë§ì€/ë‹¤ì¤‘'},
    {p: 'semi', m: 'ë°˜/ì ˆë°˜'}, {p: 'tele', m: 'ë©€ë¦¬'}, {p: 'micro', m: 'ì‘ì€'}, {p: 'macro', m: 'í°'},
    {p: 'pre', m: 'ë¯¸ë¦¬/ì´ì „'}, {p: 'post', m: 'ì´í›„'}, {p: 'dis', m: 'ë¶€ì •/ë¶„ë¦¬'},
    {p: 'mis', m: 'ì˜ëª»ëœ'}, {p: 'non', m: 'ì•„ë‹Œ'}, {p: 'sub', m: 'ì•„ë˜'}, {p: 're', m: 'ë‹¤ì‹œ/ë’¤ë¡œ'},
    {p: 'un', m: 'ë¶€ì •/ë°˜ëŒ€'}, {p: 'in', m: 'ì•ˆìœ¼ë¡œ/ë¶€ì •'}, {p: 'im', m: 'ì•ˆìœ¼ë¡œ/ë¶€ì •'},
    {p: 'il', m: 'ë¶€ì •'}, {p: 'ir', m: 'ë¶€ì •'}, {p: 'com', m: 'í•¨ê»˜'}, {p: 'con', m: 'í•¨ê»˜'},
    {p: 'co', m: 'í•¨ê»˜'}, {p: 'ex', m: 'ë°–ìœ¼ë¡œ'}
];
function getPrefix(w) {
    let s = w.toLowerCase();
    for(let pr of PREFIX_DICT) { if(s.startsWith(pr.p) && s.length > pr.p.length + 2) return pr; }
    return null;
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// enrichWord â€” 2-source ì „ëµìœ¼ë¡œ ìœ ì˜ì–´/ë°˜ì˜ì–´ í’ˆì§ˆ ëŒ€í­ í–¥ìƒ
//
// ì†ŒìŠ¤ 1: Free Dictionary API (freedictionaryapi.com)
//   - WordNet ê¸°ë°˜, í‚¤ ë¶ˆí•„ìš”, senseë³„ synonyms/antonyms ì œê³µ
//   - ì˜ˆ: "happy" â†’ senseë³„ë¡œ [glad, pleased, content, joyful, ...]
//
// ì†ŒìŠ¤ 2: Datamuse rel_syn / rel_ant (max 50 â†’ ê¸°ì¡´ 5ì—ì„œ 10ë°°)
//   - í†µê³„ ê¸°ë°˜, ì‹¤ì œ í…ìŠ¤íŠ¸ ì½”í¼ìŠ¤ì—ì„œ ì¶”ì¶œ
//   - max 50ìœ¼ë¡œ ë‹¨ì–´ì¥ ë‚´ ë‹¤ë¥¸ ë‹¨ì–´ê°€ ëª©ë¡ì— í¬í•¨ë  í™•ë¥  ëŒ€í­ ìƒìŠ¹
//
// ë‘ ì†ŒìŠ¤ ë³‘í•© â†’ ì¤‘ë³µ ì œê±° â†’ dedupe Set ì‚¬ìš©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function enrichWord(w) {
    if(w.nlp && w.nlp.fetched) return false;
    w.nlp = { syn: [], ant: [], stem: getStem(w.en), prefix: getPrefix(w.en), fetched: false };
    if (!navigator.onLine) { w.nlp.fetched = true; return true; }

    const toWords = arr => Array.isArray(arr) ? arr.map(x => typeof x === 'string' ? x.toLowerCase() : (x.word||'').toLowerCase()).filter(Boolean) : [];

    try {
        // 3ê°œ ìš”ì²­ ë™ì‹œ ë°œì‚¬
        const [freeDictRes, dmSynRes, dmAntRes] = await Promise.allSettled([
            fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(w.en)}`)
                .then(r => r.ok ? r.json() : null).catch(() => null),
            fetch(`https://api.datamuse.com/words?rel_syn=${encodeURIComponent(w.en)}&max=50`)
                .then(r => r.json()).catch(() => []),
            fetch(`https://api.datamuse.com/words?rel_ant=${encodeURIComponent(w.en)}&max=50`)
                .then(r => r.json()).catch(() => []),
        ]);

        // Datamuse ê²°ê³¼
        const dmSyn = freeDictRes.status === 'fulfilled' ? toWords(dmSynRes.value ?? []) : [];
        const dmAnt = freeDictRes.status === 'fulfilled' ? toWords(dmAntRes.value ?? []) : [];
        const dmSynSet = toWords(dmSynRes.status === 'fulfilled' ? dmSynRes.value : []);
        const dmAntSet = toWords(dmAntRes.status === 'fulfilled' ? dmAntRes.value : []);

        // Free Dictionary APIì—ì„œ senseë³„ syn/ant ì¶”ì¶œ
        let fdSyn = [], fdAnt = [];
        const fdData = freeDictRes.status === 'fulfilled' ? freeDictRes.value : null;
        if (Array.isArray(fdData)) {
            fdData.forEach(entry => {
                (entry.meanings || []).forEach(m => {
                    // í’ˆì‚¬ ë ˆë²¨ syn/ant
                    fdSyn.push(...toWords(m.synonyms));
                    fdAnt.push(...toWords(m.antonyms));
                    // ì •ì˜ ë ˆë²¨ syn/ant
                    (m.definitions || []).forEach(d => {
                        fdSyn.push(...toWords(d.synonyms));
                        fdAnt.push(...toWords(d.antonyms));
                    });
                });
            });
        }

        // ë³‘í•© + ì¤‘ë³µ ì œê±° (Set ì‚¬ìš©)
        const selfWord = w.en.toLowerCase();
        const mergeDedupe = (...arrays) => {
            const seen = new Set([selfWord]);
            const result = [];
            for (const arr of arrays) {
                for (const word of arr) {
                    const clean = word.replace(/_/g, ' ').trim();
                    if (clean && !seen.has(clean)) { seen.add(clean); result.push(clean); }
                }
            }
            return result;
        };

        // Free Dictionaryë¥¼ ì•ì— (ë” ì‹ ë¢°ë„ ë†’ìŒ), Datamuseë¥¼ ë’¤ì— (ì»¤ë²„ë¦¬ì§€ ë³´ì™„)
        w.nlp.syn = mergeDedupe(fdSyn, dmSynSet);
        w.nlp.ant = mergeDedupe(fdAnt, dmAntSet);
        w.nlp.fetched = true;
        return true;
    } catch(e) {
        w.nlp.fetched = true;
        return false;
    }
}

// ë³‘ë ¬ ë°°ì¹˜ fetch â€” BATCH_SIZEê°œì”© ë™ì‹œ ìš”ì²­ (ì§ë ¬ ëŒ€ë¹„ ~5-8ë°° ë¹ ë¦„)
async function enrichWordsBatch(wordsToFetch, onProgress) {
    const BATCH_SIZE = 6; // datamuse rate-limit ê³ ë ¤
    let done = 0;
    for (let i = 0; i < wordsToFetch.length; i += BATCH_SIZE) {
        const batch = wordsToFetch.slice(i, i + BATCH_SIZE);
        await Promise.allSettled(batch.map(w => enrichWord(w)));
        done += batch.length;
        onProgress(done, wordsToFetch.length);
        // ë¸Œë¼ìš°ì €ì— í”„ë ˆì„ ì–‘ë³´ (UI ë ‰ ë°©ì§€)
        await new Promise(r => setTimeout(r, 0));
    }
}

async function runNLPGrouping() {
    if(words.length < 2) return showToast('ë¹„êµí•  ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
    document.getElementById('group-container').classList.add('hidden');
    const loadingUI = document.getElementById('group-loading');
    const progressBar = document.getElementById('nlp-progress-bar');
    const progressText = document.getElementById('nlp-progress-text');
    loadingUI.classList.remove('hidden'); loadingUI.classList.add('flex');
    progressBar.style.width = '0%';

    const needsFetch = words.filter(w => !w.nlp || !w.nlp.fetched);
    const totalToFetch = needsFetch.length;
    const alreadyCached = words.length - totalToFetch;

    // ìºì‹œëœ ë‹¨ì–´ëŠ” ì¦‰ì‹œ ì§„í–‰ë¥  ë°˜ì˜
    if (alreadyCached > 0) {
        progressBar.style.width = `${Math.round(alreadyCached / words.length * 100)}%`;
        progressText.textContent = `${alreadyCached} / ${words.length} (ìºì‹œ)`;
    }

    let offlineWarning = !navigator.onLine && needsFetch.length > 0;
    if (needsFetch.length > 0) {
        await enrichWordsBatch(needsFetch, (done, total) => {
            const overall = alreadyCached + done;
            progressBar.style.width = `${Math.round(overall / words.length * 100)}%`;
            progressText.textContent = `${overall} / ${words.length}`;
        });
        saveData({ skipRender: true, skipCloud: false });
    } else {
        progressBar.style.width = '100%';
        progressText.textContent = `${words.length} / ${words.length}`;
    }
    if(offlineWarning) showToast("ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ìºì‹±ëœ ë°ì´í„°ë§Œ í™œìš©í•©ë‹ˆë‹¤.", "info");
    function buildCard(title, groupArr) {
        const card = document.createElement('div');
        card.className = 'neon-card p-6 rounded-3xl flex flex-col h-full fade-in';
        let chipsHtml = groupArr.map(w => `<span class="chip bg-gray-900 text-indigo-300 border border-gray-700 hover:bg-gray-800" onclick="openAnalysis(${w.id})" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ë¶„ì„">${w.en} <span class="text-[10px] text-gray-500 ml-1 font-bold">${w.ko}</span></span>`).join('');
        card.innerHTML = `<div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-700"><h4 class="text-base font-black text-white flex items-center gap-2 truncate pr-2">${title}</h4><span class="text-[10px] font-black text-indigo-400 bg-gray-800 px-2 py-1 rounded-full whitespace-nowrap border border-gray-700">${groupArr.length}ë‹¨ì–´</span></div><div class="flex flex-wrap gap-2 items-start content-start flex-1">${chipsHtml}</div>`;
        return card;
    }
    // â”€â”€ ì–´ê·¼ ê·¸ë£¹: ì •í™•ë„ ê°œì„  â”€â”€
    // ê¸°ì¡´: getStemì´ ë„ˆë¬´ ê³µê²©ì  (e.g., "create"â†’"creat", "creative"â†’"creat" â†’ ë§ìŒ)
    // ê°œì„ : ì–´ê·¼ì´ 3ì ë¯¸ë§Œì´ê±°ë‚˜ ë¶ˆê·œì¹™ ë™ì‚¬ ë“± ì˜ë¯¸ì—†ëŠ” ë§¤ì¹­ í•„í„°ë§
    //       + ì–´ê·¼ ì¼ì¹˜ ì™¸ì—ë„ ì‹¤ì œ ë‹¨ì–´ í¬í•¨ ê´€ê³„ ê²€ì¦ (false positive ì œê±°)
    const COMMON_STEMS_BLACKLIST = new Set(['th','wh','be','do','go','ha','re','in','an','on','at','is','it','of','to','by','no','up','us','we','so']);
    let stemGroups = {};
    words.forEach(w => {
        if (!w.nlp) return;
        const stem = w.nlp.stem;
        if (!stem || stem.length < 4) return;               // 3ì ì´í•˜ ì–´ê·¼ ì œì™¸
        if (COMMON_STEMS_BLACKLIST.has(stem)) return;        // ì˜ë¯¸ì—†ëŠ” ì ‘ë‘ ì œì™¸
        // ì–´ê·¼ì´ ì‹¤ì œë¡œ ë‹¨ì–´ì— í¬í•¨ë˜ëŠ”ì§€ ê²€ì¦ (false positive ë°©ì§€)
        if (!w.en.toLowerCase().startsWith(stem) && !w.en.toLowerCase().includes(stem)) return;
        if (!stemGroups[stem]) stemGroups[stem] = [];
        stemGroups[stem].push(w);
    });
    // ì¶”ê°€: simMatrix ê¸°ë°˜ ì˜ë¯¸ ìœ ì‚¬ë„ ë†’ì€ ë‹¨ì–´ë„ í•œêµ­ì–´ ì˜ë¯¸ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ê¸°
    const SIM_GROUP_THRESHOLD = 35; // 35% ì´ìƒ ìœ ì‚¬í•˜ë©´ ê°™ì€ ì˜ë¯¸ ê·¸ë£¹
    let simGroups = {};
    words.forEach(w => {
        const simRow = simMatrix[w.id] || {};
        words.forEach(other => {
            if (other.id === w.id) return;
            const sim = simRow[other.id] || 0;
            if (sim >= SIM_GROUP_THRESHOLD && sim < SIM_DUP) {
                // ë‘ ë‹¨ì–´ ì¤‘ ë” ì‘ì€ IDë¥¼ í‚¤ë¡œ ì‚¬ìš©
                const key = Math.min(w.id, other.id) + '_' + Math.max(w.id, other.id);
                if (!simGroups[key]) simGroups[key] = new Set([w, other]);
                else { simGroups[key].add(w); simGroups[key].add(other); }
            }
        });
    });
    // simGroupsë¥¼ Union-Findë¡œ ë³‘í•© (ì—°ê²° ì»´í¬ë„ŒíŠ¸)
    const simUfParent = new Map(words.map(w => [w.id, w.id]));
    function simUfFind(id) { if (simUfParent.get(id) !== id) simUfParent.set(id, simUfFind(simUfParent.get(id))); return simUfParent.get(id); }
    Object.values(simGroups).forEach(pair => {
        const arr = [...pair];
        for (let i = 1; i < arr.length; i++) simUfParent.set(simUfFind(arr[i].id), simUfFind(arr[0].id));
    });
    const koMeanGroups = new Map();
    words.forEach(w => {
        const root = simUfFind(w.id);
        const comp = words.filter(x => simUfFind(x.id) === root);
        if (comp.length > 1) koMeanGroups.set(root, comp);
    });

    const stemGrid = document.getElementById('nlp-stem-grid');
    stemGrid.innerHTML = '';
    let stemFound = false;
    Object.keys(stemGroups).forEach(stem => {
        if (stemGroups[stem].length > 1) {
            stemGrid.appendChild(buildCard(`ì–´ê·¼ [ ${stem}- ]`, stemGroups[stem]));
            stemFound = true;
        }
    });
    // í•œêµ­ì–´ ì˜ë¯¸ ìœ ì‚¬ ê·¸ë£¹ ì¶”ê°€ í‘œì‹œ
    koMeanGroups.forEach((group, rootId) => {
        // ì–´ê·¼ ê·¸ë£¹ê³¼ ê²¹ì¹˜ì§€ ì•ŠëŠ” ìƒˆë¡œìš´ ê·¸ë£¹ë§Œ ì¶”ê°€
        const rootWord = words.find(w => w.id === rootId);
        if (rootWord) {
            stemGrid.appendChild(buildCard(`ğŸ‡°ğŸ‡· ì˜ë¯¸ ìœ ì‚¬ ê·¸ë£¹ (${rootWord.ko} ê³„ì—´)`, group));
            stemFound = true;
        }
    });
    if(!stemFound) stemGrid.innerHTML = '<p class="text-gray-500 font-bold text-sm">ê°™ì€ ì–´ê·¼ì„ ê³µìœ í•˜ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    // â”€â”€ ì ‘ë‘ì‚¬ ê·¸ë£¹: ì •í™•ë„ ê°œì„  â”€â”€
    // ê¸°ì¡´: prefix ì¼ì¹˜ë§Œ í™•ì¸ â†’ false positive (e.g., "remark"â‰ "re-mark")
    // ê°œì„ : ì ‘ë‘ì‚¬ ì œê±° í›„ ë‚¨ì€ ì–´ê°„ì´ 2ì ì´ìƒì´ê³  ì‹¤ì œ ì˜ì–´ ë‹¨ì–´ì²˜ëŸ¼ ë³´ì´ëŠ”ì§€ ê²€ì¦
    const VOWELS = new Set('aeiou');
    function isLikelyWord(s) {
        // 2ì ì´ìƒì´ê³  ëª¨ìŒì´ 1ê°œ ì´ìƒ í¬í•¨ë˜ì–´ì•¼ ì˜ì–´ ì–´ê°„ìœ¼ë¡œ ì¸ì •
        return s.length >= 2 && [...s].some(c => VOWELS.has(c));
    }
    let prefixGroups = {};
    words.forEach(w => {
        if (!w.nlp || !w.nlp.prefix) return;
        const prefix = w.nlp.prefix;
        const stem = w.en.toLowerCase().slice(prefix.p.length);
        if (!isLikelyWord(stem)) return; // false positive í•„í„°
        const pkey = prefix.p;
        if (!prefixGroups[pkey]) prefixGroups[pkey] = { title: `${prefix.p}- (${prefix.m})`, arr: [] };
        prefixGroups[pkey].arr.push(w);
    });
    const prefixGrid = document.getElementById('nlp-prefix-grid');
    prefixGrid.innerHTML = '';
    let prefixFound = false;
    // 2ê°œ ì´ìƒ + ì–´êµ° í¬ê¸° ìˆœ ì •ë ¬
    Object.entries(prefixGroups)
        .filter(([, v]) => v.arr.length > 1)
        .sort(([, a], [, b]) => b.arr.length - a.arr.length)
        .forEach(([, v]) => { prefixGrid.appendChild(buildCard(v.title, v.arr)); prefixFound = true; });
    if(!prefixFound) prefixGrid.innerHTML = '<p class="text-gray-500 font-bold text-sm">ê³µí†µ ì ‘ë‘ì‚¬ë¥¼ ê°€ì§„ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    // â”€â”€ ìœ ì˜ì–´/ë°˜ì˜ì–´ ê·¸ë˜í”„ â€” Union-Findë¡œ ì •í™•í•œ ì—°ê²° ì»´í¬ë„ŒíŠ¸ ì¶”ì¶œ â”€â”€
    // ê¸°ì¡´: shift() ê¸°ë°˜ ê·¸ë¦¬ë”” â†’ ë…¸ë“œ ìˆœì„œì— ë”°ë¼ ê·¸ë£¹ì´ ë‹¬ë¼ì§€ëŠ” ë²„ê·¸
    // ê°œì„ : Union-Findë¡œ ëª¨ë“  ì—£ì§€ë¥¼ ë¨¼ì € ì²˜ë¦¬ í›„ ì»´í¬ë„ŒíŠ¸ ì¶”ì¶œ (ìˆœì„œ ë¬´ê´€)
    const ufParent = new Map(words.map(w => [w.id, w.id]));
    function ufFind(id) {
        if (ufParent.get(id) !== id) ufParent.set(id, ufFind(ufParent.get(id)));
        return ufParent.get(id);
    }
    function ufUnion(a, b) { ufParent.set(ufFind(a), ufFind(b)); }

    // ì—£ì§€ íŒë³„: ì–‘ë°©í–¥ ìœ ì˜ì–´/ë°˜ì˜ì–´ í™•ì¸ (ë‹¨ë°©í–¥ë§Œ ìˆì–´ë„ ì—°ê²°)
    for (let i = 0; i < words.length; i++) {
        for (let j = i + 1; j < words.length; j++) {
            const a = words[i], b = words[j];
            if (!a.nlp || !b.nlp) continue;
            const aen = a.en.toLowerCase(), ben = b.en.toLowerCase();
            const aSyn = a.nlp.syn || [], aAnt = a.nlp.ant || [];
            const bSyn = b.nlp.syn || [], bAnt = b.nlp.ant || [];
            const connected =
                aSyn.includes(ben) || bSyn.includes(aen) ||
                aAnt.includes(ben) || bAnt.includes(aen);
            if (connected) ufUnion(a.id, b.id);
        }
    }
    // ì»´í¬ë„ŒíŠ¸ ìˆ˜ì§‘
    const synAntMap = new Map();
    words.forEach(w => {
        const root = ufFind(w.id);
        if (!synAntMap.has(root)) synAntMap.set(root, []);
        synAntMap.get(root).push(w);
    });
    const synAntGroups = [...synAntMap.values()].filter(g => g.length > 1);

    // ê·¸ë£¹ ë‚´ ê° ë‹¨ì–´ì˜ ê´€ê³„ íƒ€ì… í‘œì‹œ (ìœ ì˜ì–´ / ë°˜ì˜ì–´ êµ¬ë¶„)
    function getRelationType(a, b) {
        const aen = a.en.toLowerCase(), ben = b.en.toLowerCase();
        const isSyn = (a.nlp?.syn||[]).includes(ben) || (b.nlp?.syn||[]).includes(aen);
        const isAnt = (a.nlp?.ant||[]).includes(ben) || (b.nlp?.ant||[]).includes(aen);
        if (isSyn && isAnt) return 'ìœ ì˜+ë°˜ì˜';
        if (isSyn) return 'ìœ ì˜ì–´';
        if (isAnt) return 'ë°˜ì˜ì–´';
        return 'ê°„ì ‘';
    }

    // ê·¸ë£¹ ì¹´ë“œ: ê´€ê³„ íƒ€ì… ë±ƒì§€ ì¶”ê°€
    function buildSynAntCard(title, groupArr) {
        const card = document.createElement('div');
        card.className = 'neon-card p-6 rounded-3xl flex flex-col h-full fade-in';
        // ê·¸ë£¹ ë‚´ ê´€ê³„ ìš”ì•½
        let relSummary = '';
        const hasSyn = groupArr.some((w,i) => groupArr.slice(i+1).some(w2 => (w.nlp?.syn||[]).includes(w2.en.toLowerCase()) || (w2.nlp?.syn||[]).includes(w.en.toLowerCase())));
        const hasAnt = groupArr.some((w,i) => groupArr.slice(i+1).some(w2 => (w.nlp?.ant||[]).includes(w2.en.toLowerCase()) || (w2.nlp?.ant||[]).includes(w.en.toLowerCase())));
        if (hasSyn) relSummary += '<span class="text-[10px] font-black bg-purple-900/50 text-purple-300 border border-purple-700 px-2 py-0.5 rounded-full">ìœ ì˜ì–´ í¬í•¨</span> ';
        if (hasAnt) relSummary += '<span class="text-[10px] font-black bg-rose-900/50 text-rose-300 border border-rose-700 px-2 py-0.5 rounded-full">ë°˜ì˜ì–´ í¬í•¨</span>';
        // ê° ë‹¨ì–´ì˜ ê·¸ë£¹ ë‚´ ê´€ê³„ íŒŒì•…
        const wordMap = new Map(groupArr.map(w => [w.en.toLowerCase(), w]));
        let chipsHtml = groupArr.map(w => {
            const wen = w.en.toLowerCase();
            const synLinks = (w.nlp?.syn || []).filter(s => wordMap.has(s) && s !== wen).slice(0, 3);
            const antLinks = (w.nlp?.ant || []).filter(s => wordMap.has(s) && s !== wen).slice(0, 2);
            let relTags = '';
            if (synLinks.length) relTags += `<span class="text-[9px] text-purple-400 font-bold bg-purple-900/30 px-1.5 py-0.5 rounded-full border border-purple-700/50">â‰ˆ ${synLinks.join(', ')}</span> `;
            if (antLinks.length) relTags += `<span class="text-[9px] text-rose-400 font-bold bg-rose-900/30 px-1.5 py-0.5 rounded-full border border-rose-700/50">â†” ${antLinks.join(', ')}</span>`;
            return `<div class="flex flex-col gap-1 min-w-0">
                <span class="chip bg-gray-900 text-indigo-300 border border-gray-700 hover:bg-gray-800 cursor-pointer" onclick="openAnalysis(${w.id})">${w.en} <span class="text-[10px] text-gray-500 ml-1 font-bold">${w.ko}</span></span>
                ${relTags ? `<div class="flex flex-wrap gap-1 pl-1">${relTags}</div>` : ''}
            </div>`;
        }).join('');
        card.innerHTML = `
            <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-700">
                <h4 class="text-base font-black text-white truncate pr-2">${title}</h4>
                <span class="text-[10px] font-black text-indigo-400 bg-gray-800 px-2 py-1 rounded-full whitespace-nowrap border border-gray-700">${groupArr.length}ë‹¨ì–´</span>
            </div>
            <div class="flex gap-1.5 mb-3">${relSummary}</div>
            <div class="flex flex-wrap gap-3 items-start content-start flex-1">${chipsHtml}</div>`;
        return card;
    }

    const synantGrid = document.getElementById('nlp-synant-grid');
    synantGrid.innerHTML = synAntGroups.length ? '' : '<p class="text-gray-500 font-bold text-sm">ìœ ì˜ì–´/ë°˜ì˜ì–´ë¡œ ë¬¶ì´ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    synAntGroups.sort((a,b)=>b.length-a.length).forEach((g, idx) => { synantGrid.appendChild(buildSynAntCard(`ì˜ë¯¸ ì—°ê²°ë§ ${idx+1}`, g)); });
    loadingUI.classList.add('hidden'); loadingUI.classList.remove('flex');
    document.getElementById('group-container').classList.remove('hidden'); document.getElementById('group-container').classList.add('flex');
}

// ==============================
// ë¶„ì„ íƒ­ (ê¸°ì¡´ ìœ ì§€)
// ==============================
function openAnalysis(id){const w=words.find(x=>x.id===id);if(!w)return;switchTab('analysis');setTimeout(()=>selectAnalysisWord(w),60);}
function filterAnalysisWords(){renderAnalysisDD(document.getElementById('analysis-search').value.toLowerCase());}
function showAnalysisDropdown(){renderAnalysisDD(document.getElementById('analysis-search').value.toLowerCase());}
function renderAnalysisDD(q=''){const dd=document.getElementById('analysis-dropdown');const f=words.filter(w=>w.en.toLowerCase().includes(q)||w.ko.includes(q));if(!f.length)return dd.classList.add('hidden');dd.innerHTML=f.map(w=>`<button class="w-full text-left px-5 py-4 hover:bg-gray-800 flex justify-between transition-colors border-b border-gray-700" onclick="selectAnalysisWord(words.find(x=>x.id===${w.id}))"><span class="font-black text-white">${w.en}</span><span class="text-sm font-bold text-indigo-400">${w.ko}</span></button>`).join('');dd.classList.remove('hidden');}
function selectAnalysisWord(w){if(!w)return;analysisWord=w;document.getElementById('analysis-search').value='';document.getElementById('analysis-dropdown').classList.add('hidden');document.getElementById('analysis-word-en-display').textContent=w.en;document.getElementById('analysis-word-ko-display').textContent=w.ko;document.getElementById('analysis-selected-word').classList.remove('hidden');runAnalysis(w);}
function clearAnalysisWord(){analysisWord=null;document.getElementById('analysis-selected-word').classList.add('hidden');document.getElementById('analysis-result').classList.add('hidden');document.getElementById('analysis-loading').classList.add('hidden');document.getElementById('analysis-placeholder').classList.remove('hidden');}

// ë¶„ì„ ê²°ê³¼ ë©”ëª¨ë¦¬ ìºì‹œ (ê°™ì€ ì„¸ì…˜ ë‚´ ì¬ë°©ë¬¸ ì‹œ ì¦‰ì‹œ í‘œì‹œ)
const _analysisCache = new Map();

async function runAnalysis(w){
  document.getElementById('analysis-placeholder').classList.add('hidden');
  document.getElementById('analysis-result').classList.add('hidden');
  document.getElementById('analysis-loading').classList.remove('hidden');

  // â”€â”€ ìºì‹œ íˆíŠ¸: ë¡œë”© ì—†ì´ ì¦‰ì‹œ ë Œë” â”€â”€
  if (_analysisCache.has(w.en)) {
    document.getElementById('analysis-loading').classList.add('hidden');
    document.getElementById('analysis-result').classList.remove('hidden');
    const cached = _analysisCache.get(w.en);
    _renderAnalysisResult(w, ...cached);
    return;
  }

  const fetchDM = async (p) => {
    try {
      const r = await fetch(`https://api.datamuse.com/words?${p}`);
      return r.ok ? r.json() : [];
    } catch { return []; }
  };

  // â”€â”€ 1ë‹¨ê³„: í•µì‹¬ ë°ì´í„° â€” ì‚¬ì „(ì •ì˜/ì˜ˆë¬¸/ë°œìŒ) + ìœ ì˜ì–´/ë°˜ì˜ì–´ ë™ì‹œ ë¡œë“œ â”€â”€
  // ì „ëµ: Free Dictionary API(senseë³„ í’ë¶€í•œ syn/ant) + Datamuse rel_syn max=30 ë³‘í•©
  const [dictData, synExact, antExact] = await Promise.all([
    fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(w.en)}`)
      .then(r => r.ok ? r.json() : null)
      .then(d => Array.isArray(d) ? d[0] : null)
      .catch(() => null),
    fetchDM(`rel_syn=${encodeURIComponent(w.en)}&max=30`),   // WordNet ìœ ì˜ì–´ (max ì¦ê°€)
    fetchDM(`rel_ant=${encodeURIComponent(w.en)}&max=20`),   // WordNet ë°˜ì˜ì–´ (max ì¦ê°€)
  ]);

  // 1ë‹¨ê³„ ì¦‰ì‹œ í‘œì‹œ
  document.getElementById('analysis-loading').classList.add('hidden');
  document.getElementById('analysis-result').classList.remove('hidden');

  // â”€â”€ 2ë‹¨ê³„: ì—°ê´€ì–´/ì½œë¡œì¼€ì´ì…˜ (ë°±ê·¸ë¼ìš´ë“œ ë³‘ë ¬ ë¡œë“œ) â”€â”€
  const [relTrg, relSpc, relGen, colAdj, colNoun, colBefore, colAfter] = await Promise.all([
    fetchDM(`rel_trg=${encodeURIComponent(w.en)}&max=15`),   // ì—°ìƒì–´
    fetchDM(`rel_spc=${encodeURIComponent(w.en)}&max=10`),   // ìƒìœ„ ê°œë… (e.g. dog â†’ animal)
    fetchDM(`rel_gen=${encodeURIComponent(w.en)}&max=10`),   // í•˜ìœ„ ê°œë… (e.g. animal â†’ dog)
    fetchDM(`rel_jja=${encodeURIComponent(w.en)}&max=12`),   // ìˆ˜ì‹ í˜•ìš©ì‚¬ (e.g. ocean â†’ vast)
    fetchDM(`rel_jjb=${encodeURIComponent(w.en)}&max=12`),   // í˜•ìš©ì‚¬â†’ëª…ì‚¬ (e.g. happy â†’ person)
    fetchDM(`rel_bga=${encodeURIComponent(w.en)}&max=10`),   // bigram ì• ë‹¨ì–´
    fetchDM(`rel_bgb=${encodeURIComponent(w.en)}&max=10`),   // bigram ë’¤ ë‹¨ì–´
  ]);

  const cacheVal = [dictData, synExact, antExact, relTrg, relSpc, relGen, colAdj, colNoun, colBefore, colAfter];
  _analysisCache.set(w.en, cacheVal);
  _renderAnalysisResult(w, ...cacheVal);
}

async function _renderAnalysisResult(w, dictData, synExact, antExact, relTrg, relSpc, relGen, colAdj, colNoun, colBefore, colAfter) {
  document.getElementById('ar-word').textContent=w.en;
  let dictSyns=[], dictAnts=[];
  const examplesEl = document.getElementById('ar-examples');
  examplesEl.innerHTML='';
  if(dictData){
    document.getElementById('ar-definition').textContent=dictData.meanings?.[0]?.definitions?.[0]?.definition||'ì‚¬ì „ ì •ë³´ ì—†ìŒ';
    document.getElementById('ar-phonetic').textContent=dictData.phonetics?.find(p=>p.text)?.text||'';
    const aUrl = dictData.phonetics?.find(p=>p.audio)?.audio||null;
    const aBtn = document.getElementById('ar-audio-btn');
    aBtn.classList.remove('hidden');
    aBtn.innerHTML = aUrl ? 'ğŸ”Š <span class="hidden sm:inline">ì›ì–´ë¯¼ ë°œìŒ</span>' : 'ğŸ¤– <span class="hidden sm:inline">TTS ë°œìŒ</span>';
    aBtn.onclick = () => {
        if(aUrl) { new Audio(aUrl).play(); }
        else { const u=new SpeechSynthesisUtterance(w.en);u.lang='en-US';window.speechSynthesis.speak(u); }
    };
    const posSet=new Set();
    // â”€â”€ ê°œì„ : í’ˆì‚¬ ë ˆë²¨ + ì •ì˜ ë ˆë²¨ syn/ant ëª¨ë‘ ìˆ˜ì§‘ (ê¸°ì¡´: í’ˆì‚¬ ë ˆë²¨ë§Œ)
    dictData.meanings?.forEach(m=>{
        if(m.partOfSpeech) posSet.add(m.partOfSpeech);
        // í’ˆì‚¬ ë ˆë²¨
        if(m.synonyms?.length) dictSyns.push(...m.synonyms.map(s=>({word:s.toLowerCase()})));
        if(m.antonyms?.length) dictAnts.push(...m.antonyms.map(a=>({word:a.toLowerCase()})));
        // ì •ì˜ ë ˆë²¨ (ë” ë§ì€ syn/ant í¬í•¨)
        m.definitions?.forEach(d => {
            if(d.synonyms?.length) dictSyns.push(...d.synonyms.map(s=>({word:s.toLowerCase()})));
            if(d.antonyms?.length) dictAnts.push(...d.antonyms.map(a=>({word:a.toLowerCase()})));
        });
    });
    const posStr=Array.from(posSet).join(', ');
    document.getElementById('ar-partOfSpeech').textContent=posStr;
    document.getElementById('ar-partOfSpeech').style.display=posStr?'':'none';
    const allExamples=[];
    dictData.meanings?.forEach(m=>{m.definitions?.forEach(d=>{if(d.example&&allExamples.length<3)allExamples.push(d.example);});});
    if(allExamples.length){examplesEl.innerHTML=allExamples.map((ex,i)=>`<div class="flex gap-4 items-start bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-sm"><span class="flex-shrink-0 w-6 h-6 bg-indigo-600 text-white text-xs font-black rounded-full flex items-center justify-center mt-0.5">${i+1}</span><p class="text-base text-gray-200 italic leading-relaxed break-words font-bold">"${ex}"</p></div>`).join('');}
    else{examplesEl.innerHTML='<p class="text-sm text-gray-500 italic bg-gray-800 p-5 rounded-2xl font-bold">ì˜ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';}
  } else {
    document.getElementById('ar-definition').textContent='ì‚¬ì „ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    document.getElementById('ar-phonetic').textContent='';
    document.getElementById('ar-partOfSpeech').style.display='none';
    const aBtn=document.getElementById('ar-audio-btn');
    aBtn.classList.remove('hidden');aBtn.innerHTML='ğŸ¤– <span class="hidden sm:inline">TTS ë°œìŒ</span>';
    aBtn.onclick=()=>{const u=new SpeechSynthesisUtterance(w.en);u.lang='en-US';window.speechSynthesis.speak(u);};
    examplesEl.innerHTML='<p class="text-sm text-gray-500 font-bold">ì˜ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
  }
  const simRow=simMatrix[w.id]||{};
  const internals=words.filter(x=>x.id!==w.id).map(x=>({word:x,sim:simRow[x.id]||0})).filter(x=>x.sim>8).sort((a,b)=>b.sim-a.sim).slice(0,7);
  const intEl=document.getElementById('ar-internal-list');
  if(internals.length){
    intEl.innerHTML=internals.map(({word:iw,sim})=>{
      const pct=Math.round(sim),bar=pct>=SIM_DUP?'bg-amber-500':pct>=SIM_CONF?'bg-violet-500':'bg-indigo-500';
      const lbl=pct>=SIM_DUP?'<span class="text-[10px] bg-amber-900/50 text-amber-300 font-black px-2 py-0.5 rounded-full whitespace-nowrap border border-amber-600">âš ï¸ ì¤‘ë³µ</span>':pct>=SIM_CONF?'<span class="text-[10px] bg-violet-900/50 text-violet-300 font-black px-2 py-0.5 rounded-full whitespace-nowrap border border-violet-600">í˜¼ë™ ì£¼ì˜</span>':'';
      return `<div class="flex items-center gap-4 bg-gray-800 p-4 rounded-2xl border border-gray-700 shadow-sm"><div class="flex-1 min-w-0"><div class="flex items-center gap-2 flex-wrap mb-1.5"><span class="font-black text-lg text-white break-all">${iw.en}</span><span class="text-sm font-bold text-gray-400 truncate">${iw.ko}</span>${lbl}</div><div class="flex items-center gap-3"><div class="flex-1 bg-gray-900 rounded-full h-2 overflow-hidden border border-gray-700"><div class="${bar} h-full rounded-full transition-all duration-700" style="width:${pct}%"></div></div><span class="text-xs text-gray-400 font-mono w-8 text-right font-black">${pct}%</span></div></div></div>`;
    }).join('');
  } else {intEl.innerHTML='<div class="flex flex-col items-center justify-center h-full text-center p-6"><span class="text-4xl mb-3 opacity-50">ğŸ¤·â€â™‚ï¸</span><p class="text-sm text-gray-500 font-black">ë¹„ìŠ·í•œ ë‹¨ì–´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p></div>';}
  const existingEn=new Set(words.map(x=>x.en.toLowerCase()));
  const newCands=new Set();
  function renderChips(elId, items, cls){
    const el=document.getElementById(elId);
    if(!items.length){
      el.innerHTML='<span class="text-sm font-bold text-gray-400 italic">í•´ë‹¹ ë°ì´í„° ì—†ìŒ (ë‹¨ì–´ì— ë”°ë¼ API ë¯¸ì§€ì›)</span>';
      return;
    }
    el.innerHTML='';
    const frag = document.createDocumentFragment();
    items.forEach(item=>{
      const wordLower = item.word.toLowerCase();
      const inBook = existingEn.has(wordLower);
      if(!inBook) newCands.add(item.word);
      const span=document.createElement('span');
      // ë‹¨ì–´ì¥ ë‚´ ë‹¨ì–´ëŠ” ë” ë°ê³  ê°•ì¡°ëœ ìŠ¤íƒ€ì¼
      span.className = inBook ? `chip ${cls} ring-1 ring-indigo-400/50 font-black` : `chip ${cls}`;
      const inBookWord = words.find(x=>x.en.toLowerCase()===wordLower);
      const knownKo = inBookWord ? inBookWord.ko : null;
      // ë‹¨ì–´ì¥ ë‚´ ë‹¨ì–´: ğŸ“š ì•„ì´ì½˜ìœ¼ë¡œ ëª…í™•í•˜ê²Œ í‘œì‹œ
      const label = inBook ? `ğŸ“š ${item.word}` : item.word;
      span.appendChild(document.createTextNode(label));
      const tooltip=document.createElement('span');
      tooltip.className='chip-tooltip'+(knownKo?'':' loading');
      tooltip.textContent = knownKo || 'ëœ» ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      span.appendChild(tooltip);
      span.onclick = async () => {
          const found=words.find(x=>x.en.toLowerCase()===wordLower);
          if(found){selectAnalysisWord(found);}
          else{
              span.classList.add('force-tooltip');
              if(!knownKo && !span.dataset.fetched){
                span.dataset.fetched="true";
                tooltip.classList.remove('loading');
                tooltip.textContent='ë²ˆì—­ ì¤‘...';
                tooltip.textContent=await getTranslationSafe(item.word);
              }
              setTimeout(()=>span.classList.remove('force-tooltip'),3000);
          }
      };
      if(!knownKo){span.addEventListener('mouseenter',async()=>{if(span.dataset.fetched)return;span.dataset.fetched=true;tooltip.textContent=await getTranslationSafe(item.word);tooltip.classList.remove('loading');});}
      frag.appendChild(span);
    });
    el.appendChild(frag);
  }
  const mergeWords=(...arrays)=>{const map=new Map();arrays.flat().forEach(item=>{if(item&&item.word&&item.word.toLowerCase()!==w.en.toLowerCase()){map.set(item.word.toLowerCase(),item);}});return Array.from(map.values());};
  // synExact + ì‚¬ì „ ìœ ì˜ì–´ ë³‘í•© (ì •í™•ë„ ë†’ì€ ì†ŒìŠ¤ ìš°ì„ )
  renderChips('ar-synonyms', mergeWords(dictSyns, synExact).slice(0,20), 'chip-syn');
  // antExact + ì‚¬ì „ ë°˜ì˜ì–´ (ëª¨ë‘ WordNet ê¸°ë°˜ â†’ ì‹ ë¢°ë„ ë†’ìŒ)
  renderChips('ar-antonyms', mergeWords(dictAnts, antExact).slice(0,15), 'chip-ant');
  // ì—°ìƒì–´ + ìƒìœ„/í•˜ìœ„ ê°œë… (ì˜ë¯¸ë§ ê¸°ë°˜ ì—°ê´€ì–´)
  renderChips('ar-related', mergeWords(relTrg, relSpc, relGen).slice(0,20), 'chip-rel');
  // bigram ì½œë¡œì¼€ì´ì…˜ + í˜•ìš©ì‚¬-ëª…ì‚¬ ê´€ê³„ (ì‹¤ì œ ìš©ë¡€ ê¸°ë°˜)
  renderChips('ar-collocations', mergeWords(colBefore, colAfter, colAdj, colNoun).slice(0,20), 'chip-freq');
  const recs=[...newCands].slice(0,25);
  document.getElementById('ar-recommendations').innerHTML=recs.length?recs.map(x=>`<button class="chip chip-new" onclick="quickAdd('${x.replace(/'/g,"\\'")}')">+ ${x}</button>`).join(''):'<span class="text-sm font-bold text-gray-500">ì¶”ì²œí•  ìƒˆ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
  const scrollContainer=document.getElementById('analysis-result').parentElement;
  if(scrollContainer)scrollContainer.scrollTop=0;
} // end _renderAnalysisResult
function quickAdd(en){switchTab('manage');document.getElementById('input-en').value=en;document.getElementById('input-ko').focus();}

// ==============================
// í†µê³„
// ==============================
function renderStats() {
    const todayStr = new Date().toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' }).split('.').join('-').replace(/\s/g, '').replace(/-$/,'');
    const todayData = activityLog[todayStr] || { added: 0, tested: 0, quizzed: 0 };
    document.getElementById('stat-added').textContent = todayData.added || 0;
    document.getElementById('stat-tested').textContent = todayData.tested || 0;
    document.getElementById('stat-quizzed').textContent = todayData.quizzed || 0;
    let streak = 0, checkDate = new Date();
    while(true) {
        let dStr=checkDate.toLocaleDateString('ko-KR',{timeZone:'Asia/Seoul'}).split('.').join('-').replace(/\s/g,'').replace(/-$/,'');
        let dData=activityLog[dStr];
        if(dData&&(dData.added>0||dData.tested>0||dData.quizzed>0)){streak++;checkDate.setDate(checkDate.getDate()-1);}
        else{
            if(streak===0){checkDate.setDate(checkDate.getDate()-1);dStr=checkDate.toLocaleDateString('ko-KR',{timeZone:'Asia/Seoul'}).split('.').join('-').replace(/\s/g,'').replace(/-$/,'');dData=activityLog[dStr];if(dData&&(dData.added>0||dData.tested>0||dData.quizzed>0)){streak++;checkDate.setDate(checkDate.getDate()-1);continue;}}
            break;
        }
    }
    document.getElementById('stat-streak').innerHTML=`í˜„ì¬ <span class="text-emerald-400 font-black">${streak}ì¼ì§¸</span> ì—°ì† í•™ìŠµ ì¤‘! ğŸ”¥`;
    const grid=document.getElementById('grass-grid'); grid.innerHTML='';
    const totalDays=35, startDate=new Date(); startDate.setDate(startDate.getDate()-totalDays+1);
    for(let col=0;col<5;col++){
        const colDiv=document.createElement('div'); colDiv.className='flex flex-col gap-2';
        for(let row=0;row<7;row++){
            const currentObj=new Date(startDate); currentObj.setDate(startDate.getDate()+(col*7+row));
            const cStr=currentObj.toLocaleDateString('ko-KR',{timeZone:'Asia/Seoul'}).split('.').join('-').replace(/\s/g,'').replace(/-$/,'');
            const aData=activityLog[cStr]; const totalAction=aData?(aData.added||0)+(aData.tested||0)+(aData.quizzed||0):0;
            let colorClass='grass-0';
            if(totalAction>=30)colorClass='grass-4';else if(totalAction>=15)colorClass='grass-3';else if(totalAction>=5)colorClass='grass-2';else if(totalAction>=1)colorClass='grass-1';
            const box=document.createElement('div');
            box.className=`w-4 h-4 sm:w-5 sm:h-5 rounded-md ${colorClass} transition-all hover:scale-125 cursor-help relative group z-10`;
            const tooltip=document.createElement('div');
            tooltip.className='absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-gray-900 text-white font-black text-[10px] px-3 py-1.5 rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none border border-gray-700 shadow-xl';
            tooltip.textContent=`${cStr}: ${totalAction} í™œë™`;
            box.appendChild(tooltip); colDiv.appendChild(box);
        }
        grid.appendChild(colDiv);
    }
}
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDlMAr0qMwr3uRL_bodm8gkyewo85OlTlc",
    authDomain: "myvocaapp-d418d.firebaseapp.com",
    projectId: "myvocaapp-d418d",
    storageBucket: "myvocaapp-d418d.firebasestorage.app",
    messagingSenderId: "841954793233",
    appId: "1:841954793233:web:2748be6eb03308e0895eb0",
    measurementId: "G-5HJ2VLZHHF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let isInitialCloudLoad = true;
  let unsubscribeSnapshot = null;
  const cloudDot = document.getElementById('cloud-dot');
  const cloudStatusText = document.getElementById('cloud-status-text');
  const updateCloudStatus = (color, text) => {
      cloudDot.className = `w-2 h-2 rounded-full bg-${color}-500 transition-colors duration-300`;
      cloudStatusText.textContent = text;
  };

  signInAnonymously(auth).catch((error) => {
      console.error("ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
      updateCloudStatus('rose', 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
      if (error.code === 'auth/operation-not-allowed') { window.showToast("Firebase ìµëª… ë¡œê·¸ì¸ì„ ì¼œì£¼ì„¸ìš”!", "error"); }
      else { window.showToast("í´ë¼ìš°ë“œ ì—°ê²° ì‹¤íŒ¨: " + error.message, "error"); }
  });

  onAuthStateChanged(auth, (user) => { if (user) { setupRealtimeSync(); } });

  function setupRealtimeSync() {
      updateCloudStatus('amber', 'ë™ê¸°í™” ì—°ê²° ì¤‘...');
      const docRef = doc(db, 'shared_wordbook', 'my_private_data');
      if (unsubscribeSnapshot) unsubscribeSnapshot();
      unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
          updateCloudStatus('emerald', 'ë™ê¸°í™” ì™„ë£Œ â˜ï¸');
          if (docSnap.exists()) {
              const data = docSnap.data();
              if(data.wordsList){
                  try{
                      const parsedData=JSON.parse(data.wordsList);
                      window.updateFromCloud(parsedData);
                      if(isInitialCloudLoad){window.showToast("â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ!");}
                  }catch(e){console.error("ë°ì´í„° íŒŒì‹± ì—ëŸ¬",e);}
              }
          } else {
              if(window.words&&window.words.length>0){window.triggerCloudSave({words:window.words,activityLog:window.activityLog});window.showToast("â˜ï¸ ê¸°ì¡´ ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œì— ë°±ì—…í–ˆìŠµë‹ˆë‹¤.");}
          }
          isInitialCloudLoad=false;
      }, (error) => { console.error("ë™ê¸°í™” ìˆ˜ì‹  ì—ëŸ¬:", error); updateCloudStatus('rose', 'ì˜¤í”„ë¼ì¸ (ì—ëŸ¬)'); });
  }

  window.triggerCloudSave = (dataObj) => {
      updateCloudStatus('indigo', 'ì €ì¥ ì¤‘... â˜ï¸');
      const docRef = doc(db, 'shared_wordbook', 'my_private_data');
      setDoc(docRef, { wordsList: JSON.stringify(dataObj) })
        .then(() => { updateCloudStatus('emerald', 'ë™ê¸°í™” ì™„ë£Œ â˜ï¸'); })
        .catch(error => { console.error("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨:", error); updateCloudStatus('rose', 'ì €ì¥ ì‹¤íŒ¨'); });
  };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SRS ì—”ì§„ â€” Anki SM-2 ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
// ê° ë‹¨ì–´ì— srs: { interval, ease, due, reps, lapses } ì €ì¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SRS_GOAL = 2000;  // 2ì£¼ ëª©í‘œ ë‹¨ì–´ ìˆ˜
const SRS_DAYS = 14;    // 2ì£¼
const SRS_NEW_PER_DAY = Math.ceil(SRS_GOAL / SRS_DAYS); // ì•½ 143ê°œ (í˜„ì‹¤ì  ì¡°ì •ì€ ì‚¬ìš©ì ëª«)
const EASE_DEFAULT = 2.5;
const EASE_MIN = 1.3;

function srsToday() {
    // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ (íƒ€ì„ì¡´ ë³´ì •)
    return new Date().toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' })
        .split('.').filter(Boolean).map(s => s.trim().padStart(2, '0')).join('-');
}

function srsDaysFromNow(n) {
    const d = new Date();
    d.setDate(d.getDate() + n);
    return d.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' })
        .split('.').filter(Boolean).map(s => s.trim().padStart(2, '0')).join('-');
}

// SM-2 ì•Œê³ ë¦¬ì¦˜: grade 1~4 ì…ë ¥ â†’ ë‹¤ìŒ interval ê³„ì‚°
// grade 1: ì „í˜€ ëª¨ë¦„ (reset), 2: ì–´ë ´í’‹ì´, 3: ì•Œì•˜ìŒ, 4: ì™„ë²½
function sm2Next(srs, grade) {
    let { interval = 0, ease = EASE_DEFAULT, reps = 0, lapses = 0 } = srs || {};
    ease = Math.max(EASE_MIN, ease);

    if (grade === 1) {
        // ì™„ì „ ì‹¤íŒ¨ â€” ì²˜ìŒë¶€í„° ë‹¤ì‹œ
        lapses++;
        interval = 0;
        ease = Math.max(EASE_MIN, ease - 0.2);
        return { interval: 0, ease, reps: 0, lapses, due: srsDaysFromNow(0), minutesDelay: 10 };
    }

    if (grade === 2) {
        // ì–´ë ´í’‹ì´ â€” 1ì¼ í›„
        interval = 1;
        ease = Math.max(EASE_MIN, ease - 0.15);
        reps++;
        return { interval, ease, reps, lapses, due: srsDaysFromNow(1) };
    }

    // grade 3 or 4
    if (reps === 0) interval = 1;
    else if (reps === 1) interval = 6;
    else interval = Math.round(interval * ease);

    if (grade === 4) ease = Math.min(3.0, ease + 0.15);
    else ease = Math.max(EASE_MIN, ease - 0.05); // grade 3: slight penalty

    reps++;
    return { interval, ease, reps, lapses: lapses || 0, due: srsDaysFromNow(interval) };
}

// ì˜¤ëŠ˜ ë³µìŠµí•´ì•¼ í•  ë‹¨ì–´ë“¤
function getSRSDue() {
    const today = srsToday();
    return words.filter(w => w.srs && w.srs.due && w.srs.due <= today);
}

// SRSì— ì•„ì§ ë“±ë¡ ì•ˆ ëœ ì‹ ê·œ ë‹¨ì–´ë“¤
function getSRSNew() {
    return words.filter(w => !w.srs || !w.srs.due);
}

// ëŒ€ì‹œë³´ë“œ ë Œë”
function renderSRSDashboard() {
    if (!Array.isArray(words)) return;
    const due = getSRSDue();
    const newW = getSRSNew();
    const learning = words.filter(w => w.srs && w.srs.due);
    const today = srsToday();

    document.getElementById('srs-count-due').textContent = due.length;
    document.getElementById('srs-count-new').textContent = Math.min(newW.length, SRS_NEW_PER_DAY);
    document.getElementById('srs-count-total').textContent = learning.length;

    // ëª©í‘œ ì§„í–‰ë¥ 
    const pct = Math.min(100, Math.round(learning.length / SRS_GOAL * 100));
    document.getElementById('srs-goal-pct').textContent = pct + '%';
    document.getElementById('srs-goal-bar').style.width = pct + '%';
    document.getElementById('srs-daily-target').textContent = SRS_NEW_PER_DAY;
    document.getElementById('srs-goal-label').innerHTML =
        `ëª©í‘œ: <span class="text-white">${SRS_GOAL}ê°œ</span> Â· í•™ìŠµì¤‘: <span class="text-indigo-300">${learning.length}ê°œ</span> Â· ì˜¤ëŠ˜ ê¶Œì¥ ì‹ ê·œ: <span class="text-indigo-400">${SRS_NEW_PER_DAY}</span>ê°œ`;

    // ë±ƒì§€
    const badge = document.getElementById('srs-due-badge');
    if (due.length > 0) { badge.textContent = due.length > 99 ? '99+' : due.length; badge.classList.remove('hidden'); }
    else badge.classList.add('hidden');

    // ë²„íŠ¼ ìƒíƒœ
    document.getElementById('srs-btn-due').disabled = due.length === 0;

    // ë‹¤ê°€ì˜¤ëŠ” ìŠ¤ì¼€ì¤„ (3ì¼ì¹˜)
    const upcoming = document.getElementById('srs-upcoming');
    const schedule = [];
    for (let i = 0; i <= 3; i++) {
        const d = srsDaysFromNow(i);
        const cnt = i === 0 ? due.length : words.filter(w => w.srs && w.srs.due === d).length;
        schedule.push({ label: i === 0 ? 'ì˜¤ëŠ˜' : i === 1 ? 'ë‚´ì¼' : `${i}ì¼ í›„`, count: cnt, date: d });
    }
    upcoming.innerHTML = schedule.map(s =>
        `<div class="flex justify-between items-center py-2 border-b border-gray-800 last:border-0">
            <span class="text-gray-400 font-bold">${s.label} <span class="text-gray-600 text-xs">${s.date}</span></span>
            <span class="font-black ${s.count > 0 ? 'text-indigo-300' : 'text-gray-600'}">${s.count}ê°œ</span>
        </div>`
    ).join('');
}

// SRS ì„¸ì…˜ ìƒíƒœ
let srsQueue = [], srsIdx = 0, srsMode = 'due', srsCorrect = 0, srsWrong = 0, srsCurrentWord = null;

function startSRS(mode) {
    if (!words || !words.length) return showToast('ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
    srsMode = mode;
    if (mode === 'due') {
        srsQueue = shuffle(getSRSDue());
    } else {
        // ì‹ ê·œ: í•˜ë£¨ì¹˜ë§Œ
        srsQueue = getSRSNew().slice(0, SRS_NEW_PER_DAY);
    }
    if (!srsQueue.length) {
        return showToast(mode === 'due' ? 'ì˜¤ëŠ˜ ë³µìŠµí•  ë‹¨ì–´ê°€ ì—†ì–´ìš”! ì‹ ê·œ ì•”ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.' : 'ì‹ ê·œ ë‹¨ì–´ê°€ ì—†ì–´ìš”!', 'info');
    }
    srsIdx = 0; srsCorrect = 0; srsWrong = 0;
    document.getElementById('srs-dashboard').classList.add('hidden');
    document.getElementById('srs-complete').classList.add('hidden');
    document.getElementById('srs-session').classList.remove('hidden');
    document.getElementById('srs-session-type').textContent = mode === 'due' ? 'ğŸ”¥ ë³µìŠµ' : 'âœ¨ ì‹ ê·œ';
    document.getElementById('srs-session-total').textContent = srsQueue.length;
    loadSRSCard();
}

function loadSRSCard() {
    if (srsIdx >= srsQueue.length) { showSRSComplete(); return; }
    srsCurrentWord = srsQueue[srsIdx];
    const w = srsCurrentWord;
    const srs = w.srs || {};

    document.getElementById('srs-session-idx').textContent = srsIdx + 1;
    document.getElementById('srs-card-en').textContent = w.en;
    document.getElementById('srs-card-phonetic').textContent = '';
    document.getElementById('srs-card-ko').textContent = w.ko;
    document.getElementById('srs-card-hint').textContent =
        w.nlp?.syn?.slice(0,3).join(', ') ? `ìœ ì˜ì–´: ${w.nlp.syn.slice(0,3).join(', ')}` : '';

    // ì¸í„°ë²Œ ë±ƒì§€
    const badge = document.getElementById('srs-interval-badge');
    if (srs.reps > 0) {
        badge.textContent = `${srs.interval || 0}ì¼ ê°„ê²© Â· ${srs.reps}íšŒ`;
        badge.classList.remove('hidden');
    } else {
        badge.textContent = 'ì‹ ê·œ';
        badge.classList.remove('hidden');
    }

    // ë‹¤ìŒ gradeë³„ ì˜ˆìƒ ì¸í„°ë²Œ ë¯¸ë¦¬ë³´ê¸°
    const g3next = sm2Next(srs, 3);
    const g4next = sm2Next(srs, 4);
    document.getElementById('srs-grade3-days').textContent = g3next.interval > 0 ? `+${g3next.interval}ì¼` : '+1ì¼';
    document.getElementById('srs-grade4-days').textContent = g4next.interval > 0 ? `+${g4next.interval}ì¼` : '+6ì¼';

    // ì¹´ë“œ ì´ˆê¸°í™”
    document.getElementById('srs-card-answer').classList.add('hidden');
    document.getElementById('srs-reveal-btn').classList.remove('hidden');
    document.getElementById('srs-grade-btns').classList.add('hidden');
}

function srsReveal() {
    document.getElementById('srs-card-answer').classList.remove('hidden');
    document.getElementById('srs-reveal-btn').classList.add('hidden');
    document.getElementById('srs-grade-btns').classList.remove('hidden');
}

function gradeCard(grade) {
    const w = srsCurrentWord;
    const idx = words.findIndex(x => x.id === w.id);
    if (idx !== -1) {
        const newSrs = sm2Next(words[idx].srs || {}, grade);
        words[idx].srs = newSrs;
        saveData({ skipRender: true });
    }

    if (grade >= 3) srsCorrect++; else srsWrong++;
    srsIdx++;

    // ì ê¹ í”¼ë“œë°± í›„ ë‹¤ìŒ ì¹´ë“œ
    setTimeout(loadSRSCard, grade <= 2 ? 300 : 200);
}

function showSRSComplete() {
    document.getElementById('srs-session').classList.add('hidden');
    document.getElementById('srs-complete').classList.remove('hidden');
    const total = srsCorrect + srsWrong;
    const acc = total > 0 ? Math.round(srsCorrect / total * 100) : 0;
    document.getElementById('srs-done-title').textContent = acc >= 80 ? 'í›Œë¥­í•´ìš”! ğŸ‰' : acc >= 60 ? 'ì˜ í–ˆì–´ìš”! ğŸ‘' : 'ê³„ì† ì—°ìŠµí•´ìš”! ğŸ’ª';
    document.getElementById('srs-done-subtitle').textContent = `${total}ê°œ ì¤‘ ${srsCorrect}ê°œ ì •ë‹µ Â· ì •í™•ë„ ${acc}%`;
    document.getElementById('srs-done-emoji').textContent = acc >= 80 ? 'ğŸ†' : acc >= 60 ? 'ğŸ‰' : 'ğŸ’ª';
    document.getElementById('srs-done-correct').textContent = srsCorrect;
    document.getElementById('srs-done-wrong').textContent = srsWrong;
    scheduleRender();
}

function exitSRS() {
    document.getElementById('srs-session').classList.add('hidden');
    document.getElementById('srs-complete').classList.add('hidden');
    document.getElementById('srs-dashboard').classList.remove('hidden');
    renderSRSDashboard();
}

// SRS íƒ­ ì§„ì… ì‹œ ëŒ€ì‹œë³´ë“œ ê°±ì‹ 
const _origSwitchTab = switchTab;
// (switchTabì€ ì•„ë˜ì—ì„œ í›„í‚¹)



// ì´ˆê¸° SRS ë±ƒì§€ ê°±ì‹  (í˜ì´ì§€ ë¡œë“œ í›„)
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const due = getSRSDue();
        const badge = document.getElementById('srs-due-badge');
        if (badge && due.length > 0) { badge.textContent = due.length > 99 ? '99+' : due.length; badge.classList.remove('hidden'); }
    }, 500);
});

</script>
</body>
</html>