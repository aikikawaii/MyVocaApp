<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .fade-in{animation:fadeIn .3s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .no-scrollbar::-webkit-scrollbar{display:none}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  .game-btn{transition:all .2s}
  .game-btn:active{transform:scale(.97)}
  
  /* ì•¼ê°„ ëª¨ë“œ ì „ìš© ì •ë‹µ/ì˜¤ë‹µ ì»¬ëŸ¬ */
  .correct-answer{background:#059669!important;color:#fff!important;border-color:#059669!important}
  .wrong-answer{background:#e11d48!important;color:#fff!important;border-color:#e11d48!important}
  
  /* ì•¼ê°„ ëª¨ë“œ ì „ìš© ì¹©(Chip) ì»¬ëŸ¬ */
  .chip{display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:9999px;
        font-size:.78rem;font-weight:700;cursor:pointer;transition:all .15s;border:1px solid transparent;
        position:relative}
  .chip:hover{filter:brightness(1.15);transform:scale(1.04)}
  .chip-syn{background:#4c1d95;color:#ddd6fe;border-color:#5b21b6}
  .chip-ant{background:#7f1d1d;color:#fecaca;border-color:#991b1b}
  .chip-rel{background:#064e3b;color:#a7f3d0;border-color:#065f46}
  .chip-freq{background:#713f12;color:#fef08a;border-color:#854d0e}
  .chip-new{background:#0c4a6e;color:#bae6fd;border-color:#075985}

  /* í˜¸ë²„ íˆ´íŒ */
  .chip-tooltip{
    position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
    background:#e0e7ff;color:#312e81;font-size:.72rem;font-weight:700;white-space:nowrap;
    padding:4px 10px;border-radius:8px;pointer-events:none;
    opacity:0;transition:opacity .15s;z-index:50;letter-spacing:.01em;
    box-shadow:0 4px 12px rgba(0,0,0,.5);
  }
  .chip-tooltip::after{
    content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);
    border:5px solid transparent;border-top-color:#e0e7ff;
  }
  .chip:hover .chip-tooltip, .chip.force-tooltip .chip-tooltip {opacity:1;}
  .chip-tooltip.loading{color:#818cf8;}
  
  /* skeleton (Dark mode) */
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .skeleton{animation:pulse 1.5s infinite;background:#374151;border-radius:8px}
  .sim-bar{height:6px;border-radius:9999px;transition:width .5s ease}
  
  /* fill blank (Dark mode) */
  .fill-blank{display:inline-block;min-width:80px;border-bottom:3px solid #818cf8;
              color:#818cf8;font-weight:900;text-align:center;padding:0 6px;letter-spacing:.05em}
  .fill-opt{transition:all .2s;}
  .fill-opt.correct{background:#064e3b!important;border-color:#10b981!important;color:#a7f3d0!important}
  .fill-opt.wrong{background:#7f1d1d!important;border-color:#f43f5e!important;color:#fecaca!important}

  /* í…ìŠ¤íŠ¸ í¬ê¸° ìë™ ì¡°ì ˆì„ ìœ„í•œ ê¸°ì¤€ì  ì„¤ì • */
  .origin-left { transform-origin: left center; }
  
  /* Select ë°•ìŠ¤ ê°€ìš´ë° ì •ë ¬ (í˜ì´ì§€ ìŠ¤í¬ë¡¤ ê¸°ëŠ¥) */
  .text-center-last { text-align-last: center; }
</style>
</head>
<body class="bg-black text-gray-200 font-sans h-screen w-screen flex items-center justify-center p-2 sm:p-6 overflow-hidden">
<!-- í™”ë©´ì„ ë„“ê²Œ ì“°ê¸° ìœ„í•´ max-w-7xl, max-h-[96vh] ë¡œ í™•ì¥ -->
<div class="w-full max-w-7xl h-full max-h-[96vh] min-h-[700px] bg-gray-900 shadow-[0_0_40px_rgba(0,0,0,0.8)] rounded-3xl flex flex-col overflow-hidden border border-gray-800 relative">

<!-- í—¤ë” -->
<header class="bg-indigo-900 text-gray-100 px-5 py-4 flex justify-between items-center shadow-lg z-10 flex-shrink-0 relative border-b border-indigo-800/50">
  <button onclick="openInfoModal()" class="text-indigo-300 hover:text-white transition-colors flex-shrink-0" title="í”„ë¡œê·¸ë¨ ì„¤ëª…ì„œ ë³´ê¸°">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  </button>
  <h1 class="text-xl font-black tracking-wide absolute left-1/2 -translate-x-1/2 text-indigo-100">ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥ ğŸ“š</h1>
  <div class="w-6"></div> <!-- ë ˆì´ì•„ì›ƒ ê· í˜•ìš© ë¹ˆ ê³µê°„ -->
</header>

<!-- íƒ­ (Dark Mode) -->
<div class="flex border-b border-gray-800 bg-gray-900 z-10 flex-shrink-0" style="font-size:14px">
  <button id="tab-manage"   class="flex-1 py-3.5 font-bold text-indigo-400 border-b-4 border-indigo-500 bg-gray-800 transition-colors" onclick="switchTab('manage')">ë‹¨ì–´ ğŸ“</button>
  <button id="tab-test"     class="flex-1 py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800 hover:text-gray-300" onclick="switchTab('test')">í•™ìŠµ ğŸ²</button>
  <button id="tab-quiz"     class="flex-1 py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800 hover:text-gray-300" onclick="switchTab('quiz')">ì‚¬ì§€ì„ ë‹¤ ğŸ¯</button>
  <button id="tab-fill"     class="flex-1 py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800 hover:text-gray-300" onclick="switchTab('fill')">ë¹ˆì¹¸ âœï¸</button>
  <button id="tab-analysis" class="flex-1 py-3.5 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800 hover:text-gray-300" onclick="switchTab('analysis')">ë¶„ì„ ğŸ”¬</button>
</div>

<!-- ===== 1. ê´€ë¦¬ ===== -->
<div id="view-manage" class="flex-1 flex flex-col p-4 sm:p-6 overflow-hidden fade-in bg-black">
  <div class="bg-gray-800 p-4 sm:p-5 rounded-2xl mb-4 flex-shrink-0 shadow-sm border border-gray-700">
    <div class="flex flex-col sm:flex-row gap-4">
      <input id="input-en" type="text" placeholder="ì˜ì–´ ë‹¨ì–´ (ì˜ˆ: Apple)" class="flex-1 border border-gray-600 rounded-xl p-3.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-900 focus:bg-black text-gray-100 placeholder-gray-500 transition-all font-bold">
      <input id="input-ko" type="text" placeholder="í•œêµ­ì–´ ëœ» (ì˜ˆ: ì‚¬ê³¼)" class="flex-1 border border-gray-600 rounded-xl p-3.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-900 focus:bg-black text-gray-100 placeholder-gray-500 transition-all" onkeypress="if(event.key==='Enter')addWord()">
      <button onclick="addWord()" class="bg-indigo-600 text-white font-bold py-3.5 px-8 rounded-xl hover:bg-indigo-500 active:scale-95 transition-all shadow-md whitespace-nowrap">ë‹¨ì–´ ì¶”ê°€í•˜ê¸° â•</button>
    </div>
  </div>
  
  <div class="flex flex-col sm:flex-row justify-between items-center mb-5 gap-4 text-sm px-2 flex-shrink-0">
    <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start">
      <span class="font-semibold text-gray-400 text-base whitespace-nowrap">ì´ <span id="word-count" class="text-indigo-400 font-black text-lg">0</span>ë‹¨ì–´</span>
      
      <!-- â˜ï¸ í´ë¼ìš°ë“œ ìƒíƒœ í‘œì‹œê¸° -->
      <div id="cloud-status" class="text-[11px] font-bold text-gray-400 bg-gray-900 border border-gray-700 shadow-sm px-3 py-1.5 rounded-full flex items-center gap-2 cursor-help transition-colors" title="í´ë¼ìš°ë“œ ë™ê¸°í™” ìƒíƒœ">
        <span class="w-2 h-2 rounded-full bg-gray-600 transition-colors duration-300 shadow-[0_0_5px_currentColor]" id="cloud-dot"></span>
        <span id="cloud-status-text">ë¡œì»¬ ì—°ê²° ì¤‘...</span>
      </div>

      <select id="sort-select" onchange="currentPage=1;renderWords()" class="bg-gray-900 border border-gray-700 text-gray-300 py-1.5 px-3 rounded-lg focus:outline-none focus:border-indigo-500 font-medium cursor-pointer shadow-sm">
        <option value="newest">ìµœì‹ ìˆœ</option>
        <option value="wrongCount">ì˜¤ë‹µìˆœ</option>
      </select>
    </div>
    <div class="relative w-full sm:max-w-sm flex-1">
      <input id="search-manage" type="text" placeholder="ì…ë ¥í•œ ë‹¨ì–´ ì°¾ê¸°..." oninput="currentPage=1;renderWords()" class="w-full border border-gray-700 rounded-xl py-2.5 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-900 text-gray-200 placeholder-gray-500 shadow-sm transition-all text-sm">
      <span class="absolute left-3.5 top-3 text-gray-500 text-base">ğŸ”</span>
    </div>
    <div class="flex gap-2 w-full sm:w-auto justify-end">
      <button onclick="exportData()" class="text-indigo-300 bg-indigo-900/40 border border-indigo-800/50 px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-900/70 transition-colors whitespace-nowrap">ë‚´ë³´ë‚´ê¸° ğŸ“¤</button>
      <button onclick="document.getElementById('file-upload').click()" class="text-emerald-300 bg-emerald-900/40 border border-emerald-800/50 px-4 py-2 rounded-xl text-sm font-bold hover:bg-emerald-900/70 transition-colors whitespace-nowrap">ë¶ˆëŸ¬ì˜¤ê¸° ğŸ“¥</button>
      <input type="file" id="file-upload" class="hidden" accept=".json" onchange="importData(event)">
      <button onclick="confirmClearAll()" class="text-rose-300 bg-rose-900/40 border border-rose-800/50 px-4 py-2 rounded-xl text-sm font-bold hover:bg-rose-900/70 transition-colors whitespace-nowrap">ì „ì²´ ì‚­ì œ ğŸ—‘ï¸</button>
    </div>
  </div>
  
  <ul id="word-list" class="flex-1 overflow-y-auto no-scrollbar grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-2 content-start px-1"></ul>
  
  <div id="pagination-controls" class="flex justify-between items-center pt-5 border-t border-gray-800 hidden flex-shrink-0 mt-2">
    <button onclick="changePage(-1)" id="btn-prev" class="px-6 py-2.5 bg-gray-800 text-indigo-400 rounded-xl text-sm font-bold border border-gray-700 hover:bg-gray-700 disabled:opacity-30 disabled:hover:bg-gray-800 transition-all" disabled>ì´ì „</button>
    
    <!-- í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ UIë¡œ í˜ì´ì§€ ì´ë™í•  ìˆ˜ ìˆë„ë¡ select ìš”ì†Œë¡œ ë³€ê²½ -->
    <select id="page-select" onchange="jumpToPage(this.value)" title="í˜ì´ì§€ ì´ë™" class="appearance-none text-base text-gray-400 font-bold bg-gray-900 px-6 py-2 rounded-full shadow-inner border border-gray-800 hover:text-indigo-300 hover:border-indigo-500/50 transition-all cursor-pointer focus:outline-none text-center-last">
      <option value="1">1 / 1</option>
    </select>

    <button onclick="changePage(1)"  id="btn-next" class="px-6 py-2.5 bg-gray-800 text-indigo-400 rounded-xl text-sm font-bold border border-gray-700 hover:bg-gray-700 disabled:opacity-30 disabled:hover:bg-gray-800 transition-all">ë‹¤ìŒ</button>
  </div>
</div>

<!-- ===== 2. í•™ìŠµ ===== -->
<div id="view-test" class="flex-1 flex flex-col p-6 hidden bg-black overflow-y-auto no-scrollbar">
  <div id="test-intro" class="flex-1 flex flex-col items-center justify-center fade-in">
    <div class="bg-gray-800 p-10 rounded-[2.5rem] shadow-lg border border-gray-700 w-full max-w-2xl text-center">
      <div class="text-6xl mb-6">ğŸ§ </div>
      <h2 class="text-3xl font-bold mb-3 text-gray-100">ëœë¤ í”Œë˜ì‹œì¹´ë“œ</h2>
      <p class="text-gray-400 mb-10 text-base">ë‹¨ì–´ë¥¼ ë³´ê³  ëœ»ì„ ë§í˜€ë³´ì„¸ìš”.</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="startTest('all')"   class="flex-1 bg-indigo-600 text-white font-bold py-5 rounded-2xl hover:bg-indigo-500 active:scale-95 shadow-md text-lg transition-all">ì „ì²´ ë³µìŠµ ğŸš€</button>
        <button onclick="startTest('wrong')" class="flex-1 bg-gray-700 text-rose-400 font-bold py-5 rounded-2xl hover:bg-gray-600 active:scale-95 border border-rose-900/50 text-lg transition-all">í‹€ë¦° ë‹¨ì–´ ë³µìŠµ ğŸ¯</button>
      </div>
    </div>
  </div>
  
  <div id="test-active" class="flex-1 flex flex-col hidden fade-in max-w-4xl mx-auto w-full h-full">
    <div class="flex justify-between mb-6 flex-shrink-0">
      <div class="bg-gray-800 border border-gray-700 px-5 py-2.5 rounded-full shadow-sm text-base font-bold text-gray-400">ì§„í–‰ <span id="test-progress" class="text-indigo-400">1/10</span></div>
      <div class="bg-gray-800 border border-gray-700 px-5 py-2.5 rounded-full shadow-sm text-base font-bold text-gray-400">âœ… <span id="test-score" class="text-emerald-400">0</span></div>
    </div>
    
    <div class="flex-1 bg-gray-900 rounded-[2.5rem] shadow-2xl border-4 border-gray-800 flex flex-col items-center justify-center p-10 mb-6 text-center relative min-h-[300px]">
      <h2 id="test-word-en" class="text-5xl sm:text-7xl font-black text-gray-100 mb-10 break-all px-4 tracking-tight">Apple</h2>
      <div class="h-28 flex items-center justify-center w-full">
        <button id="btn-reveal" onclick="revealAnswer()" class="bg-gray-800 text-gray-300 font-bold text-lg px-12 py-4 rounded-full hover:bg-gray-700 border border-gray-700 transition-colors shadow-lg">ì •ë‹µ í™•ì¸ ğŸ‘€</button>
        <p id="test-word-ko" class="text-4xl sm:text-5xl font-bold text-indigo-400 hidden fade-in break-words px-4">ì‚¬ê³¼</p>
      </div>
    </div>
    
    <div id="test-actions" class="flex gap-6 hidden pb-4 flex-shrink-0 h-28">
      <button onclick="markAnswer(false)" class="flex-1 bg-rose-900/40 text-rose-400 rounded-[2rem] border border-rose-800/50 font-bold text-xl hover:bg-rose-900/60 active:scale-95 flex items-center justify-center gap-3 shadow-md transition-all"><span class="text-3xl">âŒ</span>ëª°ëì–´ìš”</button>
      <button onclick="markAnswer(true)"  class="flex-1 bg-emerald-900/40 text-emerald-400 rounded-[2rem] border border-emerald-800/50 font-bold text-xl hover:bg-emerald-900/60 active:scale-95 flex items-center justify-center gap-3 shadow-md transition-all"><span class="text-3xl">â­•</span>ì•Œì•˜ì–´ìš”</button>
    </div>
  </div>
  
  <div id="test-result" class="flex-1 flex flex-col items-center justify-center hidden fade-in">
    <div class="bg-gray-800 p-10 rounded-[2.5rem] shadow-2xl text-center border border-gray-700 w-full max-w-xl">
      <div class="text-7xl mb-6">ğŸ‰</div>
      <h2 class="text-4xl font-black mb-8 text-gray-100">í•™ìŠµ ì™„ë£Œ!</h2>
      <button onclick="resetTestView()" class="w-full bg-indigo-600 text-white font-bold py-5 text-lg rounded-2xl hover:bg-indigo-500 active:scale-95 shadow-md transition-all">ëŒì•„ê°€ê¸°</button>
    </div>
  </div>
</div>

<!-- ===== 3. ì‚¬ì§€ì„ ë‹¤ ===== -->
<div id="view-quiz" class="flex-1 flex flex-col p-6 hidden bg-black overflow-y-auto no-scrollbar">
  <div id="quiz-intro" class="flex-1 flex flex-col items-center justify-center fade-in">
    <div class="bg-gray-800 p-10 rounded-[2.5rem] shadow-lg text-center border border-gray-700 w-full max-w-2xl">
      <div class="text-6xl mb-6">ğŸ¯</div>
      <h2 class="text-3xl font-bold mb-3 text-gray-100">ë¬´í•œ ì‚¬ì§€ì„ ë‹¤</h2>
      <p class="text-gray-400 mb-10 text-base">ì˜ë¯¸ ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ í—·ê°ˆë¦¬ëŠ” ì„ ì§€ê°€ êµ¬ì„±ë¼ìš”!</p>
      <button onclick="startQuiz()" class="w-full bg-indigo-600 text-white font-bold py-5 text-lg rounded-2xl hover:bg-indigo-500 active:scale-95 shadow-md transition-all">ì‹œì‘ ğŸš€</button>
    </div>
  </div>
  
  <div id="quiz-active" class="flex-1 flex flex-col hidden fade-in max-w-4xl mx-auto w-full h-full">
    <div class="flex justify-between items-center mb-6 flex-shrink-0">
      <div class="bg-gray-800 border border-gray-700 px-5 py-2.5 rounded-full shadow-sm text-base font-bold text-gray-400"><span id="quiz-progress" class="text-indigo-400">1ë²ˆì§¸</span></div>
      <div class="flex gap-3">
        <div class="bg-gray-800 border border-gray-700 px-5 py-2.5 rounded-full shadow-sm text-base font-bold text-gray-400">âœ… <span id="quiz-score" class="text-emerald-400">0</span></div>
        <button onclick="showQuizResult()" class="bg-rose-900/30 text-rose-400 px-5 py-2.5 rounded-full border border-rose-800/50 text-sm font-bold hover:bg-rose-900/50 transition-colors">ì¢…ë£Œ</button>
      </div>
    </div>
    
    <div class="bg-gray-900 rounded-[2.5rem] shadow-lg border-4 border-gray-800 flex flex-col items-center justify-center py-16 px-6 mb-8 flex-1 max-h-[40vh]">
      <span class="text-sm font-bold text-indigo-500 mb-4 tracking-widest uppercase">ì–´ë–¤ ëœ»ì¼ê¹Œìš”?</span>
      <h2 id="quiz-word-en" class="text-5xl sm:text-6xl font-black text-gray-100 text-center break-all tracking-tight">Word</h2>
    </div>
    
    <div id="quiz-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 flex-shrink-0 pb-4"></div>
  </div>
  
  <div id="quiz-result" class="flex-1 flex flex-col items-center justify-center hidden fade-in">
    <div class="bg-gray-800 p-10 rounded-[2.5rem] shadow-2xl text-center border border-gray-700 w-full max-w-xl">
      <div class="text-7xl mb-6" id="quiz-result-emoji">ğŸ…</div>
      <h2 class="text-4xl font-black mb-4 text-gray-100">í€´ì¦ˆ ì¢…ë£Œ!</h2>
      <div class="bg-gray-900 rounded-3xl p-8 my-8 border border-gray-700 shadow-inner">
        <div class="text-6xl font-black text-indigo-400"><span id="quiz-final-score">0</span><span class="text-3xl text-gray-600"> / <span id="quiz-total-score">0</span></span></div>
        <p class="font-bold text-gray-400 mt-4 text-lg" id="quiz-feedback"></p>
      </div>
      <button onclick="resetQuizView()" class="w-full bg-indigo-600 text-white font-bold py-5 text-lg rounded-2xl hover:bg-indigo-500 active:scale-95 shadow-md transition-all">ë‹¤ì‹œ í•˜ê¸° ğŸ”„</button>
    </div>
  </div>
</div>

<!-- ===== 4. ë¹ˆì¹¸ ë„£ê¸° ===== -->
<div id="view-fill" class="flex-1 flex flex-col hidden bg-black overflow-y-auto no-scrollbar">
  <div id="fill-intro" class="flex-1 flex flex-col items-center justify-center p-6 fade-in">
    <div class="bg-gray-800 p-10 rounded-[2.5rem] shadow-lg border border-gray-700 w-full max-w-2xl text-center">
      <div class="text-6xl mb-6">âœï¸</div>
      <h2 class="text-3xl font-bold mb-4 text-gray-100">ë¹ˆì¹¸ ë„£ê¸°</h2>
      <p class="text-gray-400 text-base leading-relaxed mb-4">ì‹¤ì œ ì˜ì–´ ì˜ˆë¬¸ ì† <span class="fill-blank px-2">ë¹ˆì¹¸</span>ì—<br>ì˜¬ë°”ë¥¸ ë‹¨ì–´ë¥¼ ê³¨ë¼ë³´ì„¸ìš”!</p>
      <p class="text-sm text-indigo-500 font-bold mb-10 tracking-wide">ğŸ“¡ Dictionary API ì›ì–´ë¯¼ ì˜ˆë¬¸</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="startFill(10)" class="flex-1 bg-indigo-600 text-white font-bold py-5 text-lg rounded-2xl hover:bg-indigo-500 active:scale-95 shadow-md transition-all">10ë¬¸ì œ í’€ê¸°</button>
        <button onclick="startFill(20)" class="flex-1 bg-gray-700 text-indigo-300 font-bold py-5 text-lg rounded-2xl hover:bg-gray-600 active:scale-95 transition-all border border-gray-600">20ë¬¸ì œ í’€ê¸°</button>
      </div>
    </div>
  </div>

  <div id="fill-loading" class="flex-1 flex-col items-center justify-center hidden">
    <div class="relative w-20 h-20 mx-auto mb-6">
      <div class="absolute inset-0 border-4 border-gray-700 rounded-full"></div>
      <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
    </div>
    <p class="text-base font-bold text-gray-400 text-center">ì˜ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    <p id="fill-loading-word" class="text-sm text-gray-600 mt-2 text-center"></p>
  </div>

  <div id="fill-active" class="flex-1 flex flex-col hidden fade-in max-w-4xl mx-auto w-full h-full">
    <div class="flex items-center gap-4 px-6 pt-6 pb-4 bg-transparent flex-shrink-0">
      <div class="flex-1 bg-gray-800 rounded-full h-3 overflow-hidden shadow-inner border border-gray-700">
        <div id="fill-progress-bar" class="bg-indigo-500 h-full rounded-full transition-all duration-500" style="width:0%"></div>
      </div>
      <span id="fill-progress-text" class="text-sm font-bold text-gray-400 whitespace-nowrap">1 / 10</span>
      <div class="bg-emerald-900/30 border border-emerald-800/50 px-4 py-1.5 rounded-full text-sm font-bold text-emerald-400 shadow-sm">âœ… <span id="fill-score">0</span></div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-6 flex flex-col justify-center">
      <div class="bg-gray-900 rounded-[2.5rem] shadow-lg border-4 border-gray-800 p-10 text-center">
        <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-6">ë¬¸ë§¥ ì¶”ë¡ </p>
        <p id="fill-sentence" class="text-2xl text-gray-100 leading-relaxed font-semibold break-words"></p>
      </div>
      <div id="fill-feedback" class="hidden rounded-3xl p-6 border-2 shadow-lg">
        <p id="fill-feedback-text" class="font-bold text-xl mb-2"></p>
        <p class="text-sm text-gray-400 mt-2 leading-relaxed">ì „ì²´ ë¬¸ì¥: <span id="fill-full-sentence" class="italic text-gray-200 font-medium"></span></p>
      </div>
      <div id="fill-options" class="grid grid-cols-2 gap-4 mt-auto"></div>
    </div>

    <div class="px-6 pb-6 flex-shrink-0">
      <button id="fill-next-btn" onclick="nextFillQuestion()" class="hidden w-full bg-indigo-600 text-white font-bold py-5 text-lg rounded-2xl hover:bg-indigo-500 active:scale-95 transition-all shadow-md">ë‹¤ìŒ ë¬¸ì œ â†’</button>
    </div>
  </div>

  <div id="fill-result" class="flex-1 flex flex-col items-center justify-center hidden fade-in p-6">
    <div class="bg-gray-800 p-10 rounded-[2.5rem] shadow-2xl text-center border border-gray-700 w-full max-w-xl">
      <div class="text-7xl mb-6" id="fill-result-emoji">ğŸ‰</div>
      <h2 class="text-4xl font-black mb-3 text-gray-100">ì™„ë£Œ!</h2>
      <div class="bg-gray-900 rounded-3xl p-8 my-8 border border-gray-700 shadow-inner">
        <p class="text-gray-500 font-bold mb-2 uppercase tracking-widest text-sm">ìµœì¢… ì ìˆ˜</p>
        <p class="text-6xl font-black text-indigo-400"><span id="fill-final-score">0</span><span class="text-3xl text-gray-600"> / <span id="fill-final-total">10</span></span></p>
        <p class="text-base font-bold text-gray-400 mt-5" id="fill-result-msg"></p>
      </div>
      <button onclick="resetFillView()" class="w-full bg-indigo-600 text-white font-bold py-5 text-lg rounded-2xl hover:bg-indigo-500 active:scale-95 shadow-md transition-all">ë‹¤ì‹œ í•˜ê¸° ğŸ”„</button>
    </div>
  </div>
</div>

<!-- ===== 5. ë¶„ì„ ===== -->
<div id="view-analysis" class="flex-1 flex flex-col hidden bg-black overflow-hidden">
  <div class="p-4 sm:p-6 bg-gray-900 border-b border-gray-800 flex-shrink-0 shadow-lg z-20">
    <div class="max-w-4xl mx-auto w-full">
      <p class="text-xs sm:text-sm font-bold text-gray-500 mb-3 uppercase tracking-widest">ë‹¨ì–´ ì‹¬ì¸µ ë¶„ì„</p>
      <div class="relative">
        <input id="analysis-search" type="text" placeholder="ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”..." class="w-full border-2 border-gray-700 rounded-2xl p-4 pr-12 text-base focus:outline-none focus:border-indigo-500 bg-gray-800 text-white transition-all shadow-inner placeholder-gray-500 font-medium" oninput="filterAnalysisWords()" onclick="showAnalysisDropdown()">
        <span class="absolute right-5 top-4 text-xl text-gray-500">ğŸ”</span>
      </div>
      <div id="analysis-dropdown" class="hidden mt-2 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl max-h-60 overflow-y-auto no-scrollbar absolute w-[calc(100%-2rem)] sm:w-[calc(100%-3rem)] max-w-4xl left-1/2 -translate-x-1/2 z-50"></div>
      
      <div id="analysis-selected-word" class="hidden mt-4 flex items-center gap-4 bg-indigo-900/30 border border-indigo-500/50 rounded-2xl px-5 py-4 shadow-sm">
        <div class="flex-1 flex items-baseline gap-3 min-w-0">
          <span id="analysis-word-en-display" class="text-2xl sm:text-3xl font-black text-indigo-300 break-all tracking-tight"></span>
          <span id="analysis-word-ko-display" class="text-base sm:text-lg font-bold text-indigo-400 truncate"></span>
        </div>
        <button onclick="clearAnalysisWord()" class="text-gray-500 hover:text-rose-400 text-2xl px-2 flex-shrink-0 transition-colors">âœ•</button>
      </div>
    </div>
  </div>

  <div id="analysis-placeholder" class="flex-1 flex flex-col p-6 sm:p-8 overflow-y-auto no-scrollbar">
    <div class="max-w-xl mx-auto my-auto w-full text-center py-4">
      <div class="text-6xl sm:text-8xl mb-6 opacity-80">ğŸ”¬</div>
      <p class="font-black text-gray-300 text-2xl sm:text-3xl mb-4 break-keep tracking-tight">ë‹¨ì–´ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸í•˜ê²Œ ë¶„ì„í•´ë“œë ¤ìš”!</p>
      <p class="text-base text-gray-500 leading-relaxed break-keep">ìœ ì˜ì–´ Â· ë°˜ì˜ì–´ Â· ì—°ê´€ì–´ Â· ë°œìŒê¸°í˜¸ Â· ì˜ì˜ì •ì˜<br class="hidden sm:block">ì›ì–´ë¯¼ ì˜ˆë¬¸ 3ê°œ Â· ë‚´ ë‹¨ì–´ì¥ ë‚´ ìœ ì‚¬ë„ ë§¤ì¹­ê¹Œì§€ í•œëˆˆì— íŒŒì•…í•˜ì„¸ìš”.</p>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto no-scrollbar relative p-4 sm:p-6">
    <div class="max-w-4xl mx-auto w-full">
      <!-- ë¡œë”© -->
      <div id="analysis-loading" class="space-y-6 hidden">
        <div class="bg-gray-800 rounded-[2rem] p-8 shadow-sm border border-gray-700 space-y-5">
          <div class="skeleton h-12 w-64 mb-8"></div>
          <div class="skeleton h-6 w-48"></div><div class="skeleton h-6 w-full"></div>
        </div>
      </div>
      <!-- ê²°ê³¼ -->
      <div id="analysis-result" class="space-y-6 hidden pb-8 fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-gray-800 rounded-[2.5rem] shadow-lg border border-gray-700 p-8">
            <div class="flex items-start justify-between mb-5">
              <div class="min-w-0 pr-4">
                <h3 id="ar-word" class="text-4xl sm:text-5xl font-black text-gray-100 tracking-tight break-all"></h3>
                <p id="ar-phonetic" class="text-lg text-indigo-400 font-mono mt-2 font-medium"></p>
              </div>
              <button id="ar-audio-btn" class="hidden bg-indigo-900/50 text-indigo-300 border border-indigo-700 px-5 py-2.5 rounded-full text-sm font-bold hover:bg-indigo-800 transition-colors flex-shrink-0 flex items-center gap-2 shadow-sm">ğŸ”Š <span class="hidden sm:inline">ë°œìŒ ë“£ê¸°</span></button>
            </div>
            <span id="ar-partOfSpeech" class="inline-block text-xs sm:text-sm font-bold text-white bg-indigo-600 px-4 py-1.5 rounded-full mb-5 shadow-md tracking-wider"></span>
            <p id="ar-definition" class="text-base text-gray-300 leading-relaxed mb-8 font-medium break-words"></p>
            <div class="border-t border-gray-700 pt-8">
              <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-5">ğŸ“ ì‹¤ìƒí™œ ì˜ˆë¬¸</p>
              <div id="ar-examples" class="space-y-4"></div>
            </div>
          </div>
          <div class="bg-gray-800 rounded-[2.5rem] shadow-lg border border-gray-700 p-8 flex flex-col">
            <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-6">ğŸ“š ë‚´ ë‹¨ì–´ì¥ ìœ ì‚¬ë„ ë§¤ì¹­</p>
            <div id="ar-internal-list" class="space-y-4 flex-1 overflow-y-auto no-scrollbar pr-1"></div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-800 rounded-[2rem] shadow-lg border border-gray-700 p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸ”µ</span><p class="text-xs font-bold text-purple-400 uppercase tracking-widest">ìœ ì˜ì–´ (Synonyms)</p></div>
            <div id="ar-synonyms" class="flex flex-wrap gap-2.5"></div>
          </div>
          <div class="bg-gray-800 rounded-[2rem] shadow-lg border border-gray-700 p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸ”´</span><p class="text-xs font-bold text-rose-400 uppercase tracking-widest">ë°˜ì˜ì–´ (Antonyms)</p></div>
            <div id="ar-antonyms" class="flex flex-wrap gap-2.5"></div>
          </div>
          <div class="bg-gray-800 rounded-[2rem] shadow-lg border border-gray-700 p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸŸ¢</span><p class="text-xs font-bold text-emerald-400 uppercase tracking-widest">ì—°ê´€ì–´ (Related)</p></div>
            <div id="ar-related" class="flex flex-wrap gap-2.5"></div>
          </div>
          <div class="bg-gray-800 rounded-[2rem] shadow-lg border border-gray-700 p-8">
            <div class="flex items-center gap-3 mb-5"><span>ğŸŸ¡</span><p class="text-xs font-bold text-amber-400 uppercase tracking-widest">ë¹ˆì¶œ ë™ë°˜ì–´ (Collocations)</p></div>
            <div id="ar-collocations" class="flex flex-wrap gap-2.5"></div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-[2.5rem] border border-indigo-900 p-8 shadow-xl relative overflow-hidden">
          <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-600/20 blur-3xl rounded-full pointer-events-none"></div>
          <p class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-2 relative z-10">âœ¨ ë‹¨ì–´ì¥ ì¶”ê°€ ì¶”ì²œ</p>
          <p class="text-sm text-gray-500 mb-6 relative z-10">í„°ì¹˜ ì‹œ ë‹¨ì–´ì¥ ì¶”ê°€ íƒ­ìœ¼ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
          <div id="ar-recommendations" class="flex flex-wrap gap-3 relative z-10"></div>
        </div>
      </div>
    </div>
  </div>
</div>
</div><!-- /wrapper -->

<!-- ê°œë³„ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ (Dark Mode) -->
<div id="delete-modal" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="bg-gray-800 rounded-[2rem] p-8 w-full max-w-sm mx-4 shadow-2xl transform scale-95 transition-transform duration-200 border border-gray-700" id="delete-modal-content">
    <div class="text-center mb-8"><div class="text-6xl mb-5">ğŸ—‘ï¸</div><h3 class="text-2xl font-black text-gray-100 mb-2 tracking-tight">ì •ë§ ì‚­ì œí• ê¹Œìš”?</h3></div>
    <div class="flex gap-4">
      <button onclick="closeDeleteModal()" class="flex-1 bg-gray-700 text-gray-300 font-bold py-4 rounded-xl hover:bg-gray-600 active:scale-95 transition-all">ì·¨ì†Œ</button>
      <button onclick="executeDelete()" class="flex-1 bg-rose-600 text-white font-bold py-4 rounded-xl hover:bg-rose-500 active:scale-95 transition-all shadow-md">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ì „ì²´ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="clear-all-modal" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="bg-gray-800 rounded-[2rem] p-8 w-full max-w-sm mx-4 shadow-2xl transform scale-95 transition-transform duration-200 border border-gray-700" id="clear-all-modal-content">
    <div class="text-center mb-8"><div class="text-6xl mb-5">âš ï¸</div><h3 class="text-2xl font-black text-gray-100 mb-2 tracking-tight">ëª¨ë“  ë‹¨ì–´ ì˜êµ¬ ì‚­ì œ</h3><p class="text-gray-400 text-sm">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>
    <div class="flex gap-4">
      <button onclick="closeClearAllModal()" class="flex-1 bg-gray-700 text-gray-300 font-bold py-4 rounded-xl hover:bg-gray-600 active:scale-95 transition-all">No (ì·¨ì†Œ)</button>
      <button onclick="executeClearAll()" class="flex-1 bg-rose-600 text-white font-bold py-4 rounded-xl hover:bg-rose-500 active:scale-95 transition-all shadow-md">Yes (ì‚­ì œ)</button>
    </div>
  </div>
</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="edit-modal" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="bg-gray-800 rounded-[2rem] p-8 w-full max-w-sm mx-4 shadow-2xl transform scale-95 transition-transform duration-200 border border-gray-700" id="edit-modal-content">
    <div class="text-center mb-6"><div class="text-6xl mb-4">âœï¸</div><h3 class="text-2xl font-black text-gray-100 tracking-tight">ë‹¨ì–´ ìˆ˜ì •</h3></div>
    <div class="flex flex-col gap-4 mb-8">
      <input id="edit-en" type="text" placeholder="ì˜ì–´ ë‹¨ì–´" class="w-full border border-gray-600 rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-900 focus:bg-black text-gray-100 transition-all font-bold text-lg">
      <input id="edit-ko" type="text" placeholder="í•œêµ­ì–´ ëœ»" class="w-full border border-gray-600 rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-900 focus:bg-black text-gray-100 transition-all text-lg" onkeypress="if(event.key==='Enter')saveEditWord()">
    </div>
    <div class="flex gap-4">
      <button onclick="closeEditModal()" class="flex-1 bg-gray-700 text-gray-300 font-bold py-4 rounded-xl hover:bg-gray-600 active:scale-95 transition-all">ì·¨ì†Œ</button>
      <button onclick="saveEditWord()" class="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-500 active:scale-95 transition-all shadow-md">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="info-modal" class="fixed inset-0 bg-black/80 z-[250] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="bg-gray-800 rounded-[2rem] w-full max-w-2xl max-h-[85vh] mx-4 shadow-2xl transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden border border-gray-700" id="info-modal-content">
    <div class="flex justify-between items-center p-6 border-b border-gray-700 bg-gray-800/50">
      <h2 class="text-xl font-black text-indigo-400">ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥ ì„¤ëª…ì„œ</h2>
      <button onclick="closeInfoModal()" class="text-gray-500 hover:text-rose-400 transition-colors p-1" title="ë‹«ê¸°">âœ•</button>
    </div>
    <div class="p-8 overflow-y-auto text-gray-300 text-base leading-relaxed space-y-4">
      <p>í´ë¼ìš°ë“œ ìë™ ë™ê¸°í™”ê°€ ì ìš©ëœ <strong>ì•¼ê°„ ëª¨ë“œ(Dark Mode) ì „ìš©</strong> ìŠ¤ë§ˆíŠ¸ ì˜ë‹¨ì–´ì¥ì…ë‹ˆë‹¤.</p>
      <p>ë³„ë„ì˜ ë¡œê·¸ì¸ ê³¼ì • ì—†ì´, ì•±ì„ ì‹¤í–‰í•˜ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ìœ¼ë¡œ ëª¨ë“  ê¸°ê¸°(PC, íƒœë¸”ë¦¿, ìŠ¤ë§ˆíŠ¸í°) ê°„ì˜ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.</p>
      <p class="text-indigo-300 font-bold mt-4">âœ“ íŒ: ì˜ì–´ ë‹¨ì–´ê°€ ê¸¸ë©´ í¬ê¸°ê°€ ìë™ìœ¼ë¡œ ì¶•ì†Œë˜ì–´ í•œ ì¤„ì— ê¹”ë”í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
  </div>
</div>

<script>
let words=[], currentPage=1;
const IPP=12;

let quizQ=0,quizS=0,quizWord=null,quizQueue=[],quizIdx=0;
let testQueue=[],testPool=[],testIdx=0,testCorrect=0;
let fillQuestions=[],fillIdx=0,fillScore=0,fillTotal=10,fillCurrentQ=null;
let analysisWord=null,audioUrl=null;
const SIM_DUP=75,SIM_CONF=50;
let simMatrix={},confMatrix={};

// ğŸ’¡ ìˆ˜ì •ì‚¬í•­ 1: ê¸´ ë‹¨ì–´ ìë™ ê¸€ì”¨ í¬ê¸° ì¡°ì ˆ (Auto Scale) ë¡œì§
function resizeAllTexts() {
    document.querySelectorAll('.word-en-container').forEach(container => {
        const text = container.querySelector('.word-en-text');
        if (!text) return;
        // í¬ê¸° ê³„ì‚°ì„ ìœ„í•´ ì¼ì‹œì ìœ¼ë¡œ ìŠ¤ì¼€ì¼ ì´ˆê¸°í™”
        text.style.transform = 'scale(1)'; 
        
        const containerWidth = container.clientWidth;
        const textWidth = text.scrollWidth;
        
        // í…ìŠ¤íŠ¸ê°€ ì»¨í…Œì´ë„ˆë³´ë‹¤ ê¸¸ë©´ ë¹„ìœ¨ì— ë§ì¶° ì¶•ì†Œ
        if (textWidth > containerWidth && containerWidth > 0) {
            const scale = containerWidth / textWidth;
            text.style.transform = `scale(${scale})`;
        }
    });
}
// ì°½ í¬ê¸°ê°€ ë°”ë€” ë•Œë§ˆë‹¤ ìŠ¤ì¼€ì¼ ì¬ê³„ì‚°
window.addEventListener('resize', resizeAllTexts);


function showToast(msg,type='info'){
  const t=document.createElement('div');
  t.className=`fixed bottom-10 left-1/2 -translate-x-1/2 ${type==='error'?'bg-rose-600':'bg-gray-800 border border-gray-700'} text-white px-8 py-4 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.5)] z-[100] font-bold text-base tracking-wide`;
  t.style.cssText='opacity:0;transform:translate(-50%,20px);transition:all .3s';
  t.textContent=msg; document.body.appendChild(t);
  requestAnimationFrame(()=>{t.style.opacity='1';t.style.transform='translate(-50%,0)';});
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translate(-50%,-20px)';setTimeout(()=>t.remove(),300);},2300);
}
function shuffle(arr){let a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function openInfoModal(){document.getElementById('info-modal').classList.remove('hidden','opacity-0');document.getElementById('info-modal-content').classList.remove('scale-95');}
function closeInfoModal(){document.getElementById('info-modal').classList.add('opacity-0');document.getElementById('info-modal-content').classList.add('scale-95');setTimeout(()=>document.getElementById('info-modal').classList.add('hidden'),200);}

function loadData(){
  const raw=localStorage.getItem('myWordbook');
  if(raw){try{words=JSON.parse(raw);}catch{words=[];}}
  else{words=[];}
  renderWords();
}
function saveData(){
  localStorage.setItem('myWordbook',JSON.stringify(words));
  renderWords();
  if(window.triggerCloudSave) window.triggerCloudSave(words);
}

window.updateFromCloud = function(cloudWords) {
  words.length = 0;
  words.push(...cloudWords);
  localStorage.setItem('myWordbook', JSON.stringify(words));
  buildSimMatrix();
  renderWords();
};

function loadConf(){try{confMatrix=JSON.parse(localStorage.getItem('confMatrix')||'{}');}catch{confMatrix={};}}
function saveConf(){localStorage.setItem('confMatrix',JSON.stringify(confMatrix));}

document.addEventListener('DOMContentLoaded',()=>{loadData();loadConf();buildSimMatrix();});

const ALL_TABS=['manage','test','quiz','fill','analysis'];
function switchTab(name){
  ALL_TABS.forEach(t=>{
    const btn=document.getElementById(`tab-${t}`),view=document.getElementById(`view-${t}`);
    if(t===name){
      btn.className='flex-1 py-4 font-black text-indigo-400 border-b-4 border-indigo-500 bg-gray-800 transition-colors';
      view.classList.remove('hidden');
    } else {
      btn.className='flex-1 py-4 font-bold text-gray-500 border-b-4 border-transparent transition-colors hover:bg-gray-800 hover:text-gray-300';
      view.classList.add('hidden');
    }
  });
  if(name!=='test') resetTestView(); if(name!=='quiz') resetQuizView();
  if(name!=='analysis') document.getElementById('analysis-dropdown').classList.add('hidden');
  
  // íƒ­ ì´ë™ ì‹œì—ë„ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì ˆ ë°œë™
  if(name==='manage') setTimeout(resizeAllTexts, 50);
}

function addWord(){
  const enEl=document.getElementById('input-en'),koEl=document.getElementById('input-ko');
  const en=enEl.value.trim(),ko=koEl.value.trim();
  if(!en||!ko)return showToast('ì˜ì–´ ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
  words.push({id:Date.now(),en,ko,wrongCount:0, quizCount:0});
  buildSimMatrix();currentPage=1;
  saveData();
  enEl.value='';koEl.value='';enEl.focus();
  showToast('ë‹¨ì–´ ì¶”ê°€ ì™„ë£Œ! âœ¨');
}

let pendingDeleteId = null;
function confirmDelete(id){pendingDeleteId = id; document.getElementById('delete-modal').classList.remove('hidden','opacity-0');document.getElementById('delete-modal-content').classList.remove('scale-95');}
function closeDeleteModal(){document.getElementById('delete-modal').classList.add('opacity-0');document.getElementById('delete-modal-content').classList.add('scale-95');setTimeout(()=>{document.getElementById('delete-modal').classList.add('hidden');pendingDeleteId = null;},200);}
function executeDelete(){if(pendingDeleteId !== null){words = words.filter(w => w.id !== pendingDeleteId);buildSimMatrix();saveData();showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');closeDeleteModal();}}

function confirmClearAll() {if(words.length===0)return showToast('ì‚­ì œí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.','info');document.getElementById('clear-all-modal').classList.remove('hidden','opacity-0');document.getElementById('clear-all-modal-content').classList.remove('scale-95');}
function closeClearAllModal() {document.getElementById('clear-all-modal').classList.add('opacity-0');document.getElementById('clear-all-modal-content').classList.add('scale-95');setTimeout(()=>document.getElementById('clear-all-modal').classList.add('hidden'),200);}
function executeClearAll() {words=[];buildSimMatrix();saveData();closeClearAllModal();showToast('ëª¨ë“  ë‹¨ì–´ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ—‘ï¸');}

let editingWordId = null;
function openEditModal(id) {const w=words.find(x=>x.id===id);if(!w)return;editingWordId=id;document.getElementById('edit-en').value=w.en;document.getElementById('edit-ko').value=w.ko;document.getElementById('edit-modal').classList.remove('hidden','opacity-0');document.getElementById('edit-modal-content').classList.remove('scale-95');}
function closeEditModal() {document.getElementById('edit-modal').classList.add('opacity-0');document.getElementById('edit-modal-content').classList.add('scale-95');setTimeout(()=>{document.getElementById('edit-modal').classList.add('hidden');editingWordId=null;},200);}
function saveEditWord() {
  const en=document.getElementById('edit-en').value.trim(),ko=document.getElementById('edit-ko').value.trim();
  if(!en||!ko)return showToast('ì˜ì–´ ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
  const idx=words.findIndex(w=>w.id===editingWordId);
  if(idx!==-1){words[idx].en=en;words[idx].ko=ko;buildSimMatrix();saveData();showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. âœï¸');closeEditModal();}
}

function changePage(d){currentPage+=d;renderWords();document.getElementById('word-list').scrollTop=0;}

// ğŸ’¡ ìˆ˜ì •ì‚¬í•­ 2: <select> íƒœê·¸ë¥¼ í†µí•œ ìŠ¤í¬ë¡¤ í˜•ì‹ í˜ì´ì§€ ì´ë™
function jumpToPage(val) {
  const page = parseInt(val, 10);
  if (!isNaN(page)) {
      currentPage = page;
      renderWords();
      document.getElementById('word-list').scrollTop = 0;
  }
}

function renderWords(){
  const list=document.getElementById('word-list');
  const query = document.getElementById('search-manage').value.toLowerCase().trim();
  let disp=[...words];
  if(query) disp = disp.filter(w => w.en.toLowerCase().includes(query) || w.ko.includes(query));
  document.getElementById('word-count').textContent=disp.length;
  list.innerHTML='';
  if(!disp.length){list.innerHTML='<div class="col-span-full flex flex-col items-center justify-center text-gray-500 py-20"><span class="text-5xl mb-4 opacity-50">ğŸ“­</span><p class="font-bold">ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';document.getElementById('pagination-controls').classList.add('hidden');return;}
  if(document.getElementById('sort-select').value==='wrongCount') disp.sort((a,b)=>(b.wrongCount||0)-(a.wrongCount||0)); else disp.reverse();
  const total=Math.max(1,Math.ceil(disp.length/IPP));currentPage=Math.max(1,Math.min(currentPage,total));
  
  disp.slice((currentPage-1)*IPP,currentPage*IPP).forEach(w=>{
    const simRow=simMatrix[w.id]||{};const dupes=words.filter(x=>x.id!==w.id&&(simRow[x.id]||0)>=SIM_DUP);
    const wBadge=w.wrongCount>0?`<span class="px-2 py-0.5 bg-rose-900/50 text-rose-300 border border-rose-800 text-[10px] font-bold rounded-full whitespace-nowrap tracking-wide">ì˜¤ë‹µ ${w.wrongCount}íšŒ</span>`:'';
    const dBadge=dupes.length?`<span class="px-2 py-0.5 bg-amber-900/50 text-amber-300 border border-amber-800 text-[10px] font-bold rounded-full whitespace-nowrap tracking-wide">âš ï¸ ì¤‘ë³µ</span>`:'';
    const li=document.createElement('li');
    
    // ğŸ’¡ ìˆ˜ì •ì‚¬í•­ 1 ì ìš© ì˜ì—­: h-max ì œê±°í•˜ê³  h-full min-h-[112px] ì„¤ì •ìœ¼ë¡œ ë°•ìŠ¤ í¬ê¸° ê· ë“±í™”
    li.className='bg-gray-800 p-5 rounded-2xl shadow-md border border-gray-700 flex justify-between items-center fade-in hover:border-indigo-500 transition-all h-full min-h-[112px]';
    li.innerHTML=`
      <div class="flex flex-col flex-1 pr-4 min-w-0 word-en-container overflow-hidden justify-center">
        <span class="font-black text-2xl text-gray-100 mb-1.5 leading-none whitespace-nowrap inline-block w-max word-en-text origin-left transition-transform duration-200">${w.en}</span>
        <span class="text-gray-400 text-sm whitespace-normal break-words font-medium">${w.ko}</span>
        <div class="flex gap-2 mt-2 flex-wrap">${wBadge}${dBadge}</div>
      </div>
      <div class="flex gap-2 flex-shrink-0 items-center">
        <button onclick="openEditModal(${w.id})" class="text-emerald-400 hover:text-emerald-300 bg-emerald-900/30 hover:bg-emerald-900/50 border border-emerald-800/30 p-3 rounded-xl transition-colors" title="ë‹¨ì–´ ìˆ˜ì •">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
        </button>
        <button onclick="openAnalysis(${w.id})" class="text-indigo-400 hover:text-indigo-300 bg-indigo-900/30 hover:bg-indigo-900/50 border border-indigo-800/30 p-3 rounded-xl transition-colors" title="ë‹¨ì–´ ë¶„ì„">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        </button>
        <button onclick="confirmDelete(${w.id})" class="text-rose-400 hover:text-rose-300 bg-rose-900/30 hover:bg-rose-900/50 border border-rose-800/30 p-3 rounded-xl transition-colors" title="ì‚­ì œ">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </button>
      </div>`;
    list.appendChild(li);
  });
  
  const pgCtrl=document.getElementById('pagination-controls');
  if(total>1){
    pgCtrl.classList.remove('hidden');
    
    // Select íƒœê·¸ì— ì˜µì…˜ ì±„ìš°ê¸°
    const pageSelect = document.getElementById('page-select');
    pageSelect.innerHTML = '';
    for(let i=1; i<=total; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${i} / ${total}`;
        if(i === currentPage) opt.selected = true;
        pageSelect.appendChild(opt);
    }
    
    document.getElementById('btn-prev').disabled=currentPage===1;
    document.getElementById('btn-next').disabled=currentPage===total;
  } else {
    pgCtrl.classList.add('hidden');
  }

  // ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ ê·¸ë¦° í›„ ìŠ¤ì¼€ì¼ ìë™ ì¡°ì ˆ ì‹¤í–‰
  setTimeout(resizeAllTexts, 10);
}

function exportData(){if(!words.length)return showToast('ì €ì¥í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.','error');const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify(words,null,2)],{type:'application/json'})),download:`ì˜ë‹¨ì–´ì¥.json`});document.body.appendChild(a);a.click();a.remove();}
function importData(e){const file=e.target.files[0];if(!file)return;const r=new FileReader();r.onload=ev=>{try{const imp=JSON.parse(ev.target.result);if(!Array.isArray(imp))throw 0;imp.forEach(iw=>{if(iw.en&&iw.ko){words.push({id:Date.now()+Math.random(),en:iw.en,ko:iw.ko,wrongCount:iw.wrongCount||0, quizCount:iw.quizCount||0});}});buildSimMatrix();saveData();currentPage=1;showToast(`ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ ğŸ“¥`);}catch{showToast('íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.','error');}};r.readAsText(file);e.target.value='';}

function resetTestView(){testQueue=[];testPool=[];testIdx=0;testCorrect=0;['test-intro','test-active','test-result'].forEach((id,i)=>document.getElementById(id).classList[i===0?'remove':'add']('hidden'));}
function startTest(mode){if(!words.length)return showToast('ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!','error');let pool=[...words];if(mode==='wrong'){pool=pool.filter(w=>(w.wrongCount||0)>0);if(!pool.length)return showToast('í‹€ë¦° ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');}testPool=pool;testQueue=shuffle(pool);testIdx=testCorrect=0;document.getElementById('test-intro').classList.add('hidden');document.getElementById('test-active').classList.remove('hidden');loadTestCard();}
function loadTestCard(){if(testIdx>=testQueue.length){testQueue=shuffle(testPool);testIdx=0;}const w=testQueue[testIdx];document.getElementById('test-progress').textContent=`${testIdx+1}/${testQueue.length}`;document.getElementById('test-score').textContent=testCorrect;document.getElementById('test-word-en').textContent=w.en;document.getElementById('test-word-ko').textContent=w.ko;document.getElementById('test-word-ko').classList.add('hidden');document.getElementById('btn-reveal').classList.remove('hidden');document.getElementById('test-actions').classList.add('hidden');}
function revealAnswer(){document.getElementById('btn-reveal').classList.add('hidden');document.getElementById('test-word-ko').classList.remove('hidden');document.getElementById('test-actions').classList.remove('hidden');}
function markAnswer(ok){if(ok)testCorrect++;else{const i=words.findIndex(x=>x.id===testQueue[testIdx].id);if(i!==-1){words[i].wrongCount=(words[i].wrongCount||0)+1;saveData();}}testIdx++;if(testIdx>=testQueue.length){document.getElementById('test-active').classList.add('hidden');document.getElementById('test-result').classList.remove('hidden');renderWords();}else{loadTestCard();}}

const KO_SUF=['ìŠ¤ëŸ½ë‹¤','ìŠ¤ëŸ¬ìš´','í•˜ë‹¤','í•˜ëŠ”','í•˜ì—¬','í•˜ê²Œ','í•œ','í•¨','íˆ','ì´ë‹¤','ì´ë€','ë˜ë‹¤','ë˜ëŠ”','ëœ','ë¨','ì ì¸','ì ìœ¼ë¡œ','ì ','ë¡­ë‹¤','ë¡œìš´','ì—†ë‹¤','ì—†ëŠ”','ìˆë‹¤','ìˆëŠ”','ì§€ë‹¤','ì§„','ã„´','ëŠ”','ì„','ë¥¼','ì´','ê°€','ì˜','ì—','ë¡œ','ê³¼','ì™€','ë„'].sort((a,b)=>b.length-a.length);
function tokenize(str){const tokens=new Set();str.split(/[,\/\s]+/).map(s=>s.trim()).filter(Boolean).forEach(c=>{let stem=c;for(const suf of KO_SUF){if(stem.length>suf.length&&stem.endsWith(suf)){stem=stem.slice(0,-suf.length);break;}}if(stem.length>=1)tokens.add(stem);});return tokens;}
function semSim(a,b){const tA=tokenize(a),tB=tokenize(b);if(!tA.size||!tB.size)return 0;let ex=0;tA.forEach(t=>{if(tB.has(t))ex++;});const jac=ex/new Set([...tA,...tB]).size;let part=0;tA.forEach(a=>tB.forEach(b=>{if(a!==b&&(a.includes(b)||b.includes(a)))part+=0.3;}));const cA=new Set([...a.replace(/[,\/\s]/g,'')]),cB=new Set([...b.replace(/[,\/\s]/g,'')]);let co=0;cA.forEach(c=>{if(cB.has(c))co++;});return Math.min(100,jac*70+part*15+(co/Math.max(cA.size,cB.size))*15);}
function buildSimMatrix(){simMatrix={};for(let i=0;i<words.length;i++)for(let j=0;j<words.length;j++){if(i===j)continue;const a=words[i],b=words[j];if(!simMatrix[a.id])simMatrix[a.id]={};simMatrix[a.id][b.id]=semSim(a.ko,b.ko);}}

function resetQuizView(){quizQueue=[];quizIdx=0;document.getElementById('quiz-intro').classList.remove('hidden');document.getElementById('quiz-active').classList.add('hidden');document.getElementById('quiz-result').classList.add('hidden');}

function startQuiz(){
    if(words.length<4)return showToast('ë‹¨ì–´ê°€ 4ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!','error');
    quizQ=0;quizS=0;
    quizQueue = [...words].sort((a,b) => {
        const scoreA = (a.wrongCount||0)*5 - (a.quizCount||0)*2 + Math.random()*5;
        const scoreB = (b.wrongCount||0)*5 - (b.quizCount||0)*2 + Math.random()*5;
        return scoreB - scoreA;
    });
    quizIdx=0;
    document.getElementById('quiz-intro').classList.add('hidden');
    document.getElementById('quiz-active').classList.remove('hidden');
    nextQuiz();
}
function getDistractors(target){const mat=confMatrix[target.id]||{},sim=simMatrix[target.id]||{};const cands=words.filter(w=>w.id!==target.id&&(sim[w.id]||0)<SIM_DUP);return cands.map(w=>({word:w,score:(sim[w.id]||0)*5+(mat[w.id]||0)*10+Math.random()*3})).sort((a,b)=>b.score-a.score).slice(0,3).map(s=>s.word);}
function nextQuiz(){
    if(quizIdx>=quizQueue.length){
        quizQueue = [...words].sort((a,b) => ((b.wrongCount||0)*5 - (b.quizCount||0)*2 + Math.random()*5) - ((a.wrongCount||0)*5 - (a.quizCount||0)*2 + Math.random()*5));
        quizIdx=0;
    }
    quizQ++;
    document.getElementById('quiz-progress').textContent=`${quizQ}ë²ˆì§¸`;
    document.getElementById('quiz-score').textContent=quizS;
    quizWord=quizQueue[quizIdx++];
    const wIdx = words.findIndex(w=>w.id===quizWord.id);
    if(wIdx !== -1) { words[wIdx].quizCount = (words[wIdx].quizCount || 0) + 1; saveData(); }
    document.getElementById('quiz-word-en').textContent=quizWord.en;
    const opts=document.getElementById('quiz-options');
    opts.innerHTML='';
    shuffle([{word:quizWord,ok:true},...getDistractors(quizWord).map(w=>({word:w,ok:false}))]).forEach(opt=>{
        const btn=document.createElement('button');
        btn.className='game-btn w-full bg-gray-800 border-2 border-gray-700 hover:border-indigo-500 hover:bg-gray-700 text-gray-200 font-bold py-6 rounded-2xl text-xl break-words px-4 shadow-sm';
        btn.textContent=opt.word.ko;
        btn.onclick=()=>selectQuiz(btn,opt.ok,opt.word.id);
        opts.appendChild(btn);
    });
}
function selectQuiz(btn,ok,selId){document.querySelectorAll('#quiz-options button').forEach(b=>b.disabled=true);if(ok){quizS++;btn.classList.add('correct-answer');}else{btn.classList.add('wrong-answer');const i=words.findIndex(w=>w.id===quizWord.id);if(i!==-1){words[i].wrongCount=(words[i].wrongCount||0)+1;saveData();}if(!confMatrix[quizWord.id])confMatrix[quizWord.id]={};confMatrix[quizWord.id][selId]=(confMatrix[quizWord.id][selId]||0)+1;saveConf();}document.getElementById('quiz-score').textContent=quizS;setTimeout(()=>nextQuiz(),1000);}
function showQuizResult(){document.getElementById('quiz-active').classList.add('hidden');document.getElementById('quiz-result').classList.remove('hidden');document.getElementById('quiz-final-score').textContent=quizS;document.getElementById('quiz-total-score').textContent=Math.max(0,quizQ-1);renderWords();}

function resetFillView(){fillQuestions=[];fillIdx=0;fillScore=0;document.getElementById('fill-intro').classList.remove('hidden');document.getElementById('fill-active').classList.add('hidden');document.getElementById('fill-result').classList.add('hidden');}

async function buildFillQuestion(targetWord){
  try{
    let sentence = "";
    let isDef = false; // ëœ»í’€ì´ íŒíŠ¸ ëª¨ë“œì¸ì§€ ì²´í¬
    
    const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(targetWord.en)}`);
    if(r.ok) {
        const data = await r.json();
        const meanings = data[0]?.meanings || [];
        
        // ìš°ì„ ìˆœìœ„ 1: ì‹¤ì œ ì˜ˆë¬¸ ì°¾ê¸°
        for(let m of meanings) {
            for(let d of m.definitions) {
                if(d.example) {
                    sentence = d.example;
                    break;
                }
            }
            if(sentence) break;
        }
        
        // ìš°ì„ ìˆœìœ„ 2: ì˜ˆë¬¸ì´ ì—†ìœ¼ë©´ ì˜ì˜ì‚¬ì „ ëœ»(Definition)ì„ íŒíŠ¸ë¡œ ì œê³µí•˜ëŠ” í€´ì¦ˆë¡œ ì „í™˜!
        if(!sentence) {
            for(let m of meanings) {
                for(let d of m.definitions) {
                    if(d.definition) {
                        sentence = `<span class="text-indigo-400 text-base font-bold block mb-2 mt-2">ğŸ’¡ ì˜ì˜ì‚¬ì „ íŒíŠ¸</span><span class="block mb-4 text-gray-300 font-normal">"${d.definition}"</span>ğŸ‘‰ ë“¤ì–´ê°ˆ ë‹¨ì–´ëŠ”? ___`;
                        isDef = true;
                        break;
                    }
                }
                if(sentence) break;
            }
        }
    }
    
    // ìš°ì„ ìˆœìœ„ 3: APIì— ì •ë³´ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì‚¬ìš©ìê°€ ì ì€ 'í•œêµ­ì–´ ëœ»'ì„ íŒíŠ¸ë¡œ ì œê³µ
    if(!sentence) {
        sentence = `<span class="text-indigo-400 text-base font-bold block mb-2 mt-2">ğŸ’¡ í•œêµ­ì–´ ëœ» íŒíŠ¸</span><span class="block mb-4 text-gray-300 font-normal">"${targetWord.ko}"</span>ğŸ‘‰ ì•Œë§ì€ ì˜ì–´ ë‹¨ì–´ëŠ”? ___`;
        isDef = true;
    }

    let blanked = sentence;
    // ê²°ê³¼ì°½(í”¼ë“œë°±)ì— ë³´ì—¬ì¤„ ë•ŒëŠ” HTML íƒœê·¸ë¥¼ ë–¼ì–´ë‚´ê³  ê¹”ë”í•œ í…ìŠ¤íŠ¸ë§Œ ë‚¨ê¹€
    let fullText = sentence.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim(); 

    if(!isDef) {
        // ì¼ë°˜ ì˜ˆë¬¸ì¼ ë•Œ: ì •ë‹µ ë‹¨ì–´ë¥¼ ì°¾ì•„ ë¹ˆì¹¸ ì²˜ë¦¬ (ê³¼ê±°í˜•, ì§„í–‰í˜•, ë³µìˆ˜í˜• ë“± ìœ ì—°í•˜ê²Œ ì»¤ë²„)
        const safeRegex = new RegExp(`\\b${targetWord.en}\\b(?:'s|s|es|ed|ing|d|ly)?`, 'gi');
        blanked = sentence.replace(safeRegex, '___');
        
        // ë¶ˆê·œì¹™ ë™ì‚¬ ë³€í˜• ë“±ìœ¼ë¡œ ë§¤ì¹­ ì•ˆ ëì„ ì‹œ: ì• 3ê¸€ì ì¼ì¹˜í•˜ëŠ” ë‹¨ì–´ë¥¼ ê°•ì œë¡œ ë¹ˆì¹¸ ì²˜ë¦¬
        if(!blanked.includes('___') && targetWord.en.length >= 3) {
            const prefix = targetWord.en.substring(0, 3);
            const prefixRegex = new RegExp(`\\b${prefix}\\w*\\b`, 'gi');
            blanked = sentence.replace(prefixRegex, '___');
        }
        
        // ê·¸ë˜ë„ ëª» ì°¾ìœ¼ë©´ ë¬¸ì¥ ë§¨ ëì— (___) ì¶”ê°€
        if(!blanked.includes('___')) {
            blanked = sentence + " (___)";
        }
    } else {
        // íŒíŠ¸ ëª¨ë“œì¼ ë•Œ: ëœ»í’€ì´ ì•ˆì— ì •ë‹µ ë‹¨ì–´ê°€ ìŠ¤í¬ì¼ëŸ¬ë¡œ ì í˜€ìˆë‹¤ë©´ [OOO] ë¡œ ê°€ë¦¼
        const spoilerRegex = new RegExp(`\\b${targetWord.en}\\b(?:'s|s|es|ed|ing|d|ly)?`, 'gi');
        blanked = blanked.replace(spoilerRegex, 'OOO');
    }

    const sim=simMatrix[targetWord.id]||{};
    const dist=words.filter(w=>w.id!==targetWord.id&&(sim[w.id]||0)<SIM_DUP).sort(()=>Math.random()-0.5).slice(0,3);
    while(dist.length<3)dist.push(words.find(w=>w.id!==targetWord.id&&!dist.some(x=>x.id===w.id)));
    
    return {word:targetWord, blank:blanked, full:fullText.replace(/___/g, targetWord.en).replace(/OOO/g, 'OOO'), options:shuffle([targetWord,...dist])};
  }catch{
    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ìœ¼ë¡œ API í†µì‹ ì´ ì‹¤íŒ¨í–ˆì„ ë•Œì˜ ìµœí›„ ë°©ì–´ì„ 
    const fb = `<span class="text-indigo-400 text-base font-bold block mb-2 mt-2">ğŸ’¡ ëœ» íŒíŠ¸</span><span class="block mb-4 text-gray-300 font-normal">"${targetWord.ko}"</span>ğŸ‘‰ ì•Œë§ì€ ì˜ì–´ ë‹¨ì–´ëŠ”? ___`;
    const sim=simMatrix[targetWord.id]||{};
    const dist=words.filter(w=>w.id!==targetWord.id&&(sim[w.id]||0)<SIM_DUP).sort(()=>Math.random()-0.5).slice(0,3);
    while(dist.length<3)dist.push(words.find(w=>w.id!==targetWord.id&&!dist.some(x=>x.id===w.id)));
    return {word:targetWord, blank:fb, full:`íŒíŠ¸: "${targetWord.ko}" -> ì •ë‹µ: ${targetWord.en}`, options:shuffle([targetWord,...dist])};
  }
}

async function startFill(n=10){if(words.length<4)return showToast('ë‹¨ì–´ê°€ 4ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!','error');fillTotal=n;fillScore=0;fillIdx=0;fillQuestions=[];document.getElementById('fill-intro').classList.add('hidden');document.getElementById('fill-loading').classList.remove('hidden');document.getElementById('fill-loading').classList.add('flex');const pool=shuffle(words).slice(0,n);const results=await Promise.all(pool.map(w=>buildFillQuestion(w)));fillQuestions=results.filter(Boolean);document.getElementById('fill-loading').classList.add('hidden');document.getElementById('fill-loading').classList.remove('flex');if(fillQuestions.length<1){resetFillView();return showToast('ì˜¤ë¥˜ ë°œìƒ','error');}fillTotal=fillQuestions.length;document.getElementById('fill-active').classList.remove('hidden');showFillQuestion();}
function showFillQuestion(){if(fillIdx>=fillQuestions.length)return showFillResult();fillCurrentQ=fillQuestions[fillIdx];document.getElementById('fill-progress-bar').style.width=Math.round((fillIdx/fillTotal)*100)+'%';document.getElementById('fill-progress-text').textContent=`${fillIdx+1} / ${fillTotal}`;document.getElementById('fill-score').textContent=fillScore;document.getElementById('fill-sentence').innerHTML=fillCurrentQ.blank.replace(/___/g,'<span class="fill-blank px-6 mx-1">ã€€</span>');document.getElementById('fill-feedback').classList.add('hidden');document.getElementById('fill-next-btn').classList.add('hidden');const opts=document.getElementById('fill-options');opts.innerHTML='';fillCurrentQ.options.forEach(w=>{const b=document.createElement('button');b.className='fill-opt bg-gray-800 border-2 border-gray-700 hover:border-indigo-500 hover:bg-gray-700 text-gray-200 rounded-2xl p-5 text-xl font-bold break-words px-3 shadow-sm';b.textContent=w.en;b.onclick=()=>selectFill(b,w.id===fillCurrentQ.word.id,fillCurrentQ);opts.appendChild(b);});}
function selectFill(btn,ok,q){document.getElementById('fill-options').querySelectorAll('button').forEach(b=>b.disabled=true);if(ok){btn.classList.add('correct');fillScore++;}else{btn.classList.add('wrong');const i=words.findIndex(w=>w.id===q.word.id);if(i!==-1){words[i].wrongCount=(words[i].wrongCount||0)+1;saveData();}}document.getElementById('fill-feedback').classList.remove('hidden');document.getElementById('fill-feedback-text').textContent=ok?'âœ… ì •ë‹µ!':`âŒ ì •ë‹µì€ "${q.word.en}" ì…ë‹ˆë‹¤.`;document.getElementById('fill-full-sentence').textContent=q.full;document.getElementById('fill-score').textContent=fillScore;document.getElementById('fill-next-btn').classList.remove('hidden');}
function nextFillQuestion(){fillIdx++;showFillQuestion();}
function showFillResult(){document.getElementById('fill-active').classList.add('hidden');document.getElementById('fill-result').classList.remove('hidden');document.getElementById('fill-final-score').textContent=fillScore;document.getElementById('fill-final-total').textContent=fillTotal;}

function openAnalysis(id){const w=words.find(x=>x.id===id);if(!w)return;switchTab('analysis');setTimeout(()=>selectAnalysisWord(w),60);}
function filterAnalysisWords(){renderAnalysisDD(document.getElementById('analysis-search').value.toLowerCase());}
function showAnalysisDropdown(){renderAnalysisDD(document.getElementById('analysis-search').value.toLowerCase());}
function renderAnalysisDD(q=''){const dd=document.getElementById('analysis-dropdown');const f=words.filter(w=>w.en.toLowerCase().includes(q)||w.ko.includes(q));if(!f.length)return dd.classList.add('hidden');dd.innerHTML=f.map(w=>`<button class="w-full text-left px-5 py-4 hover:bg-gray-700 flex justify-between transition-colors border-b border-gray-700/50" onclick="selectAnalysisWord(words.find(x=>x.id===${w.id}))"><span class="font-bold text-gray-200">${w.en}</span><span class="text-sm text-gray-400">${w.ko}</span></button>`).join('');dd.classList.remove('hidden');}
function selectAnalysisWord(w){if(!w)return;analysisWord=w;document.getElementById('analysis-search').value='';document.getElementById('analysis-dropdown').classList.add('hidden');document.getElementById('analysis-word-en-display').textContent=w.en;document.getElementById('analysis-word-ko-display').textContent=w.ko;document.getElementById('analysis-selected-word').classList.remove('hidden');runAnalysis(w);}
function clearAnalysisWord(){analysisWord=null;document.getElementById('analysis-selected-word').classList.add('hidden');document.getElementById('analysis-result').classList.add('hidden');document.getElementById('analysis-loading').classList.add('hidden');document.getElementById('analysis-placeholder').classList.remove('hidden');}

async function runAnalysis(w){
  document.getElementById('analysis-placeholder').classList.add('hidden');
  document.getElementById('analysis-result').classList.add('hidden');
  document.getElementById('analysis-loading').classList.remove('hidden');
  const fetchDM = async (p) => fetch(`https://api.datamuse.com/words?${p}`).then(r=>r.json()).catch(()=>[]);
  const[dictData, syn1, syn2, ants, rel1, rel2, col1, col2, col3, col4] = await Promise.all([
    fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w.en}`).then(r=>r.ok?r.json():null).then(d=>Array.isArray(d)?d[0]:null).catch(()=>null),
    fetchDM(`rel_syn=${w.en}&max=15`), fetchDM(`ml=${w.en}&max=15`), fetchDM(`rel_ant=${w.en}&max=15`), fetchDM(`rel_trg=${w.en}&max=15`),
    fetchDM(`rel_spc=${w.en}&max=10`), fetchDM(`rel_jja=${w.en}&max=10`), fetchDM(`rel_jjb=${w.en}&max=10`), fetchDM(`rel_bga=${w.en}&max=10`), fetchDM(`rel_bgb=${w.en}&max=10`)
  ]);
  document.getElementById('analysis-loading').classList.add('hidden');
  document.getElementById('analysis-result').classList.remove('hidden');
  document.getElementById('ar-word').textContent=w.en;
  let dictSyns = [], dictAnts = [];
  const examplesEl = document.getElementById('ar-examples');
  examplesEl.innerHTML = '';
  if(dictData){
    document.getElementById('ar-definition').textContent=dictData.meanings?.[0]?.definitions?.[0]?.definition||'ì‚¬ì „ ì •ë³´ ì—†ìŒ';
    document.getElementById('ar-phonetic').textContent=dictData.phonetics?.find(p=>p.text)?.text||'';
    const aUrl = dictData.phonetics?.find(p=>p.audio)?.audio||null;
    const aBtn = document.getElementById('ar-audio-btn');
    if(aUrl){aBtn.classList.remove('hidden');aBtn.onclick=()=>new Audio(aUrl).play();}else{aBtn.classList.add('hidden');}
    const posSet = new Set();
    dictData.meanings?.forEach(m => {
      if(m.partOfSpeech) posSet.add(m.partOfSpeech);
      if(m.synonyms) dictSyns.push(...m.synonyms.map(s=>({word:s})));
      if(m.antonyms) dictAnts.push(...m.antonyms.map(a=>({word:a})));
    });
    const posStr = Array.from(posSet).join(', ');
    document.getElementById('ar-partOfSpeech').textContent = posStr;
    document.getElementById('ar-partOfSpeech').style.display = posStr ? '' : 'none';
    const allExamples=[];
    dictData.meanings?.forEach(m=>{m.definitions?.forEach(d=>{if(d.example&&allExamples.length<3)allExamples.push(d.example);});});
    if(allExamples.length){
      examplesEl.innerHTML = allExamples.map((ex,i)=>`<div class="flex gap-4 items-start bg-gray-900 p-5 rounded-2xl border border-gray-700 shadow-inner"><span class="flex-shrink-0 w-6 h-6 bg-indigo-900 text-indigo-300 text-xs font-black rounded-full flex items-center justify-center mt-0.5">${i+1}</span><p class="text-base text-gray-300 italic leading-relaxed break-words font-medium">"${ex}"</p></div>`).join('');
    } else { examplesEl.innerHTML = '<p class="text-sm text-gray-500 italic bg-gray-900 p-5 rounded-2xl">ì´ ë‹¨ì–´ê°€ í¬í•¨ëœ ì˜ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; }
  } else {
    document.getElementById('ar-definition').textContent='ì‚¬ì „ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    document.getElementById('ar-phonetic').textContent='';
    document.getElementById('ar-partOfSpeech').style.display='none';
    document.getElementById('ar-audio-btn').classList.add('hidden');
    examplesEl.innerHTML = '<p class="text-sm text-gray-500">ì˜ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
  }
  const simRow=simMatrix[w.id]||{};
  const internals=words.filter(x=>x.id!==w.id).map(x=>({word:x,sim:simRow[x.id]||0})).filter(x=>x.sim>8).sort((a,b)=>b.sim-a.sim).slice(0,7);
  const intEl=document.getElementById('ar-internal-list');
  if(internals.length){
    intEl.innerHTML=internals.map(({word:iw,sim})=>{
      const pct=Math.round(sim);
      const bar=pct>=SIM_DUP?'bg-amber-500':pct>=SIM_CONF?'bg-violet-500':'bg-indigo-500';
      const lbl=pct>=SIM_DUP?'<span class="text-[10px] bg-amber-900/50 text-amber-300 font-bold px-2 py-0.5 rounded-full whitespace-nowrap border border-amber-800">âš ï¸ ì¤‘ë³µ</span>':pct>=SIM_CONF?'<span class="text-[10px] bg-violet-900/50 text-violet-300 font-bold px-2 py-0.5 rounded-full whitespace-nowrap border border-violet-800">í˜¼ë™ ì£¼ì˜</span>':'';
      return `<div class="flex items-center gap-4 bg-gray-900 p-4 rounded-2xl border border-gray-700 shadow-sm"><div class="flex-1 min-w-0"><div class="flex items-center gap-2 flex-wrap mb-1.5"><span class="font-bold text-lg text-gray-200 break-all">${iw.en}</span><span class="text-sm text-gray-500 truncate">${iw.ko}</span>${lbl}</div><div class="flex items-center gap-3"><div class="flex-1 bg-gray-800 rounded-full h-2 overflow-hidden border border-gray-700"><div class="${bar} h-full rounded-full transition-all duration-700" style="width:${pct}%"></div></div><span class="text-xs text-gray-400 font-mono w-8 text-right font-bold">${pct}%</span></div></div></div>`;
    }).join('');
  } else { intEl.innerHTML='<div class="flex flex-col items-center justify-center h-full text-center p-6"><span class="text-4xl mb-3 opacity-50">ğŸ¤·â€â™‚ï¸</span><p class="text-sm text-gray-500 font-bold">ë‹¨ì–´ì¥ ë‚´ì— ë¹„ìŠ·í•œ ë‹¨ì–´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p></div>'; }
  const existingEn=new Set(words.map(x=>x.en.toLowerCase()));
  const newCands=new Set();

  function renderChips(elId, items, cls){
    const el=document.getElementById(elId);
    if(!items.length){el.innerHTML='<span class="text-sm text-gray-500">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</span>';return;}
    el.innerHTML='';
    items.forEach(item=>{
      const inBook=existingEn.has(item.word.toLowerCase());
      if(!inBook)newCands.add(item.word);
      const span=document.createElement('span');
      span.className='chip '+cls;
      
      const inBookWord=words.find(x=>x.en.toLowerCase()===item.word.toLowerCase());
      const knownKo=inBookWord?inBookWord.ko:null;
      span.appendChild(document.createTextNode((inBook?'âœ… ':'')+item.word));
      const tooltip=document.createElement('span');
      tooltip.className='chip-tooltip'+(knownKo?'':' loading');
      tooltip.textContent=knownKo||'ëœ» ë²ˆì—­ ì¤‘...';
      span.appendChild(tooltip);
      
      span.onclick = () => {
          const found = words.find(x => x.en.toLowerCase() === item.word.toLowerCase());
          if (found) {
              selectAnalysisWord(found);
          } else {
              span.classList.add('force-tooltip');
              if(!knownKo && !span.dataset.fetched){
                  span.dataset.fetched = "true";
                  tooltip.classList.remove('loading');
                  tooltip.textContent = 'ë²ˆì—­ ì¤‘...';
                  fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q=${encodeURIComponent(item.word)}`)
                  .then(r=>r.json()).then(data=>{ tooltip.textContent = data[0][0][0] || 'ëœ» ì—†ìŒ'; })
                  .catch(()=>{ tooltip.textContent='ë²ˆì—­ ì‹¤íŒ¨'; });
              }
              setTimeout(()=> span.classList.remove('force-tooltip'), 3000);
          }
      };

      if(!knownKo){
        span.addEventListener('mouseenter',async()=>{
          if(span.dataset.fetched)return; span.dataset.fetched=true;
          try{
            const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q=${encodeURIComponent(item.word)}`);
            const data = await r.json();
            tooltip.textContent = data[0][0][0] || 'ëœ» ì •ë³´ ì—†ìŒ';
            tooltip.classList.remove('loading');
          }catch{tooltip.textContent='ë²ˆì—­ ì‹¤íŒ¨';}
        });
      }
      el.appendChild(span);
    });
  }
  const mergeWords = (...arrays) => {
    const map = new Map();
    arrays.flat().forEach(item => { if(item && item.word && item.word.toLowerCase() !== w.en.toLowerCase()) { map.set(item.word.toLowerCase(), item); } });
    return Array.from(map.values());
  };
  renderChips('ar-synonyms', mergeWords(dictSyns, syn1, syn2).slice(0, 20), 'chip-syn');
  renderChips('ar-antonyms', mergeWords(dictAnts, ants).slice(0, 15), 'chip-ant');
  renderChips('ar-related', mergeWords(rel1, rel2).slice(0, 20), 'chip-rel');
  renderChips('ar-collocations', mergeWords(col1, col2, col3, col4).slice(0, 20), 'chip-freq');
  
  const recs=[...newCands].slice(0,25);
  document.getElementById('ar-recommendations').innerHTML=recs.length?recs.map(x=>`<button class="chip chip-new shadow-sm" onclick="quickAdd('${x.replace(/'/g,"\\'")}')">+ ${x}</button>`).join(''):'<span class="text-sm text-gray-500">ì¶”ì²œí•  ìƒˆ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
  const scrollContainer = document.getElementById('analysis-result').parentElement;
  if (scrollContainer) scrollContainer.scrollTop = 0;
}
function quickAdd(en){switchTab('manage');document.getElementById('input-en').value=en;document.getElementById('input-ko').focus();}
</script>

<!-- ========================================== -->
<!-- 2. í´ë¼ìš°ë“œ ë™ê¸°í™” ëª¨ë“ˆ (Firebase ì—°ë™)     -->
<!-- ========================================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDlMAr0qMwr3uRL_bodm8gkyewo85OlTlc",
    authDomain: "myvocaapp-d418d.firebaseapp.com",
    projectId: "myvocaapp-d418d",
    storageBucket: "myvocaapp-d418d.firebasestorage.app",
    messagingSenderId: "841954793233",
    appId: "1:841954793233:web:2748be6eb03308e0895eb0",
    measurementId: "G-5HJ2VLZHHF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let isInitialCloudLoad = true;
  let unsubscribeSnapshot = null;

  const cloudDot = document.getElementById('cloud-dot');
  const cloudStatusText = document.getElementById('cloud-status-text');

  const updateCloudStatus = (color, text) => {
      cloudDot.className = `w-2 h-2 rounded-full bg-${color}-500 transition-colors duration-300 shadow-[0_0_8px_currentColor]`;
      cloudStatusText.textContent = text;
  };

  signInAnonymously(auth).catch((error) => {
      console.error("ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
      updateCloudStatus('rose', 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
      if (error.code === 'auth/operation-not-allowed') {
          window.showToast("Firebase ì½˜ì†”ì—ì„œ 'ìµëª… ë¡œê·¸ì¸'ì„ ì¼œì£¼ì„¸ìš”!", "error");
      } else {
          window.showToast("í´ë¼ìš°ë“œ ì—°ê²° ì‹¤íŒ¨: " + error.message, "error");
      }
  });

  onAuthStateChanged(auth, (user) => {
      if (user) {
          setupRealtimeSync();
      }
  });

  function setupRealtimeSync() {
      updateCloudStatus('amber', 'ë™ê¸°í™” ì—°ê²° ì¤‘...');
      const docRef = doc(db, 'shared_wordbook', 'my_private_data');

      if (unsubscribeSnapshot) unsubscribeSnapshot();
      
      unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
          updateCloudStatus('emerald', 'ë™ê¸°í™” ì™„ë£Œ â˜ï¸');
          if (docSnap.exists()) {
              const data = docSnap.data();
              if (data.wordsList) {
                  try {
                      const cloudWords = JSON.parse(data.wordsList);
                      window.updateFromCloud(cloudWords);
                      if(isInitialCloudLoad) { window.showToast("â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ!"); }
                  } catch(e) { console.error("ë°ì´í„° íŒŒì‹± ì—ëŸ¬", e); }
              }
          } else {
              if (window.words && window.words.length > 0) {
                  window.triggerCloudSave(window.words);
                  window.showToast("â˜ï¸ ê¸°ì¡´ ë‹¨ì–´ë¥¼ í´ë¼ìš°ë“œì— ë°±ì—…í–ˆìŠµë‹ˆë‹¤.");
              }
          }
          isInitialCloudLoad = false;
      }, (error) => {
          console.error("ë™ê¸°í™” ìˆ˜ì‹  ì—ëŸ¬:", error);
          updateCloudStatus('rose', 'ì˜¤í”„ë¼ì¸ (ì—ëŸ¬)');
      });
  }

  window.triggerCloudSave = (wordsArray) => {
      updateCloudStatus('indigo', 'ì €ì¥ ì¤‘... â˜ï¸');
      const docRef = doc(db, 'shared_wordbook', 'my_private_data');
      setDoc(docRef, { wordsList: JSON.stringify(wordsArray) })
        .then(() => { updateCloudStatus('emerald', 'ë™ê¸°í™” ì™„ë£Œ â˜ï¸'); })
        .catch(error => {
            console.error("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨:", error);
            updateCloudStatus('rose', 'ì €ì¥ ì‹¤íŒ¨');
        });
  };
</script>
</body>
</html>