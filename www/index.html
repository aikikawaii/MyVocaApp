<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .fade-in{animation:fadeIn .3s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .no-scrollbar::-webkit-scrollbar{display:none}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  .game-btn{transition:all .2s}
  .game-btn:active{transform:scale(.97)}
  .correct-answer{background:#10b981!important;color:#fff!important;border-color:#10b981!important}
  .wrong-answer{background:#f43f5e!important;color:#fff!important;border-color:#f43f5e!important}
  /* chips */
  .chip{display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:9999px;
        font-size:.78rem;font-weight:700;cursor:pointer;transition:all .15s;border:2px solid transparent;
        position:relative}
  .chip:hover{filter:brightness(.92);transform:scale(1.04)}
  /* í˜¸ë²„ íˆ´íŒ */
  .chip-tooltip{
    position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
    background:#1e1b4b;color:#fff;font-size:.72rem;font-weight:600;white-space:nowrap;
    padding:4px 10px;border-radius:8px;pointer-events:none;
    opacity:0;transition:opacity .15s;z-index:50;letter-spacing:.01em;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
  }
  .chip-tooltip::after{
    content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);
    border:5px solid transparent;border-top-color:#1e1b4b;
  }
  .chip:hover .chip-tooltip{opacity:1;}
  .chip-tooltip.loading{color:#a5b4fc;}
  .chip-syn{background:#ede9fe;color:#7c3aed}
  .chip-ant{background:#fee2e2;color:#dc2626}
  .chip-rel{background:#d1fae5;color:#059669}
  .chip-freq{background:#fef9c3;color:#b45309}
  .chip-new{background:#e0f2fe;color:#0369a1}
  /* skeleton */
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .skeleton{animation:pulse 1.5s infinite;background:#e5e7eb;border-radius:8px}
  .sim-bar{height:6px;border-radius:9999px;transition:width .5s ease}
  /* fill blank */
  .fill-blank{display:inline-block;min-width:80px;border-bottom:3px solid #6366f1;
              color:#6366f1;font-weight:900;text-align:center;padding:0 6px;letter-spacing:.05em}
  .fill-opt{transition:all .2s;border:2px solid #e5e7eb}
  .fill-opt:hover:not(:disabled){border-color:#6366f1;background:#eef2ff}
  .fill-opt.correct{background:#d1fae5!important;border-color:#10b981!important;color:#065f46!important}
  .fill-opt.wrong{background:#fee2e2!important;border-color:#f43f5e!important;color:#9f1239!important}
</style>
</head>
<body class="bg-gray-200 text-gray-800 font-sans h-screen w-screen flex items-center justify-center p-4 sm:p-8 overflow-hidden">
<!-- ë°ìŠ¤í¬íƒ‘ ë¹„ìœ¨ ì¤‘ì•™ ë°°ì¹˜ ì°½ -->
<div class="w-full max-w-5xl h-full max-h-[85vh] min-h-[600px] bg-white shadow-2xl rounded-2xl flex flex-col overflow-hidden border border-gray-300">

<!-- í—¤ë” -->
<header class="bg-indigo-600 text-white px-5 py-4 text-center shadow-md z-10 flex-shrink-0 relative">
  <!-- ì¢Œìƒë‹¨ ì„¤ëª…ì„œ(Info) ë²„íŠ¼ -->
  <button onclick="openInfoModal()" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/80 hover:text-white transition-colors" title="í”„ë¡œê·¸ë¨ ì„¤ëª…ì„œ ë³´ê¸°">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  </button>
  <h1 class="text-xl font-bold tracking-wide">ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥ ğŸ“š</h1>
</header>

<!-- íƒ­ (5ê°œ) -->
<div class="flex border-b border-gray-200 bg-white z-10 flex-shrink-0" style="font-size:14px">
  <button id="tab-manage"   class="flex-1 py-3 font-bold text-indigo-600 border-b-4 border-indigo-600 transition-colors hover:bg-indigo-50" onclick="switchTab('manage')">ë‹¨ì–´ ğŸ“</button>
  <button id="tab-test"     class="flex-1 py-3 font-bold text-gray-400 border-b-4 border-transparent transition-colors hover:bg-gray-50 hover:text-gray-600" onclick="switchTab('test')">í•™ìŠµ ğŸ²</button>
  <button id="tab-quiz"     class="flex-1 py-3 font-bold text-gray-400 border-b-4 border-transparent transition-colors hover:bg-gray-50 hover:text-gray-600" onclick="switchTab('quiz')">ì‚¬ì§€ì„ ë‹¤ ğŸ¯</button>
  <button id="tab-fill"     class="flex-1 py-3 font-bold text-gray-400 border-b-4 border-transparent transition-colors hover:bg-gray-50 hover:text-gray-600" onclick="switchTab('fill')">ë¹ˆì¹¸ âœï¸</button>
  <button id="tab-analysis" class="flex-1 py-3 font-bold text-gray-400 border-b-4 border-transparent transition-colors hover:bg-gray-50 hover:text-gray-600" onclick="switchTab('analysis')">ë¶„ì„ ğŸ”¬</button>
</div>

<!-- ===== 1. ê´€ë¦¬ ===== -->
<div id="view-manage" class="flex-1 flex flex-col p-6 overflow-hidden fade-in bg-gray-50">
  <div class="bg-white p-5 rounded-xl mb-4 flex-shrink-0 shadow-sm border border-gray-100">
    <!-- ê°€ë¡œë¡œ ë„“ì–´ì§„ ì¸í’‹ ì˜ì—­ -->
    <div class="flex flex-col sm:flex-row gap-4">
      <input id="input-en" type="text" placeholder="ì˜ì–´ ë‹¨ì–´ (ì˜ˆ: Apple)" class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 focus:bg-white transition-all">
      <input id="input-ko" type="text" placeholder="í•œêµ­ì–´ ëœ» (ì˜ˆ: ì‚¬ê³¼)" class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 focus:bg-white transition-all" onkeypress="if(event.key==='Enter')addWord()">
      <button onclick="addWord()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 active:scale-95 transition-all shadow-md whitespace-nowrap">ë‹¨ì–´ ì¶”ê°€í•˜ê¸° â•</button>
    </div>
  </div>
  
  <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3 text-sm px-2 flex-shrink-0">
    <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start">
      <span class="font-semibold text-gray-600 text-base whitespace-nowrap">ì´ <span id="word-count" class="text-indigo-600 font-bold text-lg">0</span>ë‹¨ì–´</span>
      <select id="sort-select" onchange="currentPage=1;renderWords()" class="bg-white border border-gray-300 text-gray-600 py-1.5 px-3 rounded-md focus:outline-none font-medium cursor-pointer shadow-sm">
        <option value="newest">ìµœì‹ ìˆœ</option>
        <option value="wrongCount">ì˜¤ë‹µìˆœ</option>
      </select>
    </div>
    <!-- ê²€ìƒ‰ì°½ ì˜ì—­ ì¶”ê°€ -->
    <div class="relative w-full sm:max-w-xs flex-1">
      <input id="search-manage" type="text" placeholder="ì…ë ¥í•œ ë‹¨ì–´ ì°¾ê¸°..." oninput="currentPage=1;renderWords()" class="w-full border border-gray-300 rounded-lg py-2 pl-9 pr-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white shadow-sm transition-all text-sm">
      <span class="absolute left-3 top-2.5 text-gray-400 text-sm">ğŸ”</span>
    </div>
    <div class="flex gap-2 w-full sm:w-auto justify-end">
      <button onclick="exportData()" class="text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100 transition-colors whitespace-nowrap">ë‚´ë³´ë‚´ê¸° ğŸ“¤</button>
      <button onclick="document.getElementById('file-upload').click()" class="text-emerald-600 bg-emerald-50 px-3 py-2 rounded-lg text-sm font-bold hover:bg-emerald-100 transition-colors whitespace-nowrap">ë¶ˆëŸ¬ì˜¤ê¸° ğŸ“¥</button>
      <input type="file" id="file-upload" class="hidden" accept=".json" onchange="importData(event)">
    </div>
  </div>
  
  <!-- ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸: ë„“ì€ í™”ë©´ì— ë§ì¶° ê·¸ë¦¬ë“œë¡œ ë³€ê²½ -->
  <ul id="word-list" class="flex-1 overflow-y-auto no-scrollbar grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-2 content-start px-1"></ul>
  
  <div id="pagination-controls" class="flex justify-between items-center pt-4 border-t border-gray-200 hidden flex-shrink-0 mt-2">
    <button onclick="changePage(-1)" id="btn-prev" class="px-6 py-2.5 bg-white text-indigo-600 rounded-xl text-sm font-bold border-2 border-indigo-100 hover:bg-indigo-50 disabled:opacity-40 disabled:hover:bg-white transition-all" disabled>ì´ì „</button>
    <span id="page-info" class="text-base text-gray-500 font-bold bg-white px-4 py-1.5 rounded-full shadow-sm border border-gray-100">1 / 1</span>
    <button onclick="changePage(1)"  id="btn-next" class="px-6 py-2.5 bg-white text-indigo-600 rounded-xl text-sm font-bold border-2 border-indigo-100 hover:bg-indigo-50 disabled:opacity-40 disabled:hover:bg-white transition-all">ë‹¤ìŒ</button>
  </div>
</div>

<!-- ===== 2. í•™ìŠµ ===== -->
<div id="view-test" class="flex-1 flex flex-col p-6 hidden bg-gray-50 overflow-y-auto no-scrollbar">
  <div id="test-intro" class="flex-1 flex flex-col items-center justify-center fade-in">
    <div class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 w-full max-w-2xl text-center">
      <div class="text-6xl mb-6">ğŸ§ </div>
      <h2 class="text-3xl font-bold mb-3">ëœë¤ í”Œë˜ì‹œì¹´ë“œ</h2>
      <p class="text-gray-500 mb-10 text-base">ë‹¨ì–´ë¥¼ ë³´ê³  ëœ»ì„ ë§í˜€ë³´ì„¸ìš”.</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="startTest('all')"   class="flex-1 bg-indigo-600 text-white font-bold py-5 rounded-xl hover:bg-indigo-700 active:scale-95 shadow-md text-lg">ì „ì²´ ë³µìŠµ ğŸš€</button>
        <button onclick="startTest('wrong')" class="flex-1 bg-rose-50 text-rose-600 font-bold py-5 rounded-xl hover:bg-rose-100 active:scale-95 border border-rose-200 text-lg">í‹€ë¦° ë‹¨ì–´ ë³µìŠµ ğŸ¯</button>
      </div>
    </div>
  </div>
  
  <div id="test-active" class="flex-1 flex flex-col hidden fade-in max-w-4xl mx-auto w-full h-full">
    <div class="flex justify-between mb-6 flex-shrink-0">
      <div class="bg-white px-5 py-2.5 rounded-full shadow-sm border border-gray-200 text-base font-bold text-gray-600">ì§„í–‰ <span id="test-progress" class="text-indigo-600">1/10</span></div>
      <div class="bg-white px-5 py-2.5 rounded-full shadow-sm border border-gray-200 text-base font-bold text-gray-600">âœ… <span id="test-score" class="text-emerald-600">0</span></div>
    </div>
    
    <div class="flex-1 bg-white rounded-[2rem] shadow-xl border-4 border-indigo-50 flex flex-col items-center justify-center p-10 mb-6 text-center relative min-h-[300px]">
      <h2 id="test-word-en" class="text-5xl sm:text-7xl font-black text-gray-800 mb-10">Apple</h2>
      <div class="h-28 flex items-center justify-center w-full">
        <button id="btn-reveal" onclick="revealAnswer()" class="bg-gray-100 text-gray-600 font-bold text-lg px-12 py-4 rounded-full hover:bg-gray-200 transition-colors shadow-sm">ì •ë‹µ í™•ì¸ ğŸ‘€</button>
        <p id="test-word-ko" class="text-4xl sm:text-5xl font-bold text-indigo-600 hidden fade-in">ì‚¬ê³¼</p>
      </div>
    </div>
    
    <div id="test-actions" class="flex gap-6 hidden pb-4 flex-shrink-0 h-28">
      <button onclick="markAnswer(false)" class="flex-1 bg-rose-100 text-rose-600 rounded-3xl font-bold text-xl hover:bg-rose-200 active:scale-95 flex items-center justify-center gap-3 shadow-sm transition-all"><span class="text-3xl">âŒ</span>ëª°ëì–´ìš”</button>
      <button onclick="markAnswer(true)"  class="flex-1 bg-emerald-100 text-emerald-600 rounded-3xl font-bold text-xl hover:bg-emerald-200 active:scale-95 flex items-center justify-center gap-3 shadow-sm transition-all"><span class="text-3xl">â­•</span>ì•Œì•˜ì–´ìš”</button>
    </div>
  </div>
  
  <div id="test-result" class="flex-1 flex flex-col items-center justify-center hidden fade-in">
    <div class="bg-white p-10 rounded-3xl shadow-lg text-center border border-gray-100 w-full max-w-xl">
      <div class="text-7xl mb-6">ğŸ‰</div>
      <h2 class="text-4xl font-black mb-8">í•™ìŠµ ì™„ë£Œ!</h2>
      <button onclick="resetTestView()" class="w-full bg-gray-800 text-white font-bold py-5 text-lg rounded-xl hover:bg-gray-900 active:scale-95 shadow-md">ëŒì•„ê°€ê¸°</button>
    </div>
  </div>
</div>

<!-- ===== 3. ì‚¬ì§€ì„ ë‹¤ ===== -->
<div id="view-quiz" class="flex-1 flex flex-col p-6 hidden bg-gray-50 overflow-y-auto no-scrollbar">
  <div id="quiz-intro" class="flex-1 flex flex-col items-center justify-center fade-in">
    <div class="bg-white p-10 rounded-3xl shadow-sm text-center border border-gray-100 w-full max-w-2xl">
      <div class="text-6xl mb-6">ğŸ¯</div>
      <h2 class="text-3xl font-bold mb-3">ë¬´í•œ ì‚¬ì§€ì„ ë‹¤</h2>
      <p class="text-gray-500 mb-10 text-base">ì˜ë¯¸ ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ í—·ê°ˆë¦¬ëŠ” ì„ ì§€ê°€ êµ¬ì„±ë¼ìš”!</p>
      <button onclick="startQuiz()" class="w-full bg-indigo-600 text-white font-bold py-5 text-lg rounded-xl hover:bg-indigo-700 active:scale-95 shadow-md">ì‹œì‘ ğŸš€</button>
    </div>
  </div>
  
  <div id="quiz-active" class="flex-1 flex flex-col hidden fade-in max-w-4xl mx-auto w-full h-full">
    <div class="flex justify-between items-center mb-6 flex-shrink-0">
      <div class="bg-white px-5 py-2.5 rounded-full shadow-sm border border-gray-200 text-base font-bold text-gray-600"><span id="quiz-progress" class="text-indigo-600">1ë²ˆì§¸</span></div>
      <div class="flex gap-3">
        <div class="bg-white px-5 py-2.5 rounded-full shadow-sm border border-gray-200 text-base font-bold text-gray-600">âœ… <span id="quiz-score" class="text-emerald-600">0</span></div>
        <button onclick="showQuizResult()" class="bg-rose-50 text-rose-600 px-4 py-2.5 rounded-full border border-rose-100 text-sm font-bold hover:bg-rose-100 transition-colors">ì¢…ë£Œ</button>
      </div>
    </div>
    
    <div class="bg-white rounded-[2rem] shadow-md border-4 border-indigo-50 flex flex-col items-center justify-center py-16 px-6 mb-8">
      <span class="text-base font-bold text-indigo-400 mb-4 tracking-wider">ì–´ë–¤ ëœ»ì¼ê¹Œìš”?</span>
      <h2 id="quiz-word-en" class="text-5xl sm:text-6xl font-black text-gray-800 text-center">Word</h2>
    </div>
    
    <!-- ë°ìŠ¤í¬íƒ‘ ìµœì í™”: 2x2 ê·¸ë¦¬ë“œ ë°°ì—´ -->
    <div id="quiz-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 flex-1 content-end pb-4"></div>
  </div>
  
  <div id="quiz-result" class="flex-1 flex flex-col items-center justify-center hidden fade-in">
    <div class="bg-white p-10 rounded-3xl shadow-lg text-center border border-gray-100 w-full max-w-xl">
      <div class="text-7xl mb-6" id="quiz-result-emoji">ğŸ…</div>
      <h2 class="text-4xl font-black mb-4">í€´ì¦ˆ ì¢…ë£Œ!</h2>
      <div class="bg-gray-50 rounded-2xl p-8 my-8 border border-gray-100">
        <div class="text-6xl font-black text-indigo-600"><span id="quiz-final-score">0</span><span class="text-3xl text-gray-400"> / <span id="quiz-total-score">0</span></span></div>
        <p class="font-bold text-gray-500 mt-4 text-lg" id="quiz-feedback"></p>
      </div>
      <button onclick="resetQuizView()" class="w-full bg-gray-800 text-white font-bold py-5 text-lg rounded-xl hover:bg-gray-900 active:scale-95 shadow-md transition-all">ë‹¤ì‹œ í•˜ê¸° ğŸ”„</button>
    </div>
  </div>
</div>

<!-- ===== 4. ë¹ˆì¹¸ ë„£ê¸° ===== -->
<div id="view-fill" class="flex-1 flex flex-col hidden bg-gray-50 overflow-y-auto no-scrollbar">

  <!-- ì¸íŠ¸ë¡œ -->
  <div id="fill-intro" class="flex-1 flex flex-col items-center justify-center p-6 fade-in">
    <div class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 w-full max-w-2xl text-center">
      <div class="text-6xl mb-6">âœï¸</div>
      <h2 class="text-3xl font-bold mb-4">ë¹ˆì¹¸ ë„£ê¸°</h2>
      <p class="text-gray-500 text-base leading-relaxed mb-4">ì‹¤ì œ ì˜ì–´ ì˜ˆë¬¸ ì† <span class="fill-blank px-2">ë¹ˆì¹¸</span>ì—<br>ì˜¬ë°”ë¥¸ ë‹¨ì–´ë¥¼ ê³¨ë¼ë³´ì„¸ìš”!</p>
      <p class="text-sm text-indigo-400 font-bold mb-10">ğŸ“¡ Datamuse API ì‹¤ì œ ì˜ˆë¬¸ ì‚¬ìš©</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="startFill(10)" class="flex-1 bg-indigo-600 text-white font-bold py-5 text-lg rounded-xl hover:bg-indigo-700 active:scale-95 shadow-md">10ë¬¸ì œ í’€ê¸°</button>
        <button onclick="startFill(20)" class="flex-1 bg-indigo-100 text-indigo-700 font-bold py-5 text-lg rounded-xl hover:bg-indigo-200 active:scale-95">20ë¬¸ì œ í’€ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë¡œë”© -->
  <div id="fill-loading" class="flex-1 flex-col items-center justify-center hidden">
    <div class="relative w-20 h-20 mx-auto mb-6">
      <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
      <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
    </div>
    <p class="text-base font-bold text-gray-500 text-center">ì˜ˆë¬¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    <p id="fill-loading-word" class="text-sm text-gray-400 mt-2 text-center"></p>
  </div>

  <!-- ë¬¸ì œ -->
  <div id="fill-active" class="flex-1 flex flex-col hidden fade-in max-w-4xl mx-auto w-full h-full">
    <!-- ì§„í–‰ ë°” -->
    <div class="flex items-center gap-4 px-6 pt-6 pb-4 bg-transparent flex-shrink-0">
      <div class="flex-1 bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
        <div id="fill-progress-bar" class="bg-indigo-500 h-3 rounded-full transition-all duration-500" style="width:0%"></div>
      </div>
      <span id="fill-progress-text" class="text-sm font-bold text-gray-500 whitespace-nowrap">1 / 10</span>
      <div class="bg-emerald-50 border border-emerald-200 px-3 py-1.5 rounded-full text-sm font-bold text-emerald-600 shadow-sm">âœ… <span id="fill-score">0</span></div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-6 flex flex-col justify-center">
      <!-- ì˜ˆë¬¸ (í•œê¸€ ëœ» íŒíŠ¸ ì œê±°ë¨) -->
      <div class="bg-white rounded-[2rem] shadow-md border-4 border-gray-50 p-10 text-center">
        <p class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6">ì˜ˆë¬¸</p>
        <p id="fill-sentence" class="text-2xl text-gray-800 leading-relaxed font-semibold"></p>
      </div>

      <!-- í”¼ë“œë°± -->
      <div id="fill-feedback" class="hidden rounded-2xl p-6 border-2">
        <p id="fill-feedback-text" class="font-bold text-lg mb-2"></p>
        <p class="text-sm text-gray-600 mt-2">ì „ì²´ ì˜ˆë¬¸: <span id="fill-full-sentence" class="italic text-gray-800 font-medium"></span></p>
      </div>

      <!-- ì„ íƒì§€ (2Ã—2 ê·¸ë¦¬ë“œ) -->
      <div id="fill-options" class="grid grid-cols-2 gap-4 mt-auto"></div>
    </div>

    <div class="px-6 pb-6 flex-shrink-0">
      <button id="fill-next-btn" onclick="nextFillQuestion()" class="hidden w-full bg-gray-800 text-white font-bold py-5 text-lg rounded-xl hover:bg-gray-900 active:scale-95 transition-all shadow-md">ë‹¤ìŒ ë¬¸ì œ â†’</button>
    </div>
  </div>

  <!-- ê²°ê³¼ -->
  <div id="fill-result" class="flex-1 flex flex-col items-center justify-center hidden fade-in p-6">
    <div class="bg-white p-10 rounded-3xl shadow-lg text-center border border-gray-100 w-full max-w-xl">
      <div class="text-7xl mb-6" id="fill-result-emoji">ğŸ‰</div>
      <h2 class="text-4xl font-black mb-3">ì™„ë£Œ!</h2>
      <div class="bg-gray-50 rounded-2xl p-8 my-8 border border-gray-100">
        <p class="text-gray-500 font-bold mb-2">ìµœì¢… ì ìˆ˜</p>
        <p class="text-6xl font-black text-indigo-600"><span id="fill-final-score">0</span><span class="text-3xl text-gray-300"> / <span id="fill-final-total">10</span></span></p>
        <p class="text-base font-bold text-gray-600 mt-5" id="fill-result-msg"></p>
      </div>
      <button onclick="resetFillView()" class="w-full bg-gray-800 text-white font-bold py-5 text-lg rounded-xl hover:bg-gray-900 active:scale-95 shadow-md">ë‹¤ì‹œ í•˜ê¸° ğŸ”„</button>
    </div>
  </div>
</div>

<!-- ===== 5. ë¶„ì„ ===== -->
<div id="view-analysis" class="flex-1 flex flex-col hidden bg-gray-50 overflow-hidden">

  <!-- ë‹¨ì–´ ì„ íƒ í—¤ë”: ìŠ¤í¬ë¡¤ ì˜ì—­ í™•ì¥ì„ ìœ„í•´ ì—¬ë°±ê³¼ íŒ¨ë”© ìµœì†Œí™” -->
  <div class="p-4 sm:p-5 bg-white border-b border-gray-200 flex-shrink-0 shadow-sm z-20">
    <div class="max-w-4xl mx-auto w-full">
      <p class="text-xs sm:text-sm font-bold text-gray-400 mb-2 uppercase tracking-widest">ë¶„ì„í•  ë‹¨ì–´</p>
      <div class="relative">
        <input id="analysis-search" type="text" placeholder="ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”..."
          class="w-full border-2 border-gray-200 rounded-xl p-3 pr-10 text-sm sm:text-base focus:outline-none focus:border-indigo-400 bg-gray-50 focus:bg-white transition-all shadow-inner"
          oninput="filterAnalysisWords()" onclick="showAnalysisDropdown()">
        <span class="absolute right-4 top-3.5 text-lg text-gray-400">ğŸ”</span>
      </div>
      <div id="analysis-dropdown" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto no-scrollbar absolute w-[calc(100%-2rem)] sm:w-[calc(100%-2.5rem)] max-w-4xl left-1/2 -translate-x-1/2 z-50"></div>
      
      <!-- ì„ íƒëœ ë‹¨ì–´ íŒ¨ë„ (ì½¤íŒ©íŠ¸í™”) -->
      <div id="analysis-selected-word" class="hidden mt-3 flex items-center gap-3 bg-indigo-50 border border-indigo-100 rounded-xl px-4 py-3">
        <div class="flex-1 flex items-baseline gap-2 sm:gap-3">
          <span id="analysis-word-en-display" class="text-xl sm:text-2xl font-black text-indigo-700"></span>
          <span id="analysis-word-ko-display" class="text-sm sm:text-base font-medium text-indigo-500"></span>
        </div>
        <button onclick="clearAnalysisWord()" class="text-gray-400 hover:text-rose-500 text-xl px-2">âœ•</button>
      </div>
    </div>
  </div>

  <!-- í”Œë ˆì´ìŠ¤í™€ë”: ê¸€ì”¨ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•œ my-auto ë° í…ìŠ¤íŠ¸ ë°˜ì‘í˜• êµ¬ì¡° ì ìš© -->
  <div id="analysis-placeholder" class="flex-1 flex flex-col p-6 sm:p-8 overflow-y-auto no-scrollbar">
    <div class="max-w-xl mx-auto my-auto w-full text-center py-4">
      <div class="text-6xl sm:text-7xl mb-4 sm:mb-6">ğŸ”¬</div>
      <p class="font-bold text-gray-700 text-xl sm:text-2xl mb-3 sm:mb-4 break-keep">ë‹¨ì–´ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸í•˜ê²Œ ë¶„ì„í•´ë“œë ¤ìš”!</p>
      <p class="text-sm sm:text-base text-gray-500 leading-relaxed break-keep">ìœ ì˜ì–´ Â· ë°˜ì˜ì–´ Â· ì—°ê´€ì–´ Â· ë°œìŒê¸°í˜¸ Â· ì˜ì˜ì •ì˜<br class="hidden sm:block">ì›ì–´ë¯¼ ì˜ˆë¬¸ 3ê°œ Â· ë‚´ ë‹¨ì–´ì¥ ë‚´ ìœ ì‚¬ë„ê¹Œì§€ í•œëˆˆì— íŒŒì•…í•˜ì„¸ìš”.</p>
      
      <div class="mt-8 sm:mt-10 bg-white rounded-2xl p-5 sm:p-6 w-full text-left border border-gray-200 shadow-sm">
        <p class="text-xs sm:text-sm font-bold text-gray-400 mb-3 sm:mb-4 uppercase tracking-wider">ì‚¬ìš© API (ë¬´ë£ŒÂ·í‚¤ ë¶ˆí•„ìš”)</p>
        <div class="space-y-3">
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 text-sm text-gray-600">
            <span class="bg-violet-100 text-violet-700 px-3 py-1 rounded-full font-bold w-max text-xs sm:text-sm">Dictionary</span>
            <span class="text-xs sm:text-sm break-keep">ë‹¨ì–´ ì •ì˜ Â· ë°œìŒê¸°í˜¸ Â· ì›ì–´ë¯¼ ì˜ˆë¬¸</span>
          </div>
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 text-sm text-gray-600">
            <span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold w-max text-xs sm:text-sm">Datamuse</span>
            <span class="text-xs sm:text-sm break-keep">ìœ ì˜ì–´ Â· ë°˜ì˜ì–´ Â· ìì£¼ í•¨ê»˜ ì“°ì´ëŠ” ì—°ê´€ì–´</span>
          </div>
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 text-sm text-gray-600">
            <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold w-max text-xs sm:text-sm">Google Tr.</span>
            <span class="text-xs sm:text-sm break-keep">í˜¸ë²„ë§ ì‹œ ì‹¤ì‹œê°„ í•œê¸€ ëœ» ë²ˆì—­</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¡œë”© & ê²°ê³¼ ì˜ì—­ì˜ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ -->
  <div class="flex-1 overflow-y-auto no-scrollbar relative p-4 sm:p-6">
    <div class="max-w-4xl mx-auto w-full">
      
      <!-- ë¡œë”© -->
      <div id="analysis-loading" class="space-y-6 hidden">
        <div class="bg-white rounded-2xl p-6 sm:p-8 shadow-sm border border-gray-100 space-y-4">
          <div class="skeleton h-10 w-48 mb-6"></div>
          <div class="skeleton h-5 w-32"></div>
          <div class="skeleton h-5 w-full"></div>
          <div class="skeleton h-5 w-5/6"></div>
          <div class="skeleton h-5 w-4/6"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-4">
            <div class="skeleton h-4 w-24 mb-4"></div>
            <div class="flex gap-2 flex-wrap"><div class="skeleton h-10 w-24 rounded-full"></div><div class="skeleton h-10 w-20 rounded-full"></div></div>
          </div>
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-4">
            <div class="skeleton h-4 w-24 mb-4"></div>
            <div class="flex gap-2 flex-wrap"><div class="skeleton h-10 w-24 rounded-full"></div></div>
          </div>
        </div>
      </div>

      <!-- ê²°ê³¼ -->
      <div id="analysis-result" class="space-y-6 hidden pb-8 fade-in">
        
        <!-- ë°ìŠ¤í¬íƒ‘ ìµœì í™”: ìœ—ë¶€ë¶„ 2ë‹¨ ë ˆì´ì•„ì›ƒ ë¶„ë¦¬ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <!-- ì¢Œì¸¡: â‘  ê¸°ë³¸ ì •ë³´ + ì˜ˆë¬¸ 3ê°œ (ë„“ê²Œ) -->
          <div class="lg:col-span-2 bg-white rounded-[2rem] shadow-sm border border-gray-100 p-6 sm:p-8">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 id="ar-word" class="text-3xl sm:text-4xl font-black text-gray-800 tracking-tight"></h3>
                <p id="ar-phonetic" class="text-base sm:text-lg text-indigo-400 font-mono mt-1 font-medium"></p>
              </div>
              <button id="ar-audio-btn" class="hidden bg-indigo-50 text-indigo-600 border border-indigo-100 px-4 py-2 rounded-full text-sm font-bold hover:bg-indigo-100 transition-colors flex-shrink-0 flex items-center gap-2">ğŸ”Š <span class="hidden sm:inline">ì›ì–´ë¯¼ ë°œìŒ</span></button>
            </div>
            <span id="ar-partOfSpeech" class="inline-block text-xs sm:text-sm font-bold text-white bg-indigo-500 px-3 py-1.5 rounded-full mb-4 shadow-sm"></span>
            <p id="ar-definition" class="text-sm sm:text-base text-gray-700 leading-relaxed mb-6 font-medium"></p>
            
            <div class="border-t border-gray-100 pt-6">
              <p class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">ğŸ“ ì‹¤ìƒí™œ ì˜ˆë¬¸</p>
              <div id="ar-examples" class="space-y-4"></div>
            </div>
          </div>

          <!-- ìš°ì¸¡: â‘¡ ë‹¨ì–´ì¥ ë‚´ ìœ ì‚¬ë„ (ì‚¬ì´ë“œ íŒ¨ë„ ëŠë‚Œ) -->
          <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 p-6 flex flex-col">
            <p class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-5">ğŸ“š ë‚´ ë‹¨ì–´ì¥ ìœ ì‚¬ë„</p>
            <div id="ar-internal-list" class="space-y-4 flex-1 overflow-y-auto no-scrollbar pr-1"></div>
          </div>
        </div> <!-- End of top Grid -->

        <!-- í•˜ë‹¨: â‘¢â‘£â‘¤â‘¥ ì¹© (2x2 ê·¸ë¦¬ë“œ) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2"><span>ğŸ”µ</span><p class="text-sm font-bold text-violet-600 uppercase tracking-widest">ìœ ì˜ì–´</p></div>
              <span class="text-xs text-gray-400">ëœ»ì´ ë¹„ìŠ·í•œ ë‹¨ì–´</span>
            </div>
            <div id="ar-synonyms" class="flex flex-wrap gap-2"></div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2"><span>ğŸ”´</span><p class="text-sm font-bold text-rose-600 uppercase tracking-widest">ë°˜ì˜ì–´</p></div>
              <span class="text-xs text-gray-400">ë°˜ëŒ€ ì˜ë¯¸</span>
            </div>
            <div id="ar-antonyms" class="flex flex-wrap gap-2"></div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2"><span>ğŸŸ¢</span><p class="text-sm font-bold text-emerald-600 uppercase tracking-widest">ì—°ê´€ì–´</p></div>
              <span class="text-xs text-gray-400">ìì£¼ í•¨ê»˜ ì“°ì´ëŠ”</span>
            </div>
            <div id="ar-related" class="flex flex-wrap gap-2"></div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2"><span>ğŸŸ¡</span><p class="text-sm font-bold text-amber-600 uppercase tracking-widest">ë¹ˆì¶œ ë™ë°˜ì–´</p></div>
              <span class="text-xs text-gray-400">ìì£¼ ìˆ˜ì‹í•˜ëŠ” ë‹¨ì–´</span>
            </div>
            <div id="ar-collocations" class="flex flex-wrap gap-2"></div>
          </div>
        </div>

        <!-- â‘¦ ì¶”ì²œ ë‹¨ì–´ (ì „ì²´ í­) -->
        <div class="bg-gradient-to-r from-indigo-50 via-white to-violet-50 rounded-2xl border border-indigo-100 p-6 sm:p-8 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-sm font-bold text-indigo-600 uppercase tracking-widest mb-1">âœ¨ ë‹¨ì–´ì¥ ì¶”ê°€ ì¶”ì²œ</p>
              <p class="text-xs sm:text-sm text-gray-500 break-keep">ì•„ì§ ë‚´ ë‹¨ì–´ì¥ì— ì—†ëŠ” ê´€ë ¨ ë‹¨ì–´ë“¤ì´ì—ìš”. í´ë¦­í•´ì„œ ë°”ë¡œ ì¶”ê°€í•˜ì„¸ìš”!</p>
            </div>
          </div>
          <div id="ar-recommendations" class="flex flex-wrap gap-3 mt-4"></div>
        </div>

      </div>
    </div>
  </div>

</div>

</div><!-- /wrapper -->

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="delete-modal" class="fixed inset-0 bg-black/40 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-4 shadow-2xl transform scale-95 transition-transform duration-200" id="delete-modal-content">
    <div class="text-center mb-6">
      <div class="text-5xl mb-4">ğŸ—‘ï¸</div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
      <p class="text-sm text-gray-500">ì‚­ì œí•œ ë‹¨ì–´ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <div class="flex gap-3">
      <button onclick="closeDeleteModal()" class="flex-1 bg-gray-100 text-gray-700 font-bold py-3.5 rounded-xl hover:bg-gray-200 active:scale-95 transition-all">No</button>
      <button onclick="executeDelete()" class="flex-1 bg-rose-500 text-white font-bold py-3.5 rounded-xl hover:bg-rose-600 active:scale-95 transition-all shadow-md">Yes</button>
    </div>
  </div>
</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="edit-modal" class="fixed inset-0 bg-black/40 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-4 shadow-2xl transform scale-95 transition-transform duration-200" id="edit-modal-content">
    <div class="text-center mb-5">
      <div class="text-5xl mb-3">âœï¸</div>
      <h3 class="text-xl font-bold text-gray-800">ë‹¨ì–´ ìˆ˜ì •</h3>
    </div>
    <div class="flex flex-col gap-3 mb-6">
      <input id="edit-en" type="text" placeholder="ì˜ì–´ ë‹¨ì–´" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 focus:bg-white transition-all font-bold">
      <input id="edit-ko" type="text" placeholder="í•œêµ­ì–´ ëœ»" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 focus:bg-white transition-all" onkeypress="if(event.key==='Enter')saveEditWord()">
    </div>
    <div class="flex gap-3">
      <button onclick="closeEditModal()" class="flex-1 bg-gray-100 text-gray-700 font-bold py-3.5 rounded-xl hover:bg-gray-200 active:scale-95 transition-all">ì·¨ì†Œ</button>
      <button onclick="saveEditWord()" class="flex-1 bg-indigo-600 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 active:scale-95 transition-all shadow-md">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ì„¤ëª…ì„œ ëª¨ë‹¬ (Info Modal) -->
<div id="info-modal" class="fixed inset-0 bg-black/40 z-[250] flex items-center justify-center hidden opacity-0 transition-opacity duration-200 backdrop-blur-sm">
  <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[85vh] mx-4 shadow-2xl transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden" id="info-modal-content">
    <div class="flex justify-between items-center p-5 border-b border-gray-100 bg-indigo-50">
      <h2 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥ ì„¤ëª…ì„œ
      </h2>
      <button onclick="closeInfoModal()" class="text-gray-400 hover:text-rose-500 transition-colors p-1" title="ë‹«ê¸°">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    
    <div class="p-6 overflow-y-auto no-scrollbar text-gray-700 space-y-6 leading-relaxed text-sm">
      <p> <strong>ë‚˜ë§Œì˜ ì˜ë‹¨ì–´ì¥</strong> ì€ ì‚¬ìš©ìê°€ ì§ì ‘ ë‹¨ì–´ë¥¼ ê´€ë¦¬í•˜ê³ , AI ì˜ë¯¸ ìœ ì‚¬ë„ ì•Œê³ ë¦¬ì¦˜ê³¼ ì˜¤í”ˆ API ì—°ë™ìœ¼ë¡œ ì…ì²´ì ì¸ ì–´íœ˜ í•™ìŠµì„ ë•ëŠ” ìŠ¤ë§ˆíŠ¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤. ë‹¨ìˆœ ì•”ê¸°ë¥¼ ë„˜ì–´, ì·¨ì•½ì  ë¶„ì„ê³¼ ì‹¤ìƒí™œ ì˜ˆë¬¸ìœ¼ë¡œ ë‹¨ì–´ë¥¼ ê¹Šì´ ìˆê²Œ ì´í•´í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      
      <h4 class="text-base font-bold text-indigo-600 border-b pb-2">ğŸŒŸ ì£¼ìš” ê¸°ëŠ¥ ì•ˆë‚´</h4>
      <div class="space-y-4">
        <div>
          <p class="font-bold text-gray-800">ğŸ“ 1. ë‹¨ì–´ (ê´€ë¦¬ íƒ­)</p>
          <ul class="list-disc list-inside ml-2 text-gray-600 mt-1">
            <li><strong>ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ:</strong> ì˜ë‹¨ì–´ì™€ ëœ»ì„ ì‰½ê²Œ ì¶”ê°€í•˜ê³ , ìˆ˜ì • ë° ì‚­ì œ ëª¨ë‹¬ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
            <li><strong>ê²€ìƒ‰ ë° ì •ë ¬:</strong> ë‹¨ì–´ë¥¼ ì¦‰ì‹œ ì°¾ê³ , 'ìµœì‹ ìˆœ' ë˜ëŠ” 'ì˜¤ë‹µìˆœ' ì •ë ¬ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
            <li><strong>ë°ì´í„° ë°±ì—…:</strong> íŒŒì¼ í˜•íƒœì˜ ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë³´ê´€í•©ë‹ˆë‹¤.</li>
          </ul>
        </div>
        
        <div>
          <p class="font-bold text-gray-800">ğŸ² 2. í•™ìŠµ (í”Œë˜ì‹œì¹´ë“œ íƒ­)</p>
          <ul class="list-disc list-inside ml-2 text-gray-600 mt-1">
            <li><strong>ë§ì¶¤í˜• ë³µìŠµ:</strong> 'ì „ì²´ ë³µìŠµ' ë° 'í‹€ë¦° ë‹¨ì–´ ë³µìŠµ' ëª¨ë“œë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</li>
            <li><strong>ì§ê´€ì  í”¼ë“œë°±:</strong> ì •ë‹µ í™•ì¸ í›„ ì•Œì•˜ì–´ìš”/ëª°ëì–´ìš” ë¡œ í‰ê°€í•˜ë©°, ì˜¤ë‹µì€ ìë™ ëˆ„ì ë©ë‹ˆë‹¤.</li>
          </ul>
        </div>
        
        <div>
          <p class="font-bold text-gray-800">ğŸ¯ 3. ì‚¬ì§€ì„ ë‹¤ (ê°ê´€ì‹ í€´ì¦ˆ íƒ­)</p>
          <ul class="list-disc list-inside ml-2 text-gray-600 mt-1">
            <li><strong>ìŠ¤ë§ˆíŠ¸ ì˜¤ë‹µ ì„ ì§€:</strong> ì•Œê³ ë¦¬ì¦˜ê³¼ í˜¼ë™ ê¸°ë¡ì„ ë¶„ì„í•´ í—·ê°ˆë¦¬ê¸° ì‰¬ìš´ ë§¤ë ¥ì ì¸ ì˜¤ë‹µì„ ìë™ êµ¬ì„±í•©ë‹ˆë‹¤.</li>
          </ul>
        </div>
        
        <div>
          <p class="font-bold text-gray-800">âœï¸ 4. ë¹ˆì¹¸ (ì˜ˆë¬¸ í•™ìŠµ íƒ­)</p>
          <ul class="list-disc list-inside ml-2 text-gray-600 mt-1">
            <li><strong>ì‹¤ìƒí™œ ì˜ˆë¬¸ í™œìš©:</strong> ì™¸ë¶€ APIë¥¼ í†µí•´ ì›ì–´ë¯¼ ì˜ˆë¬¸ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</li>
            <li><strong>ë¬¸ë§¥ ì¶”ë¡  í›ˆë ¨:</strong> ë¹ˆì¹¸ì— ì•Œë§ì€ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ë©° ë…í•´ë ¥ê³¼ ë¬¸ë§¥ íŒŒì•… ëŠ¥ë ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.</li>
          </ul>
        </div>
        
        <div>
          <p class="font-bold text-gray-800">ğŸ”¬ 5. ë¶„ì„ (ì‹¬ì¸µ í•™ìŠµ íƒ­)</p>
          <ul class="list-disc list-inside ml-2 text-gray-600 mt-1">
            <li><strong>ìƒì„¸ ì •ë³´ ì œê³µ:</strong> ì›ì–´ë¯¼ ìŒì„± ë°œìŒ, ì˜ì˜ ì •ì˜, ì‹¤ìƒí™œ ì˜ˆë¬¸ì„ ì œê³µí•©ë‹ˆë‹¤.</li>
            <li><strong>ê´€ê³„ì–´ í™•ì¥:</strong> ìœ ì˜ì–´, ë°˜ì˜ì–´, ì—°ê´€ì–´, ë¹ˆì¶œ ë™ë°˜ì–´ë¥¼ í•œëˆˆì— ë³´ì—¬ì¤ë‹ˆë‹¤.</li>
            <li><strong>ìœ ì‚¬ë„ ë¹„êµ ë° ì¶”ì²œ:</strong> ë‚´ ë‹¨ì–´ì¥ ë‚´ ìœ ì‚¬ ë‹¨ì–´ë¥¼ ë§¤ì¹­í•´ì£¼ë©°, í•œê¸€ ëœ» ë²ˆì—­ë„ ì œê³µë©ë‹ˆë‹¤.</li>
          </ul>
        </div>
      </div>

      <h4 class="text-base font-bold text-indigo-600 border-b pb-2">ğŸ›  ê¸°ìˆ  ë° í™˜ê²½ì  íŠ¹ì§•</h4>
      <ul class="list-disc list-inside ml-2 text-gray-600">
        <li><strong>ë‹¤ì¤‘ API ì—°ë™:</strong> Dictionary, Datamuse, Google Translate ë°ì´í„°ë¥¼ ë³‘í•©í•´ ì œê³µí•©ë‹ˆë‹¤.</li>
        <li><strong>ì„œë²„ë¦¬ìŠ¤(Serverless):</strong> ë³„ë„ íšŒì›ê°€ì… ì—†ì´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ í™œìš©í•˜ì—¬ ë™ì‘í•©ë‹ˆë‹¤.</li>
        <li><strong>ë°ìŠ¤í¬íƒ‘ ìµœì í™” UI:</strong> ì»´í“¨í„° í™”ë©´ì— ë§ì¶˜ ì¾Œì í•œ ìœˆë„ìš° ë ˆì´ì•„ì›ƒì„ ì§€ì›í•©ë‹ˆë‹¤.</li>
      </ul>
    </div>
  </div>
</div>

<script>
// ================================================================
// ì „ì—­
// ================================================================
let words=[], currentPage=1;
// ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒì— ë§ì¶° í•œ í˜ì´ì§€ ì•„ì´í…œ ê°œìˆ˜ë¥¼ 12ê°œë¡œ ë³€ê²½ (1,2,3ì—´ ëª¨ë‘ ê¹”ë”í•˜ê²Œ ë–¨ì–´ì§)
const IPP=12;

// í€´ì¦ˆ
let quizQ=0,quizS=0,quizWord=null,quizQueue=[],quizIdx=0;
// í•™ìŠµ
let testQueue=[],testPool=[],testIdx=0,testCorrect=0;
// ë¹ˆì¹¸
let fillQuestions=[],fillIdx=0,fillScore=0,fillTotal=10;
let fillCurrentQ=null;
// ë¶„ì„
let analysisWord=null,audioUrl=null;

const SIM_DUP=75,SIM_CONF=50;
let simMatrix={},confMatrix={};

// ================================================================
// ìœ í‹¸
// ================================================================
function showToast(msg,type='info'){
  const t=document.createElement('div');
  t.className=`fixed bottom-10 left-1/2 -translate-x-1/2 ${type==='error'?'bg-rose-500':'bg-gray-800'} text-white px-8 py-4 rounded-full shadow-2xl z-[100] font-bold text-base`;
  t.style.cssText='opacity:0;transform:translate(-50%,20px);transition:all .3s';
  t.textContent=msg; document.body.appendChild(t);
  requestAnimationFrame(()=>{t.style.opacity='1';t.style.transform='translate(-50%,0)';});
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translate(-50%,-20px)';setTimeout(()=>t.remove(),300);},2300);
}
function shuffle(arr){let a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

// ì„¤ëª…ì„œ ëª¨ë‹¬ ê¸°ëŠ¥
function openInfoModal(){
  const modal = document.getElementById('info-modal');
  const content = document.getElementById('info-modal-content');
  modal.classList.remove('hidden');
  void modal.offsetWidth;
  modal.classList.remove('opacity-0');
  content.classList.remove('scale-95');
}
function closeInfoModal(){
  const modal = document.getElementById('info-modal');
  const content = document.getElementById('info-modal-content');
  modal.classList.add('opacity-0');
  content.classList.add('scale-95');
  setTimeout(() => modal.classList.add('hidden'), 200);
}

// ================================================================
// ë°ì´í„°
// ================================================================
function loadData(){
  const raw=localStorage.getItem('myWordbook');
  if(raw){try{words=JSON.parse(raw);}catch{words=[];}}
  else{
    words=[
      {id:1,en:'Accomplish',ko:'ì„±ì·¨í•˜ë‹¤, ì™„ìˆ˜í•˜ë‹¤',wrongCount:0},
      {id:2,en:'Fail',ko:'ì‹¤íŒ¨í•˜ë‹¤',wrongCount:1},
      {id:3,en:'Diligent',ko:'ê·¼ë©´í•œ, ì„±ì‹¤í•œ',wrongCount:3},
      {id:4,en:'Lazy',ko:'ê²Œìœ¼ë¥¸',wrongCount:0},
      {id:5,en:'Happy',ko:'í–‰ë³µí•œ, ì¦ê±°ìš´',wrongCount:0},
      {id:6,en:'Sad',ko:'ìŠ¬í”ˆ',wrongCount:0},
      {id:7,en:'Fast',ko:'ë¹ ë¥¸, ì‹ ì†í•œ',wrongCount:0},
      {id:8,en:'Slow',ko:'ëŠë¦°',wrongCount:0},
      {id:9,en:'Bright',ko:'ë°ì€, ì´ëª…í•œ',wrongCount:0},
      {id:10,en:'Dark',ko:'ì–´ë‘ìš´',wrongCount:0},
    ];
    saveData();
  }
  renderWords();
}
function saveData(){localStorage.setItem('myWordbook',JSON.stringify(words));}
function loadConf(){try{confMatrix=JSON.parse(localStorage.getItem('confMatrix')||'{}');}catch{confMatrix={};}}
function saveConf(){localStorage.setItem('confMatrix',JSON.stringify(confMatrix));}

document.addEventListener('DOMContentLoaded',()=>{loadData();loadConf();buildSimMatrix();});

// ================================================================
// íƒ­
// ================================================================
const ALL_TABS=['manage','test','quiz','fill','analysis'];
function switchTab(name){
  ALL_TABS.forEach(t=>{
    const btn=document.getElementById(`tab-${t}`),view=document.getElementById(`view-${t}`);
    if(t===name){
      btn.className='flex-1 py-3 font-bold text-indigo-600 border-b-4 border-indigo-600 bg-white';
      view.classList.remove('hidden');
    } else {
      btn.className='flex-1 py-3 font-bold text-gray-400 border-b-4 border-transparent transition-colors hover:bg-gray-50 hover:text-gray-600';
      view.classList.add('hidden');
    }
  });
  if(name!=='test')     resetTestView();
  if(name!=='quiz')     resetQuizView();
  if(name!=='fill')     { /* keep fill state */ }
  if(name!=='analysis') document.getElementById('analysis-dropdown').classList.add('hidden');
}

// ================================================================
// ê´€ë¦¬ íƒ­
// ================================================================
function addWord(){
  const enEl=document.getElementById('input-en'),koEl=document.getElementById('input-ko');
  const en=enEl.value.trim(),ko=koEl.value.trim();
  if(!en||!ko)return showToast('ì˜ì–´ ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
  words.push({id:Date.now(),en,ko,wrongCount:0});
  saveData();buildSimMatrix();currentPage=1;renderWords();
  enEl.value='';koEl.value='';enEl.focus();
  showToast('ë‹¨ì–´ ì¶”ê°€ ì™„ë£Œ! âœ¨');
}

// ì‚­ì œ ëª¨ë‹¬ ê¸°ëŠ¥
let pendingDeleteId = null;
function confirmDelete(id){
  pendingDeleteId = id;
  const modal = document.getElementById('delete-modal');
  const content = document.getElementById('delete-modal-content');
  modal.classList.remove('hidden');
  void modal.offsetWidth;
  modal.classList.remove('opacity-0');
  content.classList.remove('scale-95');
}
function closeDeleteModal(){
  const modal = document.getElementById('delete-modal');
  const content = document.getElementById('delete-modal-content');
  modal.classList.add('opacity-0');
  content.classList.add('scale-95');
  setTimeout(() => {
    modal.classList.add('hidden');
    pendingDeleteId = null;
  }, 200);
}
function executeDelete(){
  if(pendingDeleteId !== null) {
    words = words.filter(w => w.id !== pendingDeleteId);
    saveData();buildSimMatrix();renderWords();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeDeleteModal();
  }
}

// ìˆ˜ì • ëª¨ë‹¬ ê¸°ëŠ¥
let editingWordId = null;
function openEditModal(id) {
  const w = words.find(x => x.id === id);
  if(!w) return;
  editingWordId = id;
  document.getElementById('edit-en').value = w.en;
  document.getElementById('edit-ko').value = w.ko;
  const modal = document.getElementById('edit-modal');
  const content = document.getElementById('edit-modal-content');
  modal.classList.remove('hidden');
  void modal.offsetWidth;
  modal.classList.remove('opacity-0');
  content.classList.remove('scale-95');
}
function closeEditModal() {
  const modal = document.getElementById('edit-modal');
  const content = document.getElementById('edit-modal-content');
  modal.classList.add('opacity-0');
  content.classList.add('scale-95');
  setTimeout(() => {
    modal.classList.add('hidden');
    editingWordId = null;
  }, 200);
}
function saveEditWord() {
  const en = document.getElementById('edit-en').value.trim();
  const ko = document.getElementById('edit-ko').value.trim();
  if(!en || !ko) return showToast('ì˜ì–´ ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
  
  const idx = words.findIndex(w => w.id === editingWordId);
  if(idx !== -1) {
    words[idx].en = en;
    words[idx].ko = ko;
    saveData(); 
    buildSimMatrix(); // ëœ»ì´ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìœ ì‚¬ë„ ë§¤íŠ¸ë¦­ìŠ¤ ì¬ê³„ì‚°
    renderWords();
    showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. âœï¸');
    closeEditModal();
  }
}

function changePage(d){currentPage+=d;renderWords();document.getElementById('word-list').scrollTop=0;}
function renderWords(){
  const list=document.getElementById('word-list');
  const query = document.getElementById('search-manage').value.toLowerCase().trim();
  
  // ê²€ìƒ‰ í•„í„°ë§ ì ìš©
  let disp=[...words];
  if(query) {
    disp = disp.filter(w => w.en.toLowerCase().includes(query) || w.ko.includes(query));
  }
  
  document.getElementById('word-count').textContent=disp.length;
  list.innerHTML='';
  
  if(!disp.length){
    list.innerHTML='<div class="col-span-full flex flex-col items-center justify-center text-gray-400 py-20"><span class="text-4xl mb-4">ğŸ“­</span><p>ì¡°ê±´ì— ë§ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
    document.getElementById('pagination-controls').classList.add('hidden');
    return;
  }
  
  if(document.getElementById('sort-select').value==='wrongCount') disp.sort((a,b)=>(b.wrongCount||0)-(a.wrongCount||0));
  else disp.reverse();
  
  const total=Math.max(1,Math.ceil(disp.length/IPP));
  currentPage=Math.max(1,Math.min(currentPage,total));
  disp.slice((currentPage-1)*IPP,currentPage*IPP).forEach(w=>{
    const simRow=simMatrix[w.id]||{};
    const dupes=words.filter(x=>x.id!==w.id&&(simRow[x.id]||0)>=SIM_DUP);
    const wBadge=w.wrongCount>0?`<span class="px-2 py-0.5 bg-rose-100 text-rose-600 text-[10px] font-bold rounded-full">ì˜¤ë‹µ ${w.wrongCount}íšŒ</span>`:'';
    const dBadge=dupes.length?`<span class="px-2 py-0.5 bg-amber-100 text-amber-600 text-[10px] font-bold rounded-full">âš ï¸ ì¤‘ë³µ ì˜ì‹¬</span>`:'';
    const li=document.createElement('li');
    li.className='bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center fade-in hover:border-indigo-200 hover:shadow-md transition-all h-max';
    li.innerHTML=`<div class="flex flex-col flex-1 pr-3 min-w-0">
        <span class="font-bold text-xl text-gray-800 mb-1 truncate">${w.en}</span>
        <span class="text-gray-500 text-sm truncate">${w.ko}</span>
        <div class="flex gap-1.5 mt-2 flex-wrap">${wBadge}${dBadge}</div>
      </div>
      <div class="flex gap-2 flex-shrink-0">
        <button onclick="openEditModal(${w.id})" class="text-emerald-400 hover:text-emerald-600 bg-emerald-50 hover:bg-emerald-100 p-2.5 rounded-xl transition-colors" title="ë‹¨ì–´ ìˆ˜ì •">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
        </button>
        <button onclick="openAnalysis(${w.id})" class="text-indigo-400 hover:text-indigo-600 bg-indigo-50 hover:bg-indigo-100 p-2.5 rounded-xl transition-colors" title="ë‹¨ì–´ ë¶„ì„">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        </button>
        <button onclick="confirmDelete(${w.id})" class="text-rose-300 hover:text-rose-600 bg-rose-50 hover:bg-rose-100 p-2.5 rounded-xl transition-colors" title="ì‚­ì œ">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </button>
      </div>`;
    list.appendChild(li);
  });
  const pgCtrl=document.getElementById('pagination-controls');
  if(total>1){
    pgCtrl.classList.remove('hidden');
    document.getElementById('page-info').textContent=`${currentPage} / ${total}`;
    document.getElementById('btn-prev').disabled=currentPage===1;
    document.getElementById('btn-next').disabled=currentPage===total;
  } else pgCtrl.classList.add('hidden');
}
function exportData(){
  if(!words.length)return showToast('ì €ì¥í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.','error');
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify(words,null,2)],{type:'application/json'})),download:`ì˜ë‹¨ì–´ì¥_${new Date().toISOString().slice(0,10)}.json`});
  document.body.appendChild(a);a.click();a.remove();
  showToast('ë‹¨ì–´ì¥ ë°±ì—…ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤ ğŸ’¾');
}
function importData(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{try{const imp=JSON.parse(ev.target.result);if(!Array.isArray(imp))throw 0;let cnt=0;imp.forEach(iw=>{if(iw.en&&iw.ko){words.push({id:Date.now()+Math.random(),en:iw.en,ko:iw.ko,wrongCount:iw.wrongCount||0});cnt++;}});saveData();buildSimMatrix();currentPage=1;renderWords();showToast(`${cnt}ê°œì˜ ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ ğŸ“¥`);}catch{showToast('íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.','error');}};
  r.readAsText(file);e.target.value='';
}

// ================================================================
// í•™ìŠµ íƒ­
// ================================================================
function resetTestView(){testQueue=[];testPool=[];testIdx=0;testCorrect=0;['test-intro','test-active','test-result'].forEach((id,i)=>document.getElementById(id).classList[i===0?'remove':'add']('hidden'));}
function startTest(mode){
  if(!words.length)return showToast('í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!','error');
  let pool=[...words];
  if(mode==='wrong'){pool=pool.filter(w=>(w.wrongCount||0)>0);if(!pool.length)return showToast('í‹€ë¦° ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤! ëŒ€ë‹¨í•´ìš” ğŸ‰');}
  testPool=pool;testQueue=shuffle(pool);testIdx=testCorrect=0;
  document.getElementById('test-intro').classList.add('hidden');
  document.getElementById('test-active').classList.remove('hidden');
  loadTestCard();
}
function loadTestCard(){
  if(testIdx>=testQueue.length){testQueue=shuffle(testPool);testIdx=0;showToast('ë‹¨ì–´ ëª©ë¡ì„ ë‹¤ì‹œ í•œ ë°”í€´ ë•ë‹ˆë‹¤! ğŸ”');}
  const w=testQueue[testIdx];
  document.getElementById('test-progress').textContent=`${testIdx+1}/${testQueue.length}`;
  document.getElementById('test-score').textContent=testCorrect;
  document.getElementById('test-word-en').textContent=w.en;
  document.getElementById('test-word-ko').textContent=w.ko;
  document.getElementById('test-word-ko').classList.add('hidden');
  document.getElementById('btn-reveal').classList.remove('hidden');
  document.getElementById('test-actions').classList.add('hidden');
}
function revealAnswer(){document.getElementById('btn-reveal').classList.add('hidden');document.getElementById('test-word-ko').classList.remove('hidden');document.getElementById('test-actions').classList.remove('hidden');}
function markAnswer(ok){
  const w=testQueue[testIdx];
  if(ok)testCorrect++;else{const i=words.findIndex(x=>x.id===w.id);if(i!==-1){words[i].wrongCount=(words[i].wrongCount||0)+1;saveData();}}
  testIdx++;
  if(testIdx>=testQueue.length){document.getElementById('test-active').classList.add('hidden');document.getElementById('test-result').classList.remove('hidden');renderWords();}
  else{const c=document.getElementById('test-word-en').parentElement;c.style.opacity='0';setTimeout(()=>{loadTestCard();c.style.opacity='1';},180);}
}

// ================================================================
// ì˜ë¯¸ ìœ ì‚¬ë„ ì—”ì§„
// ================================================================
const KO_SUF=['ìŠ¤ëŸ½ë‹¤','ìŠ¤ëŸ¬ìš´','í•˜ë‹¤','í•˜ëŠ”','í•˜ì—¬','í•˜ê²Œ','í•œ','í•¨','íˆ','ì´ë‹¤','ì´ë€','ë˜ë‹¤','ë˜ëŠ”','ëœ','ë¨','ì ì¸','ì ìœ¼ë¡œ','ì ','ë¡­ë‹¤','ë¡œìš´','ì—†ë‹¤','ì—†ëŠ”','ìˆë‹¤','ìˆëŠ”','ì§€ë‹¤','ì§„','ã„´','ëŠ”','ì„','ë¥¼','ì´','ê°€','ì˜','ì—','ë¡œ','ê³¼','ì™€','ë„'].sort((a,b)=>b.length-a.length);
function tokenize(str){
  const tokens=new Set();
  str.split(/[,\/\s]+/).map(s=>s.trim()).filter(Boolean).forEach(c=>{
    let stem=c;for(const suf of KO_SUF){if(stem.length>suf.length&&stem.endsWith(suf)){stem=stem.slice(0,-suf.length);break;}}
    if(stem.length>=1)tokens.add(stem);
  });
  return tokens;
}
function semSim(a,b){
  const tA=tokenize(a),tB=tokenize(b);if(!tA.size||!tB.size)return 0;
  let ex=0;tA.forEach(t=>{if(tB.has(t))ex++;});
  const jac=ex/new Set([...tA,...tB]).size;
  let part=0;tA.forEach(a=>tB.forEach(b=>{if(a!==b&&(a.includes(b)||b.includes(a)))part+=0.3;}));
  const cA=new Set([...a.replace(/[,\/\s]/g,'')]),cB=new Set([...b.replace(/[,\/\s]/g,'')]);
  let co=0;cA.forEach(c=>{if(cB.has(c))co++;});
  return Math.min(100,jac*70+part*15+(co/Math.max(cA.size,cB.size))*15);
}
function buildSimMatrix(){
  simMatrix={};
  for(let i=0;i<words.length;i++)for(let j=0;j<words.length;j++){
    if(i===j)continue;const a=words[i],b=words[j];
    if(!simMatrix[a.id])simMatrix[a.id]={};
    simMatrix[a.id][b.id]=semSim(a.ko,b.ko);
  }
}

// ================================================================
// ì‚¬ì§€ì„ ë‹¤ íƒ­
// ================================================================
function resetQuizView(){quizQueue=[];quizIdx=0;document.getElementById('quiz-intro').classList.remove('hidden');document.getElementById('quiz-active').classList.add('hidden');document.getElementById('quiz-result').classList.add('hidden');}
function startQuiz(){
  if(words.length<4){showToast('ì„ íƒì§€ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ë‹¨ì–´ê°€ 4ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!','error');return;}
  quizQ=0;quizS=0;
  quizQueue=buildWQ(words);quizIdx=0;
  document.getElementById('quiz-intro').classList.add('hidden');
  document.getElementById('quiz-result').classList.add('hidden');
  document.getElementById('quiz-active').classList.remove('hidden');
  nextQuiz();
}
function buildWQ(pool){
  let bag=[];pool.forEach(w=>{const c=Math.min(4,1+(w.wrongCount||0));for(let i=0;i<c;i++)bag.push(w);});return shuffle(bag);
}
function updateConf(cid,wid){
  if(!confMatrix[cid])confMatrix[cid]={};
  confMatrix[cid][wid]=Math.min(20,(confMatrix[cid][wid]||0)+1);saveConf();
}
function getDistractors(target){
  const mat=confMatrix[target.id]||{},sim=simMatrix[target.id]||{};
  const cands=words.filter(w=>w.id!==target.id&&(sim[w.id]||0)<SIM_DUP);
  return cands.map(w=>({word:w,score:(sim[w.id]||0)*5+(mat[w.id]||0)*10+Math.random()*3}))
    .sort((a,b)=>b.score-a.score).slice(0,3).map(s=>s.word);
}
function nextQuiz(){
  if(quizIdx>=quizQueue.length){quizQueue=buildWQ(words);quizIdx=0;showToast('ë¬¸ì œ ëª©ë¡ì„ ë‹¤ì‹œ ë•ë‹ˆë‹¤! ğŸ”');}
  quizQ++;
  document.getElementById('quiz-progress').textContent=`${quizQ}ë²ˆì§¸`;
  document.getElementById('quiz-score').textContent=quizS;
  quizWord=quizQueue[quizIdx++];
  document.getElementById('quiz-word-en').textContent=quizWord.en;
  renderQuizOpts(getDistractors(quizWord));
}
function renderQuizOpts(distractors){
  const con=document.getElementById('quiz-options');con.innerHTML='';
  const sim=simMatrix[quizWord.id]||{};
  const dupes=words.filter(w=>w.id!==quizWord.id&&(sim[w.id]||0)>=SIM_DUP);
  
  if(dupes.length){
    const d=document.createElement('div');
    // ê·¸ë¦¬ë“œ ì•ˆì—ì„œ ì „ì²´ ë„ˆë¹„ë¥¼ ì°¨ì§€í•˜ê²Œ ì„¤ì •
    d.className='col-span-full bg-amber-50 border border-amber-200 text-amber-700 text-sm font-semibold rounded-xl px-4 py-3 mb-2 flex gap-2 items-center';
    d.innerHTML=`<span class="text-xl">âš ï¸</span><span>${dupes.map(d=>`"${d.en}"`).join(', ')}ì™€(ê³¼) ì˜ë¯¸ê°€ ì¤‘ë³µë˜ì–´ ì„ íƒì§€ì—ì„œ ì œì™¸í–ˆìŠµë‹ˆë‹¤.</span>`;
    con.appendChild(d);
  }
  
  const hasSem=distractors.some(w=>(sim[w.id]||0)>=SIM_CONF);
  const hasLrn=Object.keys(confMatrix[quizWord.id]||{}).length>0;
  if(hasSem||hasLrn){
    const b=document.createElement('div');
    b.className='col-span-full text-right text-sm font-semibold mb-2 pr-2 '+(hasLrn&&hasSem?'text-purple-500':hasLrn?'text-emerald-500':'text-indigo-500');
    b.textContent=hasLrn&&hasSem?'ğŸ§  ì˜ë¯¸ ìœ ì‚¬ë„ + ê³¼ê±° ì˜¤ë‹µ í˜¼ë™ ë§ì¶¤ ì¶œì œ':hasLrn?'ğŸ§  ê³¼ê±° ìì£¼ í—·ê°ˆë¦° ë‹¨ì–´ ìœ„ì£¼ ì¶œì œ':'ğŸ” AI ì˜ë¯¸ ìœ ì‚¬ë„ ê¸°ë°˜ ë‚œì´ë„ ìƒí–¥';
    con.appendChild(b);
  }
  
  shuffle([{word:quizWord,ok:true},...distractors.map(w=>({word:w,ok:false}))]).forEach(opt=>{
    const btn=document.createElement('button');
    btn.className='game-btn w-full bg-white border-2 border-gray-200 text-gray-700 font-bold py-6 rounded-2xl text-xl hover:border-indigo-400 hover:bg-indigo-50 hover:text-indigo-700 shadow-sm transition-all';
    btn.textContent=opt.word.ko;
    btn.dataset.correct=opt.ok?'true':'false';
    btn.dataset.wid=opt.word.id;
    btn.onclick=()=>selectQuiz(btn,opt.ok,opt.word.id);
    con.appendChild(btn);
  });
}
function selectQuiz(btn,ok,selId){
  document.querySelectorAll('#quiz-options button').forEach(b=>b.disabled=true);
  if(ok){quizS++;btn.classList.add('correct-answer');}
  else{
    btn.classList.add('wrong-answer');
    document.querySelectorAll('#quiz-options button').forEach(b=>{
      if(b.dataset.correct==='true'){
        b.classList.add('correct-answer');
        b.classList.remove('border-gray-200','text-gray-700');
      }
    });
    const i=words.findIndex(w=>w.id===quizWord.id);
    if(i!==-1){words[i].wrongCount=(words[i].wrongCount||0)+1;saveData();}
    updateConf(quizWord.id,selId);
  }
  document.getElementById('quiz-score').textContent=quizS;
  setTimeout(()=>{
    const wb=document.getElementById('quiz-word-en').parentElement,ob=document.getElementById('quiz-options');
    wb.style.opacity='0';ob.style.opacity='0';
    setTimeout(()=>{nextQuiz();wb.style.opacity='1';ob.style.opacity='1';},200);
  },1200);
}
function showQuizResult(){
  document.getElementById('quiz-active').classList.add('hidden');
  document.getElementById('quiz-result').classList.remove('hidden');
  const total=Math.max(0,quizQ-1);
  document.getElementById('quiz-final-score').textContent=quizS;
  document.getElementById('quiz-total-score').textContent=total;
  const r=total===0?0:quizS/total;
  const[em,fb]=r===1?['ğŸ†','í¼í™íŠ¸! í—·ê°ˆë¦¬ëŠ” ì„ ì§€ë“¤ë„ ì™„ë²½íˆ ë°©ì–´í–ˆì–´ìš”!']:r>=0.7?['ğŸ‘','í›Œë¥­í•©ë‹ˆë‹¤! ì¢‹ì€ ì„±ì ì´ì—ìš”.']:total===0?['ğŸ¤”','ë¬¸ì œë¥¼ í’€ì§€ ì•Šìœ¼ì…¨ì–´ìš”.']:['ğŸ’ª','ì„ ì§€ê°€ ë§ì´ í—·ê°ˆë ¸ë‚˜ìš”? í‹€ë¦° ë‹¨ì–´ë¥¼ ë³µìŠµí•´ë³´ì„¸ìš”!'];
  document.getElementById('quiz-result-emoji').textContent=em;
  document.getElementById('quiz-feedback').textContent=fb;
  renderWords();
}

// ================================================================
// ë¹ˆì¹¸ ë„£ê¸° íƒ­
// ================================================================
function resetFillView(){
  fillQuestions=[];fillIdx=0;fillScore=0;fillCurrentQ=null;
  document.getElementById('fill-intro').classList.remove('hidden');
  document.getElementById('fill-loading').classList.add('hidden');
  document.getElementById('fill-active').classList.add('hidden');
  document.getElementById('fill-result').classList.add('hidden');
}

async function startFill(n=10){
  if(words.length<4){showToast('ë¬¸ì œë¥¼ ì¶œì œí•˜ê¸° ìœ„í•´ ë‹¨ì–´ê°€ 4ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!','error');return;}
  fillTotal=n;fillScore=0;fillIdx=0;fillQuestions=[];
  document.getElementById('fill-intro').classList.add('hidden');
  document.getElementById('fill-loading').classList.remove('hidden');
  document.getElementById('fill-loading').classList.add('flex');

  // ì¶œì œí•  ë‹¨ì–´ ì„ íƒ: wrongCount ê°€ì¤‘ì¹˜ ì ìš©, ìµœëŒ€ nê°œ
  const pool=buildWQ(words).slice(0,n*2); // ì—¬ìœ ìˆê²Œ í›„ë³´ í™•ë³´
  const selected=[];const seen=new Set();
  for(const w of pool){if(!seen.has(w.id)){seen.add(w.id);selected.push(w);}if(selected.length>=n)break;}
  // ë¶€ì¡±í•˜ë©´ ëœë¤ìœ¼ë¡œ ì±„ì›€
  if(selected.length<n){const rest=shuffle(words.filter(w=>!seen.has(w.id)));for(const w of rest){selected.push(w);if(selected.length>=n)break;}}

  // ê° ë‹¨ì–´ì— ëŒ€í•´ ì˜ˆë¬¸ fetch (ë³‘ë ¬, ìµœëŒ€ nê°œ)
  const results=await Promise.all(selected.map(w=>buildFillQuestion(w)));
  fillQuestions=results.filter(Boolean).slice(0,n);

  document.getElementById('fill-loading').classList.add('hidden');
  document.getElementById('fill-loading').classList.remove('flex');

  if(fillQuestions.length<2){showToast('API ì„œë²„ì—ì„œ ì˜ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.','error');resetFillView();return;}
  fillTotal=fillQuestions.length;
  document.getElementById('fill-active').classList.remove('hidden');
  showFillQuestion();
}

async function buildFillQuestion(targetWord){
  try{
    document.getElementById('fill-loading-word').textContent=`"${targetWord.en}"ì˜ ì›ì–´ë¯¼ ì˜ˆë¬¸ì„ ì°¾ëŠ” ì¤‘...`;
    
    let sentence=null;

    // 1) Dictionary APIì—ì„œ ì˜ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
    const dictData=await fetchDict(targetWord.en);
    const examples=[];
    if(dictData){
      dictData.meanings?.forEach(m=>{
        m.definitions?.forEach(d=>{if(d.example)examples.push(d.example);});
      });
    }
    if(examples.length>0){
      sentence=examples[Math.floor(Math.random()*examples.length)];
    }

    // 2) ì˜ˆë¬¸ì´ ì—†ìœ¼ë©´ Datamuse ì‚¬ìš©
    if(!sentence){
      const res=await fetch(`https://api.datamuse.com/words?sp=${encodeURIComponent(targetWord.en)}&md=d&max=1`);
      const data=await res.json();
      if(data[0]?.defs?.[0]){
        const def=data[0].defs[0].replace(/^\w+\t/,'');
        sentence=`She decided to ${targetWord.en} her goals. "${def}"`;
      }
    }

    // 3) ê·¸ë˜ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ í…œí”Œë¦¿
    if(!sentence){
      const templates=[
        `The student tried to ${targetWord.en} in every possible way.`,
        `It is important to understand what it means to ${targetWord.en}.`,
        `They were amazed by how well he could ${targetWord.en}.`,
      ];
      sentence=templates[Math.floor(Math.random()*templates.length)];
    }

    const regex=new RegExp(`\\b${targetWord.en}\\b`,'gi');
    if(!regex.test(sentence)){
      sentence=`To ${targetWord.en} means to achieve or complete something successfully. Can you use "${targetWord.en}" in a sentence?`;
    }

    const blankSentence=sentence.replace(new RegExp(`\\b${targetWord.en}\\b`,'gi'),'___');
    const fullSentence=sentence;

    const sim=simMatrix[targetWord.id]||{};
    const distractorWords=words
      .filter(w=>w.id!==targetWord.id&&(sim[w.id]||0)<SIM_DUP)
      .map(w=>({word:w,score:(sim[w.id]||0)*3+Math.random()*5}))
      .sort((a,b)=>b.score-a.score)
      .slice(0,3)
      .map(s=>s.word);

    while(distractorWords.length<3){
      const rand=words.find(w=>w.id!==targetWord.id&&!distractorWords.some(d=>d.id===w.id));
      if(rand)distractorWords.push(rand);else break;
    }

    return {
      word:targetWord,
      blank:blankSentence,
      full:fullSentence,
      options:shuffle([targetWord,...distractorWords.slice(0,3)]),
    };
  }catch(e){return null;}
}

function showFillQuestion(){
  if(fillIdx>=fillQuestions.length){showFillResult();return;}
  fillCurrentQ=fillQuestions[fillIdx];
  const q=fillCurrentQ;

  const pct=Math.round((fillIdx/fillTotal)*100);
  document.getElementById('fill-progress-bar').style.width=pct+'%';
  document.getElementById('fill-progress-text').textContent=`${fillIdx+1} / ${fillTotal}`;
  document.getElementById('fill-score').textContent=fillScore;

  const sentEl=document.getElementById('fill-sentence');
  sentEl.innerHTML=q.blank.replace(/___/g,'<span class="fill-blank px-6 mx-1">ã€€ã€€</span>');

  const fb=document.getElementById('fill-feedback');fb.classList.add('hidden');
  document.getElementById('fill-next-btn').classList.add('hidden');

  const opts=document.getElementById('fill-options');
  opts.innerHTML='';
  q.options.forEach(w=>{
    const btn=document.createElement('button');
    btn.className='fill-opt bg-white border-2 border-gray-200 rounded-2xl p-5 text-xl font-bold text-gray-700 text-center active:scale-95 transition-all shadow-sm';
    btn.textContent=w.en;
    btn.onclick=()=>selectFill(btn,w.id===q.word.id,w,q);
    opts.appendChild(btn);
  });
}

function selectFill(btn,isCorrect,selectedWord,q){
  document.getElementById('fill-options').querySelectorAll('button').forEach(b=>b.disabled=true);

  if(isCorrect){
    btn.classList.add('correct');
    fillScore++;
  } else {
    btn.classList.add('wrong');
    document.getElementById('fill-options').querySelectorAll('button').forEach(b=>{
      if(b.textContent===q.word.en)b.classList.add('correct');
    });
  }

  const sentEl=document.getElementById('fill-sentence');
  sentEl.innerHTML=q.blank.replace(/___/g,`<span class="fill-blank px-4 mx-1 ${isCorrect?'text-emerald-600 border-emerald-500':'text-rose-500 border-rose-500'}">${q.word.en}</span>`);

  const fb=document.getElementById('fill-feedback');
  fb.classList.remove('hidden');
  if(isCorrect){
    fb.className='rounded-2xl p-6 border-2 bg-emerald-50 border-emerald-200 fade-in';
    document.getElementById('fill-feedback-text').className='font-bold text-lg mb-1 text-emerald-700';
    document.getElementById('fill-feedback-text').textContent='âœ… ì •í™•íˆ ë§íˆì…¨ìŠµë‹ˆë‹¤!';
  } else {
    fb.className='rounded-2xl p-6 border-2 bg-rose-50 border-rose-200 fade-in';
    document.getElementById('fill-feedback-text').className='font-bold text-lg mb-1 text-rose-700';
    document.getElementById('fill-feedback-text').textContent=`âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ë¬¸ë§¥ìƒ ì•Œë§ì€ ì •ë‹µì€ "${q.word.en}" ì…ë‹ˆë‹¤.`;
    const i=words.findIndex(w=>w.id===q.word.id);if(i!==-1){words[i].wrongCount=(words[i].wrongCount||0)+1;saveData();}
  }
  document.getElementById('fill-full-sentence').textContent=q.full;

  document.getElementById('fill-score').textContent=fillScore;
  document.getElementById('fill-next-btn').classList.remove('hidden');
}

function nextFillQuestion(){
  fillIdx++;
  if(fillIdx>=fillQuestions.length)showFillResult();
  else showFillQuestion();
}

function showFillResult(){
  document.getElementById('fill-active').classList.add('hidden');
  document.getElementById('fill-result').classList.remove('hidden');
  document.getElementById('fill-final-score').textContent=fillScore;
  document.getElementById('fill-final-total').textContent=fillTotal;
  const r=fillTotal===0?0:fillScore/fillTotal;
  const[em,msg]=r===1?['ğŸ†','í¼í™íŠ¸! ì™„ë²½í•˜ê²Œ ë¬¸ë§¥ì„ ì´í•´í•˜ê³  ìˆì–´ìš”!']:r>=0.8?['ğŸ‰','í›Œë¥­í•´ìš”! ì¡°ê¸ˆë§Œ ë” í•˜ë©´ ì™„ë²½í•©ë‹ˆë‹¤.']:r>=0.6?['ğŸ‘','ì˜í–ˆì–´ìš”! ì˜ˆë¬¸ì„ í†µí•´ ë‹¨ì–´ì˜ ì“°ì„ìƒˆë¥¼ ë” ìµí˜€ë³´ì„¸ìš”.']:r>=0.4?['ğŸ’ª','ì‹¤ì œ ì˜ˆë¬¸ì´ë¼ ì¡°ê¸ˆ ê¹Œë‹¤ë¡œìš¸ ìˆ˜ ìˆì–´ìš”. ê³„ì† ë„ì „í•˜ì„¸ìš”!']:['ğŸ“š','ë‹¨ì–´ì˜ ëœ»ë¿ë§Œ ì•„ë‹ˆë¼ ì˜ˆë¬¸ë„ ê¼¼ê¼¼íˆ ê³µë¶€í•´ë³´ì„¸ìš”!'];
  document.getElementById('fill-result-emoji').textContent=em;
  document.getElementById('fill-result-msg').textContent=msg;
  renderWords();
}

// ================================================================
// ë¶„ì„ íƒ­
// ================================================================
function openAnalysis(id){const w=words.find(x=>x.id===id);if(!w)return;switchTab('analysis');setTimeout(()=>selectAnalysisWord(w),60);}
function filterAnalysisWords(){renderAnalysisDD(document.getElementById('analysis-search').value.toLowerCase());}
function showAnalysisDropdown(){renderAnalysisDD(document.getElementById('analysis-search').value.toLowerCase());}
function renderAnalysisDD(q=''){
  const dd=document.getElementById('analysis-dropdown');
  const filtered=words.filter(w=>w.en.toLowerCase().includes(q)||w.ko.includes(q));
  if(!filtered.length){dd.classList.add('hidden');return;}
  dd.innerHTML=filtered.map(w=>`<button class="w-full text-left px-5 py-4 hover:bg-indigo-50 flex justify-between gap-4 transition-colors" onclick="selectAnalysisWord(words.find(x=>x.id===${w.id}))"><span class="font-bold text-gray-800 text-lg">${w.en}</span><span class="text-sm text-gray-500 truncate">${w.ko}</span></button>`).join('<div class="border-t border-gray-100 mx-3"></div>');
  dd.classList.remove('hidden');
}
function selectAnalysisWord(w){
  if(!w)return;
  analysisWord=w;
  document.getElementById('analysis-search').value=''; // ê²€ìƒ‰ì–´ ì§€ìš°ê¸° (ì„ íƒë˜ì—ˆìœ¼ë¯€ë¡œ)
  document.getElementById('analysis-dropdown').classList.add('hidden');
  document.getElementById('analysis-word-en-display').textContent=w.en;
  document.getElementById('analysis-word-ko-display').textContent=w.ko;
  document.getElementById('analysis-selected-word').classList.remove('hidden');
  runAnalysis(w);
}
function clearAnalysisWord(){
  analysisWord=null;
  document.getElementById('analysis-search').value='';
  document.getElementById('analysis-selected-word').classList.add('hidden');
  document.getElementById('analysis-result').classList.add('hidden');
  document.getElementById('analysis-loading').classList.add('hidden');
  document.getElementById('analysis-placeholder').classList.remove('hidden');
}

async function runAnalysis(word){
  document.getElementById('analysis-placeholder').classList.add('hidden');
  document.getElementById('analysis-result').classList.add('hidden');
  document.getElementById('analysis-loading').classList.remove('hidden');

  const[dictData,syns,ants,rels,jjas,jjbs]=await Promise.all([
    fetchDict(word.en),
    fetchDatamuse('ml',word.en,14),
    fetchDatamuse('rel_ant',word.en,8),
    fetchDatamuse('rel_trg',word.en,12),
    fetchDatamuse('rel_jja',word.en,8),
    fetchDatamuse('rel_jjb',word.en,8),
  ]);

  document.getElementById('analysis-loading').classList.add('hidden');
  document.getElementById('analysis-result').classList.remove('hidden');

  // Dictionary APIì—ì„œ ì¶”ê°€ë¡œ ì¶”ì¶œí•  ìœ ì˜ì–´, ë°˜ì˜ì–´, í’ˆì‚¬ ëª©ë¡
  let dictSynonyms = [];
  let dictAntonyms = [];

  // â‘  ê¸°ë³¸ ì •ë³´
  document.getElementById('ar-word').textContent=word.en;
  const examplesEl=document.getElementById('ar-examples');
  examplesEl.innerHTML='';

  if(dictData){
    const ph=dictData.phonetics?.find(p=>p.text)?.text||'';
    document.getElementById('ar-phonetic').textContent=ph;
    audioUrl=dictData.phonetics?.find(p=>p.audio?.startsWith('http'))?.audio||null;
    const aBtn=document.getElementById('ar-audio-btn');
    if(audioUrl){aBtn.classList.remove('hidden');aBtn.onclick=()=>new Audio(audioUrl).play();}
    else aBtn.classList.add('hidden');

    // í’ˆì‚¬ (ë‹¨ì–´ê°€ ì†í•œ ëª¨ë“  í’ˆì‚¬ ì·¨í•©)
    const posSet = new Set();
    dictData.meanings?.forEach(m => {
      if(m.partOfSpeech) posSet.add(m.partOfSpeech);
      if(m.synonyms) dictSynonyms.push(...m.synonyms);
      if(m.antonyms) dictAntonyms.push(...m.antonyms);
    });
    
    const posString = Array.from(posSet).join(', ');
    const posEl=document.getElementById('ar-partOfSpeech');
    posEl.textContent=posString;
    posEl.style.display=posString?'':'none';

    // ì •ì˜ (ê°€ì¥ ì²« ë²ˆì§¸ ëŒ€í‘œ ì •ì˜ ì‚¬ìš©)
    const def=dictData.meanings?.[0]?.definitions?.[0];
    document.getElementById('ar-definition').textContent=def?.definition||'í•´ë‹¹ ë‹¨ì–´ì˜ ì˜ì˜ì‚¬ì „ ì •ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

    // ì˜ˆë¬¸ ìµœëŒ€ 3ê°œ
    const allExamples=[];
    dictData.meanings?.forEach(m=>{
      m.definitions?.forEach(d=>{if(d.example&&allExamples.length<3)allExamples.push({example:d.example,partOfSpeech:m.partOfSpeech});});
    });
    if(allExamples.length){
      examplesEl.innerHTML=allExamples.map((ex,i)=>`
        <div class="flex gap-4 items-start bg-gray-50 p-4 rounded-xl border border-gray-100">
          <span class="flex-shrink-0 w-6 h-6 bg-indigo-100 text-indigo-700 text-xs font-black rounded-full flex items-center justify-center mt-0.5">${i+1}</span>
          <p class="text-base text-gray-700 italic leading-relaxed">"${ex.example}"</p>
        </div>`).join('');
    } else {
      examplesEl.innerHTML='<p class="text-sm text-gray-400 italic bg-gray-50 p-4 rounded-xl">ì´ ë‹¨ì–´ê°€ í¬í•¨ëœ ì˜ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
  } else {
    document.getElementById('ar-phonetic').textContent='';
    document.getElementById('ar-partOfSpeech').textContent='';
    document.getElementById('ar-partOfSpeech').style.display='none';
    document.getElementById('ar-definition').textContent='ì‚¬ì „ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”)';
    examplesEl.innerHTML='<p class="text-sm text-gray-400">ì˜ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    document.getElementById('ar-audio-btn').classList.add('hidden');
  }

  // â‘¡ ë‹¨ì–´ì¥ ë‚´ ìœ ì‚¬ë„
  const simRow=simMatrix[word.id]||{};
  const internals=words.filter(w=>w.id!==word.id).map(w=>({word:w,sim:simRow[w.id]||0}))
    .filter(x=>x.sim>8).sort((a,b)=>b.sim-a.sim).slice(0,7);
  const intEl=document.getElementById('ar-internal-list');
  if(internals.length){
    intEl.innerHTML=internals.map(({word:w,sim})=>{
      const pct=Math.round(sim);
      const bar=pct>=SIM_DUP?'bg-amber-400':pct>=SIM_CONF?'bg-violet-400':'bg-indigo-300';
      const lbl=pct>=SIM_DUP?'<span class="text-[10px] bg-amber-100 text-amber-600 font-bold px-2 py-0.5 rounded-full whitespace-nowrap">âš ï¸ ì¤‘ë³µ</span>':
                pct>=SIM_CONF?'<span class="text-[10px] bg-violet-100 text-violet-600 font-bold px-2 py-0.5 rounded-full whitespace-nowrap">í˜¼ë™ ì£¼ì˜</span>':'';
      return `<div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-wrap mb-1"><span class="font-bold text-base text-gray-800">${w.en}</span><span class="text-xs text-gray-500 truncate">${w.ko}</span>${lbl}</div>
        <div class="flex items-center gap-3"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="${bar} h-2 rounded-full transition-all duration-700" style="width:${pct}%"></div></div><span class="text-xs text-gray-400 font-mono w-8 text-right font-bold">${pct}%</span></div>
      </div></div>`;
    }).join('');
  } else intEl.innerHTML='<div class="flex flex-col items-center justify-center h-full text-center p-6"><span class="text-3xl mb-2">ğŸ¤·â€â™‚ï¸</span><p class="text-sm text-gray-400">ë‹¨ì–´ì¥ ë‚´ì— ì˜ë¯¸ê°€ ë¹„ìŠ·í•œ ë‹¨ì–´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p></div>';

  // â‘¢â‘£â‘¤â‘¥ ì¹© (Datamuse ê²°ê³¼ì™€ Dictionary ê²°ê³¼ë¥¼ ë³‘í•©)
  const existingEn=new Set(words.map(w=>w.en.toLowerCase()));
  const newCands=new Set();

  function renderChips(elId,items,cls){
    const el=document.getElementById(elId);
    if(!items.length){el.innerHTML='<span class="text-sm text-gray-400">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</span>';return;}
    el.innerHTML='';
    items.forEach(item=>{
      const inBook=existingEn.has(item.word.toLowerCase());
      if(!inBook)newCands.add(item.word);

      const span=document.createElement('span');
      span.className='chip '+cls;
      span.onclick=()=>onChipClick(item.word);

      const inBookWord=words.find(w=>w.en.toLowerCase()===item.word.toLowerCase());
      const knownKo=inBookWord?inBookWord.ko:null;

      const wordLabel=document.createTextNode((inBook?'âœ… ':'')+item.word);
      span.appendChild(wordLabel);

      const tooltip=document.createElement('span');
      tooltip.className='chip-tooltip'+(knownKo?'':' loading');
      tooltip.textContent=knownKo||'ëœ» ë²ˆì—­ ì¤‘...';
      span.appendChild(tooltip);

      if(!knownKo){
        let fetched=false;
        span.addEventListener('mouseenter',async()=>{
          if(fetched)return;
          fetched=true;
          try{
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q=${encodeURIComponent(item.word)}`;
            const r = await fetch(url);
            const data = await r.json();
            const koDef = data[0][0][0]; 
            
            tooltip.textContent = koDef || 'ëœ» ì •ë³´ ì—†ìŒ';
            tooltip.classList.remove('loading');
          }catch{tooltip.textContent='ë²ˆì—­ ì‹¤íŒ¨';}
        });
      }
      el.appendChild(span);
    });
  }

  // ì¤‘ë³µ ì œê±° ë° Datamuse/Dictionary í†µí•©
  const mergedSynonyms = new Map();
  syns.forEach(s => mergedSynonyms.set(s.word.toLowerCase(), s));
  dictSynonyms.forEach(s => {
    if(!mergedSynonyms.has(s.toLowerCase())) mergedSynonyms.set(s.toLowerCase(), {word: s});
  });
  const finalSynonyms = Array.from(mergedSynonyms.values()).slice(0, 14);

  const mergedAntonyms = new Map();
  ants.forEach(a => mergedAntonyms.set(a.word.toLowerCase(), a));
  dictAntonyms.forEach(a => {
    if(!mergedAntonyms.has(a.toLowerCase())) mergedAntonyms.set(a.toLowerCase(), {word: a});
  });
  const finalAntonyms = Array.from(mergedAntonyms.values()).slice(0, 14);

  renderChips('ar-synonyms', finalSynonyms, 'chip-syn');
  renderChips('ar-antonyms', finalAntonyms, 'chip-ant');
  renderChips('ar-related', rels, 'chip-rel');
  renderChips('ar-collocations', [...jjas,...jjbs].slice(0,12), 'chip-freq');

  // â‘¦ ì¶”ì²œ
  const recEl=document.getElementById('ar-recommendations');
  const recs=[...newCands].slice(0,18);
  recEl.innerHTML=recs.length?recs.map(w=>`<button class="chip chip-new shadow-sm border border-blue-100" onclick="quickAdd('${w.replace(/'/g,"\\'")}')">+ ${w}</button>`).join(''):'<span class="text-sm text-gray-400">ì¶”ì²œí•  ìƒˆ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';

  // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ (ì»¨í…Œì´ë„ˆ ìš”ì†Œ ì°¾ì•„ì„œ ì²˜ë¦¬)
  const scrollContainer = document.getElementById('analysis-result').parentElement;
  if (scrollContainer) scrollContainer.scrollTop = 0;
}

function onChipClick(en){
  const found=words.find(w=>w.en.toLowerCase()===en.toLowerCase());
  if(found)selectAnalysisWord(found);else showToast(`"${en}" ë‹¨ì–´ì¥ì— ì—†ëŠ” ë‹¨ì–´ì…ë‹ˆë‹¤. ì•„ë˜ [ì¶”ì²œ ë‹¨ì–´]ì—ì„œ ëˆŒëŸ¬ ë°”ë¡œ ì¶”ê°€í•´ë³´ì„¸ìš”!`);
}
function quickAdd(en){switchTab('manage');document.getElementById('input-en').value=en;document.getElementById('input-ko').focus();showToast(`"${en}" ì¶”ê°€ ëª¨ë“œë¡œ ì´ë™! í•œêµ­ì–´ ëœ»ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);}

// ================================================================
// ë¬´ë£Œ API
// ================================================================
async function fetchDict(word){
  try{const r=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);if(!r.ok)return null;const d=await r.json();return Array.isArray(d)?d[0]:null;}catch{return null;}
}
async function fetchDatamuse(rel,word,max=10){
  try{
    const param=rel==='ml'?`ml=${encodeURIComponent(word)}`:`${rel}=${encodeURIComponent(word)}`;
    const r=await fetch(`https://api.datamuse.com/words?${param}&max=${max}`);
    if(!r.ok)return[];return await r.json();
  }catch{return[];}
}
</script>
</body>
</html>